"use strict";(self.webpackChunkNJS_Lab=self.webpackChunkNJS_Lab||[]).push([[21224],{21224:(t,e,i)=>{i.r(e),i.d(e,{Solution:()=>m});class s{constructor(t){this.buffer=void 0,this.bufferLayout=void 0;const e=new Float32Array([0,0,.5,.5,0,0,-.5,-.5,0,1,0,.5,-.5,1,1]),i=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,s={size:e.byteLength,usage:i,mappedAtCreation:!0};this.buffer=t.createBuffer(s),new Float32Array(this.buffer.getMappedRange()).set(e),this.buffer.unmap(),this.bufferLayout={arrayStride:20,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}class a{constructor(t){this.buffer=void 0,this.bufferLayout=void 0;const e=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,.5,.5,0,1,1,-.5,.5,0,0,1,-.5,-.5,0,0,0]),i=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,s={size:e.byteLength,usage:i,mappedAtCreation:!0};this.buffer=t.createBuffer(s),new Float32Array(this.buffer.getMappedRange()).set(e),this.buffer.unmap(),this.bufferLayout={arrayStride:20,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var r=i(39880);class o{constructor(){this.texture=void 0,this.view=void 0,this.sampler=void 0,this.bindGroup=void 0}async initialize(t,e,i){console.log(e);const s=await fetch(e),a=await s.blob(),r=await createImageBitmap(a);await this.loadImageBitmap(t,r);this.view=this.texture.createView({format:"rgba8unorm",dimension:"2d",aspect:"all",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1});this.sampler=t.createSampler({addressModeU:"repeat",addressModeV:"repeat",magFilter:"linear",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1}),this.bindGroup=t.createBindGroup({layout:i,entries:[{binding:0,resource:this.view},{binding:1,resource:this.sampler}]})}async loadImageBitmap(t,e){const i={size:{width:e.width,height:e.height},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};this.texture=t.createTexture(i),t.queue.copyExternalImageToTexture({source:e},{texture:this.texture},i.size)}}let n;!function(t){t[t.TRIANGLE=0]="TRIANGLE",t[t.QUAD=1]="QUAD"}(n||(n={}));const h="\nstruct TransformData {\n    view: mat4x4<f32>,\n    projection: mat4x4<f32>,\n};\n\nstruct ObjectData {\n    model: array<mat4x4<f32>>,\n};\n\n@binding(0) @group(0) var<uniform> transformUBO: TransformData;\n@binding(1) @group(0) var<storage, read> objects: ObjectData;\n@binding(0) @group(1) var myTexture: texture_2d<f32>;\n@binding(1) @group(1) var mySampler: sampler;\n\nstruct Fragment {\n    @builtin(position) Position : vec4<f32>,\n    @location(0) TexCoord : vec2<f32>\n};\n\n@vertex\nfn vs_main(\n    @builtin(instance_index) ID: u32,\n    @location(0) vertexPostion: vec3<f32>, \n    @location(1) vertexTexCoord: vec2<f32>) -> Fragment {\n\n    var output : Fragment;\n    output.Position = transformUBO.projection * transformUBO.view * objects.model[ID] * vec4<f32>(vertexPostion, 1.0);\n    output.TexCoord = vertexTexCoord;\n\n    return output;\n}\n\n@fragment\nfn fs_main(@location(0) TexCoord : vec2<f32>) -> @location(0) vec4<f32> {\n    return textureSample(myTexture, mySampler, TexCoord);\n}\n";class u{constructor(t){this.canvas=void 0,this.adapter=void 0,this.device=void 0,this.context=void 0,this.format=void 0,this.uniformBuffer=void 0,this.pipeline=void 0,this.frameGroupLayout=void 0,this.materialGroupLayout=void 0,this.frameBindGroup=void 0,this.depthStencilState=void 0,this.depthStencilBuffer=void 0,this.depthStencilView=void 0,this.depthStencilAttachment=void 0,this.triangleMesh=void 0,this.quadMesh=void 0,this.triangleMaterial=void 0,this.quadMaterial=void 0,this.objectBuffer=void 0,this.canvas=t}async Initialize(){const t=await(async t=>{let e=new DOMParser,i=await fetch(t),s=await i.text(),a=await e.parseFromString(s,"text/xml");return console.log(s,a),s})("/njs-lab-public/shaders/shaders.wgsl");console.log(t),await this.setupDevice(),await this.makeBindGroupLayouts(),await this.createAssets(),await this.makeDepthBufferResources(),await this.makePipeline(),await this.makeBindGroup()}async setupDevice(){var t,e;this.adapter=await(null===(t=navigator.gpu)||void 0===t?void 0:t.requestAdapter()),this.device=await(null===(e=this.adapter)||void 0===e?void 0:e.requestDevice()),this.context=this.canvas.getContext("webgpu"),this.format="bgra8unorm",this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}async makeDepthBufferResources(){this.depthStencilState={format:"depth24plus-stencil8",depthWriteEnabled:!0,depthCompare:"less-equal"};const t={size:{width:this.canvas.width,height:this.canvas.height,depthOrArrayLayers:1},format:"depth24plus-stencil8",usage:GPUTextureUsage.RENDER_ATTACHMENT};this.depthStencilBuffer=this.device.createTexture(t);this.depthStencilView=this.depthStencilBuffer.createView({format:"depth24plus-stencil8",dimension:"2d",aspect:"all"}),this.depthStencilAttachment={view:this.depthStencilView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store",stencilLoadOp:"clear",stencilStoreOp:"discard"}}async makeBindGroupLayouts(){this.frameGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage",hasDynamicOffset:!1}}]}),this.materialGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]})}async makePipeline(){const t=this.device.createPipelineLayout({bindGroupLayouts:[this.frameGroupLayout,this.materialGroupLayout]});this.pipeline=this.device.createRenderPipeline({vertex:{module:this.device.createShaderModule({code:h}),entryPoint:"vs_main",buffers:[this.triangleMesh.bufferLayout]},fragment:{module:this.device.createShaderModule({code:h}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-list"},layout:t,depthStencil:this.depthStencilState})}async createAssets(){this.triangleMesh=new s(this.device),this.quadMesh=new a(this.device),this.triangleMaterial=new o,this.quadMaterial=new o,this.uniformBuffer=this.device.createBuffer({size:128,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const t={size:65536,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST};this.objectBuffer=this.device.createBuffer(t),await this.triangleMaterial.initialize(this.device,"/njs-lab-public/img/profile0.jpg",this.materialGroupLayout),await this.quadMaterial.initialize(this.device,"/njs-lab-public/img/profile0.jpg",this.materialGroupLayout)}async makeBindGroup(){this.frameBindGroup=this.device.createBindGroup({layout:this.frameGroupLayout,entries:[{binding:0,resource:{buffer:this.uniformBuffer}},{binding:1,resource:{buffer:this.objectBuffer}}]})}async render(t){if(!this.device||!this.pipeline)return;const e=r.Ue();r.G3(e,Math.PI/4,800/600,.1,10);const i=t.view_transform;this.device.queue.writeBuffer(this.objectBuffer,0,t.model_transforms,0,t.model_transforms.length),this.device.queue.writeBuffer(this.uniformBuffer,0,i),this.device.queue.writeBuffer(this.uniformBuffer,64,e);const s=this.device.createCommandEncoder(),a=this.context.getCurrentTexture().createView(),o=s.beginRenderPass({colorAttachments:[{view:a,clearValue:{r:.5,g:0,b:.25,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:this.depthStencilAttachment});o.setPipeline(this.pipeline),o.setBindGroup(0,this.frameBindGroup);var h=0;o.setVertexBuffer(0,this.triangleMesh.buffer),o.setBindGroup(1,this.triangleMaterial.bindGroup),o.draw(3,t.object_counts[n.TRIANGLE],0,h),h+=t.object_counts[n.TRIANGLE],o.setVertexBuffer(0,this.quadMesh.buffer),o.setBindGroup(1,this.quadMaterial.bindGroup),o.draw(6,t.object_counts[n.QUAD],0,h),h+=t.object_counts[n.QUAD],o.end(),this.device.queue.submit([s.finish()])}}var d=i(88679);function c(t){return t*Math.PI/180}class l{constructor(t,e){this.position=void 0,this.eulers=void 0,this.model=void 0,this.position=t,this.eulers=d.Ue(),this.eulers[2]=e}update(){this.model=r.Ue(),r.Iu(this.model,this.model,this.position),r.jI(this.model,this.model,c(this.eulers[2]))}get_model(){return this.model}}class f{constructor(t,e,i){this.position=void 0,this.eulers=void 0,this.view=void 0,this.forwards=void 0,this.right=void 0,this.up=void 0,this.position=t,this.eulers=[0,i,e],this.forwards=d.Ue(),this.right=d.Ue(),this.up=d.Ue()}update(){this.forwards=[Math.cos(c(this.eulers[2]))*Math.cos(c(this.eulers[1])),Math.sin(c(this.eulers[2]))*Math.cos(c(this.eulers[1])),Math.sin(c(this.eulers[1]))],d.kC(this.right,this.forwards,[0,0,1]),d.kC(this.up,this.right,this.forwards);var t=d.Ue();d.IH(t,this.position,this.forwards),this.view=r.Ue(),r.zB(this.view,this.position,t,this.up)}get_view(){return this.view}}class p{constructor(){this.triangles=void 0,this.quads=void 0,this.player=void 0,this.object_data=void 0,this.triangle_count=void 0,this.quad_count=void 0,this.triangles=[],this.quads=[],this.object_data=new Float32Array(16384),this.triangle_count=0,this.quad_count=0,this.make_triangles(),this.player=new f([-2,0,.5],0,0)}make_triangles(){for(var t=0,e=0;e<1;e++){this.triangles.push(new l([2,e,0],0));for(var i=r.Ue(),s=0;s<16;s++)this.object_data[16*t+s]=i.at(s);t++,this.triangle_count++}}update(){var t=0;this.triangles.forEach((e=>{e.update();for(var i=e.get_model(),s=0;s<16;s++)this.object_data[16*t+s]=i.at(s);t++})),this.quads.forEach((e=>{e.update();for(var i=e.get_model(),s=0;s<16;s++)this.object_data[16*t+s]=i.at(s);t++})),this.player.update()}get_player(){return this.player}get_renderables(){return{view_transform:this.player.get_view(),model_transforms:this.object_data,object_counts:{[n.TRIANGLE]:this.triangle_count,[n.QUAD]:this.quad_count}}}spin_player(t,e){this.player.eulers[2]-=t,this.player.eulers[2]%=360,this.player.eulers[1]=Math.min(89,Math.max(-89,this.player.eulers[1]-e))}move_player(t,e){d.od(this.player.position,this.player.position,this.player.forwards,t),d.od(this.player.position,this.player.position,this.player.right,e)}}class v{constructor(t){this.canvas=void 0,this.renderer=void 0,this.scene=void 0,this.keyLabel=void 0,this.mouseXLabel=void 0,this.mouseYLabel=void 0,this.forwards_amount=void 0,this.right_amount=void 0,this.run=()=>{this.scene.update(),this.scene.move_player(this.forwards_amount,this.right_amount),this.renderer.render(this.scene.get_renderables()),requestAnimationFrame(this.run)},this.canvas=t,this.renderer=new u(t),this.scene=new p,this.keyLabel=document.getElementById("key-label"),this.mouseXLabel=document.getElementById("mouse-x-label"),this.mouseYLabel=document.getElementById("mouse-y-label"),this.forwards_amount=0,this.right_amount=0,this.canvas.onclick=()=>{this.canvas.requestPointerLock()},this.canvas.addEventListener("mousemove",(t=>{this.handle_mouse_move(t)}))}async InitializeRenderer(){await this.renderer.Initialize()}handle_mouse_move(t){}}class m{constructor(t){this.divHost=void 0,this.canvas=void 0,this.ctx=void 0,this.device=void 0,this.format=void 0,this.size=void 0,this.pipelineObj=void 0,this.divHost=document.getElementById(t),this.canvas=document.createElement("canvas"),this.canvas.width=500,this.canvas.height=500,this.divHost.appendChild(this.canvas),this.initWebGPU()}async initWebGPU(){const t=new v(this.canvas);t.InitializeRenderer(),t.run()}run(){}destroy(){for(this.device.destroy();this.divHost.lastElementChild;)this.divHost.removeChild(this.divHost.lastElementChild)}}},88679:(t,e,i)=>{i.d(e,{$X:()=>n,EU:()=>b,Fv:()=>d,IH:()=>o,Ue:()=>a,VC:()=>p,al:()=>r,fF:()=>l,jI:()=>g,kC:()=>c,kK:()=>f,lM:()=>v,lu:()=>y,od:()=>h,tk:()=>u,uD:()=>m});var s=i(50907);function a(){var t=new s.WT(3);return s.WT!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function r(t,e,i){var a=new s.WT(3);return a[0]=t,a[1]=e,a[2]=i,a}function o(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t}function n(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function h(t,e,i,s){return t[0]=e[0]+i[0]*s,t[1]=e[1]+i[1]*s,t[2]=e[2]+i[2]*s,t}function u(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function d(t,e){var i=e[0],s=e[1],a=e[2],r=i*i+s*s+a*a;return r>0&&(r=1/Math.sqrt(r)),t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function c(t,e,i){var s=e[0],a=e[1],r=e[2],o=i[0],n=i[1],h=i[2];return t[0]=a*h-r*n,t[1]=r*o-s*h,t[2]=s*n-a*o,t}function l(t,e,i){var s=e[0],a=e[1],r=e[2],o=i[3]*s+i[7]*a+i[11]*r+i[15];return o=o||1,t[0]=(i[0]*s+i[4]*a+i[8]*r+i[12])/o,t[1]=(i[1]*s+i[5]*a+i[9]*r+i[13])/o,t[2]=(i[2]*s+i[6]*a+i[10]*r+i[14])/o,t}function f(t,e,i){var s=e[0],a=e[1],r=e[2];return t[0]=s*i[0]+a*i[3]+r*i[6],t[1]=s*i[1]+a*i[4]+r*i[7],t[2]=s*i[2]+a*i[5]+r*i[8],t}function p(t,e,i){var s=i[0],a=i[1],r=i[2],o=i[3],n=e[0],h=e[1],u=e[2],d=a*u-r*h,c=r*n-s*u,l=s*h-a*n,f=a*l-r*c,p=r*d-s*l,v=s*c-a*d,m=2*o;return d*=m,c*=m,l*=m,f*=2,p*=2,v*=2,t[0]=n+d+f,t[1]=h+c+p,t[2]=u+l+v,t}function v(t,e,i,s){var a=[],r=[];return a[0]=e[0]-i[0],a[1]=e[1]-i[1],a[2]=e[2]-i[2],r[0]=a[0],r[1]=a[1]*Math.cos(s)-a[2]*Math.sin(s),r[2]=a[1]*Math.sin(s)+a[2]*Math.cos(s),t[0]=r[0]+i[0],t[1]=r[1]+i[1],t[2]=r[2]+i[2],t}function m(t,e,i,s){var a=[],r=[];return a[0]=e[0]-i[0],a[1]=e[1]-i[1],a[2]=e[2]-i[2],r[0]=a[2]*Math.sin(s)+a[0]*Math.cos(s),r[1]=a[1],r[2]=a[2]*Math.cos(s)-a[0]*Math.sin(s),t[0]=r[0]+i[0],t[1]=r[1]+i[1],t[2]=r[2]+i[2],t}function g(t,e,i,s){var a=[],r=[];return a[0]=e[0]-i[0],a[1]=e[1]-i[1],a[2]=e[2]-i[2],r[0]=a[0]*Math.cos(s)-a[1]*Math.sin(s),r[1]=a[0]*Math.sin(s)+a[1]*Math.cos(s),r[2]=a[2],t[0]=r[0]+i[0],t[1]=r[1]+i[1],t[2]=r[2]+i[2],t}function b(t,e){var i=t[0],s=t[1],a=t[2],r=e[0],o=e[1],n=e[2],h=Math.sqrt(i*i+s*s+a*a)*Math.sqrt(r*r+o*o+n*n),u=h&&function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(t,e)/h;return Math.acos(Math.min(Math.max(u,-1),1))}var y=n;!function(){var t=a()}()}}]);
//# sourceMappingURL=21224.9680a59e.chunk.js.map