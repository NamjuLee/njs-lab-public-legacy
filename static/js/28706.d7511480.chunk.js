"use strict";(self.webpackChunkNJS_Lab=self.webpackChunkNJS_Lab||[]).push([[28706],{28706:(e,t,o)=>{o.r(t),o.d(t,{AppUpscaler:()=>me,Solution:()=>fe});var n=o(31916);const i=e=>(e=>Array.isArray(e))(e)?e[0]:e,r=(e=>{let{scale:t,name:o,version:r,meta:{architecture:s,...a},path:c}=e;const l=c||"models/x".concat(t,"/model.json");if("rdn"===s)return{scale:t,modelType:"layers",_internals:{path:l,name:o,version:r},meta:{architecture:s,...a},inputRange:[0,255],outputRange:[0,255]};return{setup:e=>{const o=e.layers.Layer;class r extends o{constructor(){super({}),(0,n.Z)(this,"beta",void 0),this.beta=.2}call(t){return e.mul(i(t),this.beta)}}(0,n.Z)(r,"className","MultiplyBeta");[r,(r=>{class s extends o{constructor(){super({}),(0,n.Z)(this,"scale",r)}computeOutputShape(e){return[e[0],e[1],e[2],3]}call(t){return e.depthToSpace(i(t),this.scale,"NHWC")}}return(0,n.Z)(s,"className","PixelShuffle".concat(t,"x")),s})(t)].forEach((t=>{e.serialization.registerClass(t)}))},scale:t,modelType:"layers",_internals:{path:l,name:o,version:r},meta:{architecture:s,...a},inputRange:[0,1],outputRange:[0,1]}})({scale:2,name:"@upscalerjs/default-model",version:"1.0.0-beta.17",path:"models/model.json",meta:{C:1,D:2,G:4,G0:64,T:10,architecture:"rdn",patchSize:128,size:"slim",artifactReducing:!1,sharpening:!1,dataset:"div2k",modelFileName:"rdn-C1-D2-G4-G064-T10-x2-patchsize128-compress100-sharpen0-datadiv2k-vary_cFalse_best-val_loss_epoch494"}});var s,a=o(93613);!function(e){e.UNDEFINED="undefined",e.INVALID_MODEL_TYPE="invalidModelType",e.MISSING_PATH="missingPath"}(s||(s={}));const c=e=>!(!Boolean(e)||!Array.isArray(e)||4!==e.length)&&e.every((e=>null===e||"number"===typeof e)),l=e=>c(e)&&null!==e[1]&&null!==e[2]&&e[1]>0&&e[2]>0;function d(e){return function(t){try{return t.shape.length===e}catch(o){}return!1}}const u=d(4),p=d(3),h=e=>e instanceof a.Tensor;class m extends Error{constructor(e){super(e),(0,n.Z)(this,"type",void 0),this.type=e}}const f=e=>"number"===typeof e,g=e=>Array.isArray(e)&&2===e.length&&e.every(f),v=e=>{console.warn(Array.isArray(e)?e.join("\n"):e)};function y(e){return void 0!==e&&"function"===typeof e}const w=(e,t,o)=>!(!y(e)||e.length<=1)&&(void 0===o&&"tensor"===t||"tensor"===o);async function b(e,t){let o;for(o=await e.next();!o.done;o=await e.next())t&&await t(o.value);return o.value}function S(e){return null!==e&&void 0!==e}function z(e,t){for(var o=arguments.length,n=new Array(o>2?o-2:0),i=2;i<o;i++)n[i-2]=arguments[i];const r=n.filter(S);if(r.length){const o=e.tidy((()=>r.reduce(((e,t)=>t(e)),t)));return t.isDisposed||t===o||t.dispose(),o}return t}const E=["Passing a model definition as a function is deprecated and will be removed in a future version.","To leverage model lifecycle methods, use the setup and teardown methods.","For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#deprecated-model-definition-function",".")].join(" "),j=['"padding" is undefined, but "patchSize" is explicitly defined.',"Without padding, patches of images often have visible artifacting at the seams. Defining an explicit padding will resolve the artifacting.","For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#padding-is-undefined","."),'To hide this warning, pass an explicit padding of "0".'].join(" "),I=['The "progress" callback was provided but "patchSize" was not defined.','Without a "patchSize", the "progress" callback will never be called.',"For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#progress-specified-without-patch-size",".")].join(" "),x=["The model output was not a valid tensor. UpscalerJS only supports models returning valid tensors.","This is likely an error with the model itself, not UpscalerJS.","For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#invalid-model-prediction",".")].join(" "),T=new Error("No defined tensors were passed to concatTensors");class _ extends Error{constructor(){super(...arguments),(0,n.Z)(this,"message","The upscale request received an abort signal")}}const A=e=>["You've provided an invalid model type: ".concat(JSON.stringify(e),'. Accepted types are "layers" and "graph".'),"For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#invalid-model-type",".")].join(" "),C="There is a bug with the upscaler code. Please report this.",D=["You have provided a patchSize, but the model definition already includes an input size.","Your patchSize will be ignored.","For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#input-size-and-patch-size",".")].join(" "),N=new Error(["Model input sizes must be square. If you are using a model with a non-square input size and would like to request support,","please file a feature request at https://github.com/thekevinscott/upscalerjs"].join(" ")),k=e=>['Provided model configuration is missing both a "path" and "_internals". A valid path to a model JSON file must be provided.',"For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#missing-path-and-internals","."),"The model configuration provided was: ".concat(JSON.stringify(e))].join(" ");const O=(e,t,o)=>async n=>{if(o&&await e.nextFrame(),(i=t)&&i.aborted)throw Array.isArray(n)?n.forEach((e=>null===e||void 0===e?void 0:e.dispose())):h(n)&&n.dispose(),new _;var i},F=e=>!(!e||"object"!==typeof e)&&("patchSize"in e&&"number"===typeof e.patchSize),M=e=>Boolean(e)&&"number"===typeof e&&e>0,P=e=>new Error((e=>["Invalid value passed to warmup in warmupSizes:",JSON.stringify(e),"For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#invalid-warmup-value",".")].join("\n"))(e)),L=e=>{if(F(e)){const{patchSize:t}=e;return t}return e};const Z=e=>{if(Array.isArray(e)){for(const t of e)if(!F(t)&&!M(t))throw P(e);return e}if(F(e)||M(e))return[e];throw P(e)},B=async function(e,t,o){let{signal:n,awaitNextFrame:i=!1}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r=O(e,n||(arguments.length>4?arguments[4]:void 0).signal,i);await r(),await b(async function*(e,t,o){const{model:n,modelDefinition:i}=await t;for(const r of o){if(!F(r)&&!M(r))throw P(r);const t=L(r);let o=e.zeros([1,t,t,3]);yield[o];const s=[i.preprocess,e=>n.predict(e),i.postprocess].filter(Boolean);for(const n of s)o=z(e,o,n),yield[o];o.dispose(),yield}}(e,t,Z(o)),r)};async function H(e,t){const o=function(e,t){return function(e){return"function"===typeof e}(t)?(v(E),t(e)):t}(e,t);return o.setup&&await o.setup(e),o}function J(e,t,o){return"graph"===o?e.loadGraphModel(t):e.loadLayersModel(t)}const U=(e,t)=>{let{model:o}=t;const n=((e,t)=>((e,t)=>t instanceof e.LayersModel)(e,t)?t.layers[0].batchInputShape:t.inputs[0].shape)(e,o);if(!c(n))throw new Error((i=n,["Expected model to have a rank-4 compatible input shape. Instead got: ".concat(JSON.stringify(i),"."),"For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#error-with-model-input-shape",".")].join(" ")));var i;return n},R=(e,t)=>Math.ceil(t/e)*e,G=(e,t,o,n)=>{let{patchSize:i,padding:r}=o;const s=U(e,t);if(void 0!==i){if(i<=0)throw(e=>new Error(["Invalid patch size: ".concat(e,". Patch size must be greater than 0.")].join(" ")))(i);if(void 0!==r&&2*r>=i)throw((e,t)=>new Error(["Invalid patch size and padding: ".concat(e," and ").concat(t,". Patch size must be greater than padding * 2.")].join(" ")))(i,r)}if(l(s)){if(void 0!==i&&v(D),s[1]!==s[2])throw N;return{patchSize:s[1],padding:r,modelInputShape:s}}void 0!==i&&void 0===r&&v(j);const{divisibilityFactor:a}=t.modelDefinition;if(void 0!==a){if(void 0!==i){const e=R(a,i);return e!==i&&v(((e,t,o)=>["Invalid patch size: ".concat(e,". The model has a defined divibility factor of ").concat(t," and patch size must be a multiple of this number."),"Patch size has been scaled up to ".concat(o,"."),"\nFor more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#patch-size-indivisible-by-divisibility-factor",".")].join(" "))(i,a,e)),{patchSize:e,padding:r,modelInputShape:[null,e,e,3]}}return{patchSize:void 0,padding:void 0,modelInputShape:[null,R(a,n[1]),R(a,n[2]),3]}}return{patchSize:i,padding:r,modelInputShape:void 0}},V=(e,t)=>o=>{const n=o.shape[1],i=o.shape[2];return l(t)&&(t[1]>n||t[2]>i)?e.tidy((()=>{const r=Math.max(n,t[1]),s=Math.max(i,t[2]),a=e.zeros([1,n,s-i,3]),c=e.zeros([1,r-n,s,3]),l=e.concat([o,a],2);return e.concat([l,c],1)})):o},q=(e,t,o)=>n=>{const i=t[1]*o,r=t[2]*o;return i<n.shape[1]||r<n.shape[2]?e.tidy((()=>e.slice(n,[0,0,0],[1,i,r,3]))):n},Y=e=>t=>{const o=g(e)?e[1]:255;return t.clipByValue(0,o).mul(1===o?255:1)},W=(e,t)=>o=>g(t)&&1===t[1]?e.mul(o,1/255):o;function K(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=t.filter(S);if(0===n.length)throw T;const i=e.concat(n,o);return t.forEach((e=>null===e||void 0===e?void 0:e.dispose())),i}const Q=(e,t,o,n)=>{let i=t;const r=0===t||o===e?0:n,s=i+o>e;let a=s?o-(e-i):0;const c=s||o===e?0:n,l=s?0:r;let d=o-(s?a:0);s&&(i=e-o),i-=l,a+=l,d-=l+c;return{pre:{origin:i,size:o},post:{origin:a,size:d},increment:o>e?e:o-r-c}},X=(e,t,o)=>{let[n,i]=e;const r=[];let s=0,a=0;for(;a<i;){const{pre:{origin:e,size:c},post:{origin:l,size:d},increment:u}=Q(i,a,Math.min(t,i),o),p=[];for(;s<n;){const{pre:{origin:i,size:r},post:{origin:a,size:u},increment:h}=Q(n,s,Math.min(t,n),o);p.push({pre:{origin:[e,i],size:[c,r]},post:{origin:[l,a],size:[d,u]}}),s+=h}r.push(p),s=0,a+=u}return r},$=(e,t,o,n)=>(e*o+t+1)/n,ee=(e,t)=>{const o=e.predict(t);if(!h(o))throw new Error(x);if(u(o))return o;throw new Error((n=o.shape,["The tensor returned by the model was not a valid rank-4 tensor. It's shape is ".concat(JSON.stringify(n),".}"),"UpscalerJS only supports models returning valid image-like data in four dimensional form.","For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#invalid-predicted-tensor",".")].join(" ")));var n};function te(e,t,o,n,i){try{let{getImageAsTensor:r,tensorAsBase64:s}=i;return async function*(){const i=function(e){return h(e)?e.clone():e}(t),a=await r(e,i);yield a;const c=a.shape,{patchSize:l,padding:d,modelInputShape:u}=G(e,n,o,c),p=z(e,a,n.modelDefinition.preprocess,W(e,n.modelDefinition.inputRange),u?V(e,u):void 0);yield p;const m=function(e,t,o,n,i,r){try{let{output:s,progress:a,progressOutput:c}=o,{originalImageSize:l,patchSize:d,padding:u=0}=i,{tensorAsBase64:p}=r;return async function*(){var o;const{model:i,modelDefinition:r}=n,h=null!==(o=r.scale)&&void 0!==o?o:1;if(d){var m;const[o,n]=t.shape.slice(1),g=X([n,o],d,u);let v;yield;const b=g.length*g[0].length;for(let l=0;l<g.length;l++){const o=g[l],n=o.length;let d;yield[d,v];for(let u=0;u<n;u++){const{pre:m,post:g}=o[u];yield[v,d];const S=t.slice([0,...m.origin],[-1,...m.size]);yield[v,d,S];const E=ee(i,S);S.dispose(),yield[v,d,E];const j=[0,g.origin[0]*h,g.origin[1]*h],I=[-1,g.size[0]*h,g.size[1]*h],x=E.slice(j,I);E.dispose(),yield[v,d,x];const T=z(e,x,r.postprocess,Y(r.outputRange));if(yield[v,d,T],void 0!==a&&y(a)){const t=$(l,u,n,b);if(y(f=a)&&f.length<=1)a(t);else{const o=T.squeeze(),n={row:l,col:u,patchCoordinates:{pre:m,post:g}};if(w(a,s,c))a(t,o,n);else{const i=p(e,o);o.dispose(),a(t,i,n)}}}yield[v,d,T],d=K(e,[d,T],2),T.dispose(),yield[v,d]}v=K(e,[v,d],1),d.dispose(),yield[v]}const S=z(e,v.clone(),q(e,l,h));null===(m=v)||void 0===m||m.dispose(),yield[S];const E=S.squeeze();return S.dispose(),E}var f;a&&v(I);const g=ee(i,t);yield[g];const b=z(e,g.clone(),r.postprocess,Y(r.outputRange),q(e,l,h));g.dispose(),yield[b];const S=b.squeeze();return b.dispose(),S}()}catch(s){return Promise.reject(s)}}(e,p,{output:o.output,progressOutput:o.progressOutput,progress:o.progress},n,{originalImageSize:c,patchSize:l,padding:d},{tensorAsBase64:s});let f=await m.next();for(yield f.value;!f.done;)f=await m.next(),Array.isArray(f.value)?yield[...f.value,p]:h(f.value)?yield[f.value,p]:yield p;p.dispose();const g=f.value;if("tensor"===o.output)return g;const b=s(e,g);return g.dispose(),b}()}catch(r){return Promise.reject(r)}}const oe=r;var ne=o(65812);const ie=e=>"tensor"===e?"tensor":"base64",re={jsdelivr:(e,t,o)=>"https://cdn.jsdelivr.net/npm/".concat(e,"@").concat(t,"/").concat(o),unpkg:(e,t,o)=>"https://unpkg.com/".concat(e,"@").concat(t,"/").concat(o)},se=["jsdelivr","unpkg"],ae=(e,t,o)=>new Error(["Could not resolve URL ".concat(t," for package ").concat(null===o||void 0===o?void 0:o.name,"@").concat(null===o||void 0===o?void 0:o.version),"Errors include:",...e.map((e=>{let[t,o]=e;return"- ".concat(t,": ").concat(o.message)}))].join("\n"));const ce=()=>new Error(["Environment does not support a string URL as an input format.","For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#environment-disallows-string-input",".")].join("\n")),le=()=>new Error(["Environment does not support base64 as an output format.","For more information, see ".concat("https://upscalerjs.com/documentation/troubleshooting#environment-disallows-base64",".")].join("\n")),de=e=>new Promise(((t,o)=>{const n=new Image;n.src=e,n.crossOrigin="anonymous",n.onload=()=>t(n),n.onerror=()=>o(new Error(["Failed to load image"].join(" ")))})),ue=e=>ne.browser.fromPixelsAsync(e),pe=e=>{try{if(!0!==(new Image&&"createElement"in document))throw e()}catch(t){throw e()}},he=function(e){let{tf:t,getUpscaleOptions:o,checkValidEnvironment:i,getImageAsTensor:r,tensorAsBase64:s,loadModel:a}=e;return class{constructor(){var e=this;let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,n.Z)(this,"_opts",void 0),(0,n.Z)(this,"_model",void 0),(0,n.Z)(this,"ready",void 0),(0,n.Z)(this,"_abortController",new AbortController),(0,n.Z)(this,"upscale",this.execute.bind(this)),(0,n.Z)(this,"warmup",(async function(){let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0;return await e.ready,B(t,e._model,o,n,{signal:e._abortController.signal})})),(0,n.Z)(this,"abort",(()=>{this._abortController.abort(),this._abortController=new AbortController})),(0,n.Z)(this,"dispose",(async()=>{await this.ready;const{model:e,modelDefinition:o}=await this._model;o.teardown&&await o.teardown(t),e.dispose()})),(0,n.Z)(this,"getModel",(()=>this._model)),this._opts={...o},this._model=a(t,H(t,this._opts.model||oe)),this.ready=new Promise(((e,o)=>{this._model.then((()=>B(t,this._model,this._opts.warmupSizes||[],void 0,{signal:this._abortController.signal}))).then(e).catch(o)}))}async execute(e,n){const a={checkValidEnvironment:i,getImageAsTensor:r,tensorAsBase64:s};await this.ready;const c=await this._model;return async function(e,t,o,n,i){let{signal:r,awaitNextFrame:s,...a}=o,{checkValidEnvironment:c,...l}=i;c(t,{output:a.output,progressOutput:a.progressOutput});const d=O(e,r||n.signal,s);await d();const u=await b(te(e,t,a,n,l),d);return await d(),u}(t,e,o(n),{...c,signal:this._abortController.signal},a)}}}({tf:ne,getUpscaleOptions:function(){let{output:e,progressOutput:t,...o}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{...o,output:ie(e),progressOutput:ie(t||e)}},loadModel:async(e,t)=>{const o=await t;try{(e=>{var t,o,n;if(void 0===e)throw new m(s.UNDEFINED);if("string"!==typeof(n=null!==(t=e.modelType)&&void 0!==t?t:"layers")||!["layers","graph"].includes(n))throw new m(s.INVALID_MODEL_TYPE);if(!e.path&&(null===(o=e._internals)||void 0===o||!o.path))throw new m(s.MISSING_PATH)})(o)}catch(r){if((e=>e instanceof m)(r))throw function(e,t){switch(e){case s.INVALID_MODEL_TYPE:return new Error(A(null===t||void 0===t?void 0:t.modelType));case s.MISSING_PATH:return new Error(k(t));default:return new Error(C)}}(r.type,o);throw new Error(C)}const n=(e=>({...e}))(o),i=await async function(e,t){const{modelType:o,_internals:n,path:i}=t;if(i)return await J(e,i,o);if(!n)throw new Error(C);const s=[];for(const a of se){const t=re[a];try{const i=t(n.name,n.version,n.path);return await J(e,i,o)}catch(r){s.push([a,r instanceof Error?r:new Error("There was an unknown error: ".concat(JSON.stringify(r)))])}}throw ae(s,i||n.path,n)}(e,n);return{model:i,modelDefinition:n}},getImageAsTensor:async(e,t)=>{const o=await(async(e,t)=>{if(h(e))return e;if("string"===typeof e){const t=await de(e);return ue(t)}return ue(e)})(t);if(p(o)){const e=o.expandDims(0);return o.dispose(),e}if(u(o))return o;throw(e=>new Error(["Unsupported dimensions for incoming pixels: ".concat(e.shape.length,"."),"Only 3 or 4 rank tensors are supported."].join("\n")))(o)},tensorAsBase64:(e,t)=>{const o=((e,t)=>e.tidy((()=>{const[o,n]=t.shape,i=e.fill([o,n],255).expandDims(2);return t.clipByValue(0,255).concat([i],2).dataSync()})))(e,t),[n,i]=t.shape,r=new ImageData(i,n);r.data.set(o);const s=document.createElement("canvas");s.width=i,s.height=n;const a=s.getContext("2d");if(!a)throw new Error("No context found");return a.putImageData(r,0,0),s.toDataURL()},checkValidEnvironment:(e,t)=>{let{output:o="base64",progressOutput:n}=t;"string"===typeof e&&pe(ce),"base64"!==n&&"base64"!==o||pe(le)}});class me{static Init(e){new me(e)}constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"main";this.canvasSD=void 0,this.implementation=void 0,this.host=void 0,this.divText=void 0;const t="https://raw.githubusercontent.com/NamjuLee/data/master/img/map/worldMapGlobeA_small.png",o=new Image;o.src=t;const n=document.getElementById(e);n&&n.appendChild(o);new he({}).upscale(t).then((e=>{const t=document.createElement("img");t.src=e,n&&n.appendChild(t)}))}InitHTML(){const e=document.createElement("button");e.style.width="100px",e.style.height="20px",e.style.marginLeft="20px",e.style.zIndex="5",e.name="Clear",e.innerText="Clear",e.value="Clear",e.onclick=()=>{console.log(this),this.canvasSD.Clear()},this.host.appendChild(e),this.divText=document.createElement("div"),this.divText.id="classText",this.divText.style.zIndex="5",this.divText.innerText="class: ",this.divText.style.marginLeft="20px",this.host.appendChild(this.divText)}Init(e){}Clear(){this.canvasSD.Clear()}}class fe{constructor(e){this.divHost=void 0,this.divHost=document.getElementById(e),me.Init(e)}destroy(){if(this.divHost)try{for(;this.divHost.firstChild;)this.divHost.removeChild(this.divHost.firstChild)}catch(e){console.error("Error in destroy method:",e)}else console.warn("divHost is undefined in destroy method")}}},31916:(e,t,o)=>{function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function i(e){var t=function(e,t){if("object"!==n(e)||null===e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var i=o.call(e,t||"default");if("object"!==n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===n(t)?t:String(t)}function r(e,t,o){return(t=i(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}o.d(t,{Z:()=>r})}}]);
//# sourceMappingURL=28706.d7511480.chunk.js.map