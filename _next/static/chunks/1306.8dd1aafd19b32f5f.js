"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1306],{49644:function(e,t,i){i.d(t,{$X:function(){return o},Fv:function(){return h},IH:function(){return n},Ue:function(){return a},al:function(){return s},kC:function(){return c},od:function(){return u}});var r=i(59382);function a(){var e=new r.WT(3);return r.WT!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function s(e,t,i){var a=new r.WT(3);return a[0]=e,a[1]=t,a[2]=i,a}function n(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function o(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function u(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e}function h(e,t){var i=t[0],r=t[1],a=t[2],s=i*i+r*r+a*a;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function c(e,t,i){var r=t[0],a=t[1],s=t[2],n=i[0],o=i[1],u=i[2];return e[0]=a*u-s*o,e[1]=s*n-r*u,e[2]=r*o-a*n,e}a()},1306:function(e,t,i){i.r(t),i.d(t,{Solution:function(){return b}});class r{constructor(e){let t=new Float32Array([0,0,.5,.5,0,0,-.5,-.5,0,1,0,.5,-.5,1,1]),i=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,r={size:t.byteLength,usage:i,mappedAtCreation:!0};this.buffer=e.createBuffer(r),new Float32Array(this.buffer.getMappedRange()).set(t),this.buffer.unmap(),this.bufferLayout={arrayStride:20,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}class a{constructor(e){let t=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,.5,.5,0,1,1,-.5,.5,0,0,1,-.5,-.5,0,0,0]),i=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,r={size:t.byteLength,usage:i,mappedAtCreation:!0};this.buffer=e.createBuffer(r),new Float32Array(this.buffer.getMappedRange()).set(t),this.buffer.unmap(),this.bufferLayout={arrayStride:20,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var s,n,o=i(81519);class u{async initialize(e,t,i){console.log(t);let r=await fetch(t),a=await r.blob(),s=await createImageBitmap(a);await this.loadImageBitmap(e,s),this.view=this.texture.createView({format:"rgba8unorm",dimension:"2d",aspect:"all",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}),this.sampler=e.createSampler({addressModeU:"repeat",addressModeV:"repeat",magFilter:"linear",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1}),this.bindGroup=e.createBindGroup({layout:i,entries:[{binding:0,resource:this.view},{binding:1,resource:this.sampler}]})}async loadImageBitmap(e,t){let i={size:{width:t.width,height:t.height},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};this.texture=e.createTexture(i),e.queue.copyExternalImageToTexture({source:t},{texture:this.texture},i.size)}}(s=n||(n={}))[s.TRIANGLE=0]="TRIANGLE",s[s.QUAD=1]="QUAD";var h=i(20357);let c="\nstruct TransformData {\n    view: mat4x4<f32>,\n    projection: mat4x4<f32>,\n};\n\nstruct ObjectData {\n    model: array<mat4x4<f32>>,\n};\n\n@binding(0) @group(0) var<uniform> transformUBO: TransformData;\n@binding(1) @group(0) var<storage, read> objects: ObjectData;\n@binding(0) @group(1) var myTexture: texture_2d<f32>;\n@binding(1) @group(1) var mySampler: sampler;\n\nstruct Fragment {\n    @builtin(position) Position : vec4<f32>,\n    @location(0) TexCoord : vec2<f32>\n};\n\n@vertex\nfn vs_main(\n    @builtin(instance_index) ID: u32,\n    @location(0) vertexPostion: vec3<f32>, \n    @location(1) vertexTexCoord: vec2<f32>) -> Fragment {\n\n    var output : Fragment;\n    output.Position = transformUBO.projection * transformUBO.view * objects.model[ID] * vec4<f32>(vertexPostion, 1.0);\n    output.TexCoord = vertexTexCoord;\n\n    return output;\n}\n\n@fragment\nfn fs_main(@location(0) TexCoord : vec2<f32>) -> @location(0) vec4<f32> {\n    return textureSample(myTexture, mySampler, TexCoord);\n}\n",l=async e=>{let t=new DOMParser,i=await fetch(e),r=await i.text(),a=await t.parseFromString(r,"text/xml");return console.log(r,a),r};class d{async Initialize(){console.log(await l(h.env.PUBLIC_URL+"/shaders/shaders.wgsl")),await this.setupDevice(),await this.makeBindGroupLayouts(),await this.createAssets(),await this.makeDepthBufferResources(),await this.makePipeline(),await this.makeBindGroup()}async setupDevice(){var e,t;this.adapter=await (null===(e=navigator.gpu)||void 0===e?void 0:e.requestAdapter()),this.device=await (null===(t=this.adapter)||void 0===t?void 0:t.requestDevice()),this.context=this.canvas.getContext("webgpu"),this.format="bgra8unorm",this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}async makeDepthBufferResources(){this.depthStencilState={format:"depth24plus-stencil8",depthWriteEnabled:!0,depthCompare:"less-equal"};let e={size:{width:this.canvas.width,height:this.canvas.height,depthOrArrayLayers:1},format:"depth24plus-stencil8",usage:GPUTextureUsage.RENDER_ATTACHMENT};this.depthStencilBuffer=this.device.createTexture(e),this.depthStencilView=this.depthStencilBuffer.createView({format:"depth24plus-stencil8",dimension:"2d",aspect:"all"}),this.depthStencilAttachment={view:this.depthStencilView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store",stencilLoadOp:"clear",stencilStoreOp:"discard"}}async makeBindGroupLayouts(){this.frameGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage",hasDynamicOffset:!1}}]}),this.materialGroupLayout=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]})}async makePipeline(){let e=this.device.createPipelineLayout({bindGroupLayouts:[this.frameGroupLayout,this.materialGroupLayout]});this.pipeline=this.device.createRenderPipeline({vertex:{module:this.device.createShaderModule({code:c}),entryPoint:"vs_main",buffers:[this.triangleMesh.bufferLayout]},fragment:{module:this.device.createShaderModule({code:c}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-list"},layout:e,depthStencil:this.depthStencilState})}async createAssets(){this.triangleMesh=new r(this.device),this.quadMesh=new a(this.device),this.triangleMaterial=new u,this.quadMaterial=new u,this.uniformBuffer=this.device.createBuffer({size:128,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});let e={size:65536,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST};this.objectBuffer=this.device.createBuffer(e),await this.triangleMaterial.initialize(this.device,h.env.PUBLIC_URL+"/img/profile0.jpg",this.materialGroupLayout),await this.quadMaterial.initialize(this.device,h.env.PUBLIC_URL+"/img/profile0.jpg",this.materialGroupLayout)}async makeBindGroup(){this.frameBindGroup=this.device.createBindGroup({layout:this.frameGroupLayout,entries:[{binding:0,resource:{buffer:this.uniformBuffer}},{binding:1,resource:{buffer:this.objectBuffer}}]})}async render(e){if(!this.device||!this.pipeline)return;let t=o.Ue();o.G3(t,Math.PI/4,800/600,.1,10);let i=e.view_transform;this.device.queue.writeBuffer(this.objectBuffer,0,e.model_transforms,0,e.model_transforms.length),this.device.queue.writeBuffer(this.uniformBuffer,0,i),this.device.queue.writeBuffer(this.uniformBuffer,64,t);let r=this.device.createCommandEncoder(),a=this.context.getCurrentTexture().createView(),s=r.beginRenderPass({colorAttachments:[{view:a,clearValue:{r:.5,g:0,b:.25,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:this.depthStencilAttachment});s.setPipeline(this.pipeline),s.setBindGroup(0,this.frameBindGroup);var u=0;s.setVertexBuffer(0,this.triangleMesh.buffer),s.setBindGroup(1,this.triangleMaterial.bindGroup),s.draw(3,e.object_counts[n.TRIANGLE],0,u),u+=e.object_counts[n.TRIANGLE],s.setVertexBuffer(0,this.quadMesh.buffer),s.setBindGroup(1,this.quadMaterial.bindGroup),s.draw(6,e.object_counts[n.QUAD],0,u),u+=e.object_counts[n.QUAD],s.end(),this.device.queue.submit([r.finish()])}constructor(e){this.canvas=e}}var f=i(49644);function p(e){return e*Math.PI/180}class m{update(){this.model=o.Ue(),o.Iu(this.model,this.model,this.position),o.jI(this.model,this.model,p(this.eulers[2]))}get_model(){return this.model}constructor(e,t){this.position=e,this.eulers=f.Ue(),this.eulers[2]=t}}class v{update(){this.forwards=[Math.cos(p(this.eulers[2]))*Math.cos(p(this.eulers[1])),Math.sin(p(this.eulers[2]))*Math.cos(p(this.eulers[1])),Math.sin(p(this.eulers[1]))],f.kC(this.right,this.forwards,[0,0,1]),f.kC(this.up,this.right,this.forwards);var e=f.Ue();f.IH(e,this.position,this.forwards),this.view=o.Ue(),o.zB(this.view,this.position,e,this.up)}get_view(){return this.view}constructor(e,t,i){this.position=e,this.eulers=[0,i,t],this.forwards=f.Ue(),this.right=f.Ue(),this.up=f.Ue()}}class g{make_triangles(){for(var e=0,t=0;t<1;t++){this.triangles.push(new m([2,t,0],0));for(var i=o.Ue(),r=0;r<16;r++)this.object_data[16*e+r]=i.at(r);e++,this.triangle_count++}}update(){var e=0;this.triangles.forEach(t=>{t.update();for(var i=t.get_model(),r=0;r<16;r++)this.object_data[16*e+r]=i.at(r);e++}),this.quads.forEach(t=>{t.update();for(var i=t.get_model(),r=0;r<16;r++)this.object_data[16*e+r]=i.at(r);e++}),this.player.update()}get_player(){return this.player}get_renderables(){return{view_transform:this.player.get_view(),model_transforms:this.object_data,object_counts:{[n.TRIANGLE]:this.triangle_count,[n.QUAD]:this.quad_count}}}spin_player(e,t){this.player.eulers[2]-=e,this.player.eulers[2]%=360,this.player.eulers[1]=Math.min(89,Math.max(-89,this.player.eulers[1]-t))}move_player(e,t){f.od(this.player.position,this.player.position,this.player.forwards,e),f.od(this.player.position,this.player.position,this.player.right,t)}constructor(){this.triangles=[],this.quads=[],this.object_data=new Float32Array(16384),this.triangle_count=0,this.quad_count=0,this.make_triangles(),this.player=new v([-2,0,.5],0,0)}}class y{async InitializeRenderer(){await this.renderer.Initialize()}handle_mouse_move(e){}constructor(e){this.run=()=>{this.scene.update(),this.scene.move_player(this.forwards_amount,this.right_amount),this.renderer.render(this.scene.get_renderables()),requestAnimationFrame(this.run)},this.canvas=e,this.renderer=new d(e),this.scene=new g,this.keyLabel=document.getElementById("key-label"),this.mouseXLabel=document.getElementById("mouse-x-label"),this.mouseYLabel=document.getElementById("mouse-y-label"),this.forwards_amount=0,this.right_amount=0,this.canvas.onclick=()=>{this.canvas.requestPointerLock()},this.canvas.addEventListener("mousemove",e=>{this.handle_mouse_move(e)})}}class b{async initWebGPU(){let e=new y(this.canvas);e.InitializeRenderer(),e.run()}run(){}destroy(){for(this.device.destroy();this.divHost.lastElementChild;)this.divHost.removeChild(this.divHost.lastElementChild)}constructor(e){this.divHost=document.getElementById(e),this.canvas=document.createElement("canvas"),this.canvas.width=500,this.canvas.height=500,this.divHost.appendChild(this.canvas),this.initWebGPU()}}}}]);