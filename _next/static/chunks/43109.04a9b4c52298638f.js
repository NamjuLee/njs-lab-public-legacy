"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[43109],{43109:function(e,t,l){l.d(t,{ElevationQuery:function(){return A}});var i=l(27817),n=l(94605),a=l(36152),s=l(31124),o=l(9266),r=l(18736),u=l(33876),c=l(58144),h=l(20928),f=l(20795);l(55066),l(37180);var p=l(1662),m=l(65223),d=l(56132);let y=()=>m.Z.getLogger("esri.layers.support.ElevationSampler");class x{queryElevation(e){return function(e,t){let l=T(e,t.spatialReference);if(!l)return null;switch(e.type){case"point":e.z=t.elevationAt(l.x,l.y);break;case"polyline":!function(e,t,l){g.spatialReference=t.spatialReference;let i=e.hasM&&!e.hasZ;for(let n=0;n<e.paths.length;n++){let a=e.paths[n],s=t.paths[n];for(let e=0;e<a.length;e++){let t=a[e],n=s[e];g.x=n[0],g.y=n[1],i&&(t[3]=t[2]),t[2]=l.elevationAt(g.x,g.y)}}e.hasZ=!0}(e,l,t);break;case"multipoint":!function(e,t,l){g.spatialReference=t.spatialReference;let i=e.hasM&&!e.hasZ;for(let n=0;n<e.points.length;n++){let a=e.points[n],s=t.points[n];g.x=s[0],g.y=s[1],i&&(a[3]=a[2]),a[2]=l.elevationAt(g.x,g.y)}e.hasZ=!0}(e,l,t)}return e}(e.clone(),this)}on(){return(0,p.kB)()}projectIfRequired(e,t){return T(e,t)}}class v extends x{get spatialReference(){return this.extent.spatialReference}constructor(e,t,l){super(),this.tile=e,this.noDataValue=l;let i=e.tile.extent;this.extent=(0,f.HH)(i,t.spatialReference),this.extent.zmin=e.zmin,this.extent.zmax=e.zmax,this._aaExtent=i;let n=(0,o.c9)(t.spatialReference),a=t.lodAt(e.tile.level).resolution*n;this.demResolution={min:a,max:a}}contains(e){let t=this.projectIfRequired(e,this.spatialReference);return null!=t&&this.containsAt(t.x,t.y)}containsAt(e,t){return(0,f.jE)(this._aaExtent,e,t)}elevationAt(e,t){if(!this.containsAt(e,t)){let l=this.extent,i=`${l.xmin}, ${l.ymin}, ${l.xmax}, ${l.ymax}`;return y().warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return this.tile.sample(e,t)??this.noDataValue}}class w extends x{get spatialReference(){return this.extent.spatialReference}constructor(e,t,l){let i;super(),"number"==typeof t?(this.noDataValue=t,i=null):(i=t,this.noDataValue=l),this.samplers=i?e.map(e=>new v(e,i,this.noDataValue)):e;let n=this.samplers[0];if(n){this.extent=n.extent.clone();let{min:e,max:t}=n.demResolution;this.demResolution={min:e,max:t};for(let e=1;e<this.samplers.length;e++){let t=this.samplers[e];this.extent.union(t.extent),this.demResolution.min=Math.min(this.demResolution.min,t.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,t.demResolution.max)}}else this.extent=(0,f.HH)((0,f.Ue)(),i.spatialReference),this.demResolution={min:0,max:0}}elevationAt(e,t){let l,i=!1;for(let n of this.samplers)if(n.containsAt(e,t)&&(i=!0,(l=n.elevationAt(e,t))!==n.noDataValue))return l;return null!=l?l:(i||y().warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler`),this.noDataValue)}}function T(e,t){if(null==e)return null;let l=e.spatialReference;if(l.equals(t))return e;let i=(0,d.iV)(e,t);return i||y().error(`Cannot project geometry spatial reference (wkid:${l.wkid}) to elevation sampler spatial reference (wkid:${t.wkid})`),i}let g=new u.Z;class _{constructor(e,t){this.data=e,this.safeWidth=.99999999*(e.width-1),this.dx=(e.width-1)/(t[2]-t[0]),this.dy=(e.width-1)/(t[3]-t[1]),this.x0=t[0],this.y1=t[3]}}class R{constructor(e,t=null){if(this.tile=e,null!=t&&null!=e){let l=e.extent;this._samplerData=new _(t,l)}}get zmin(){return null!=this._samplerData?this._samplerData.data.minValue:0}get zmax(){return null!=this._samplerData?this._samplerData.data.maxValue:0}get hasNoDataValues(){return!!this._samplerData?.data.hasNoDataValues}sample(e,t){var l,i;if(null==this._samplerData)return;let{safeWidth:n,data:a,dx:s,dy:o,y1:r,x0:u}=this._samplerData,{width:c,values:h,noDataValue:f}=a,p=(l=o*(r-t))<0?0:l>n?n:l,m=(i=s*(e-u))<0?0:i>n?n:i,d=Math.floor(p),y=Math.floor(m),x=d*c+y,v=x+c,w=h[x],T=h[v],g=h[x+1],_=h[v+1];if(w!==f&&T!==f&&g!==f&&_!==f){let e=m-y,t=w+(g-w)*e;return t+(T+(_-T)*e-t)*(p-d)}}}var E=l(49176);class A{async queryAll(e,t,l){if(!(e=l?.ignoreInvisibleLayers?e.filter(e=>e.visible):e.slice()).length)throw new n.Z("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");let i=q.fromGeometry(t),a=!1;l?.returnSampleInfo||(a=!0);let s={...M,...l,returnSampleInfo:!0},o=await this.query(e[e.length-1],i,s),r=await this._queryAllContinue(e,o,s);return r.geometry=r.geometry.export(),a&&delete r.sampleInfo,r}async query(e,t,l){if(!e)throw new n.Z("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||!(t instanceof q)&&"point"!==t.type&&"multipoint"!==t.type&&"polyline"!==t.type)throw new n.Z("elevation-query:invalid-geometry","Only point, polyline and multipoint geometries can be used to query elevation");let i={...M,...l},a=new C(e,t.spatialReference,i),s=i.signal;return await e.load({signal:s}),await V(a,t,s),await this._selectTiles(a,s),await F(a,s),function(e){e.geometry.coordinates.forEach(t=>{let l=t.elevationTile,i=e.options.noDataValue;if(l){let e=l.sample(t.x,t.y);null!=e?i=e:t.elevationTile=null}t.z=i})}(a),S(a,s)}async createSampler(e,t,l){if(!e)throw new n.Z("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new n.Z("elevation-query:invalid-extent","Invalid or undefined extent");let i={...M,...l};return this._createSampler(e,t,i)}async createSamplerAll(e,t,l){if(!(e=l?.ignoreInvisibleLayers?e.filter(e=>e.visible):e.slice()).length)throw new n.Z("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new n.Z("elevation-query:invalid-extent","Invalid or undefined extent");let i={...M,...l,returnSampleInfo:!0},a=await this._createSampler(e[e.length-1],t,i);return this._createSamplerAllContinue(e,t,a,i)}async _createSampler(e,t,l,i){let n=l.signal;await e.load({signal:n});let a=t.spatialReference,s=e.tileInfo.spatialReference;a.equals(s)||(await (0,h.initializeProjection)([{source:a,dest:s}],{signal:n}),t=(0,h.project)(t,s));let o=new z(e,t,l,i);return await this._selectTiles(o,n),await F(o,n),new w(o.elevationTiles,o.layer.tileInfo,o.options.noDataValue)}async _createSamplerAllContinue(e,t,l,i){if(e.pop(),!e.length)return l;let n=l.samplers.filter(e=>!e.tile.hasNoDataValues).map(e=>(0,f.oJ)(e.extent)),a=await this._createSampler(e[e.length-1],t,i,n);if(0===a.samplers.length)return l;let s=new w(l.samplers.concat(a.samplers),i.noDataValue);return this._createSamplerAllContinue(e,t,s,i)}async _queryAllContinue(e,t,l){let i=e.pop(),n=t.geometry.coordinates,s=t.sampleInfo;(0,a.O3)(s);let o=[],r=[];for(let t=0;t<n.length;t++){let l=s[t];l.demResolution>=0?l.source||(l.source=i):e.length&&(o.push(n[t]),r.push(t))}if(!e.length||0===o.length)return t;let u=t.geometry.clone(o),c=await this.query(e[e.length-1],u,l),h=c.sampleInfo;if(!h)throw Error("no sampleInfo");return r.forEach((e,t)=>{n[e].z=c.geometry.coordinates[t].z,s[e].demResolution=h[t].demResolution}),this._queryAllContinue(e,t,l)}async _selectTiles(e,t){"geometry"===e.type&&function(e){if(null==e.layer.fullExtent)return;let t=new R(null);t.sample=()=>e.options.noDataValue,e.outsideExtentTile=t;let l=e.layer.fullExtent;e.geometry.coordinates.forEach(e=>{let i=e.x,n=e.y;(i<l.xmin||i>l.xmax||n<l.ymin||n>l.ymax)&&(e.elevationTile=t)})}(e);let l=e.options.demResolution;if("number"==typeof l)!function(e,t){let l=function(e,t){let{tileInfo:l,tilemapCache:i}=e.layer,n=t/(0,o.c9)(l.spatialReference),a=k(l,i),s=a[0],r=0;for(let e=1;e<a.length;e++){let t=a[e];Math.abs(t.resolution-n)<Math.abs(s.resolution-n)&&(s=t,r=e)}return r}(e,t);e.selectTilesAtLOD(l)}(e,l);else if("finest-contiguous"===l)await this._selectTilesFinestContiguous(e,t);else{if("auto"!==l)throw new n.Z("elevation-query:invalid-dem-resolution",`Invalid dem resolution value '${l}', expected a number, "finest-contiguous" or "auto"`);await this._selectTilesAuto(e,t)}}async _selectTilesFinestContiguous(e,t){let{tileInfo:l,tilemapCache:i}=e.layer,n=Z(l,i,e.options.minDemResolution);await this._selectTilesFinestContiguousAt(e,n,t)}async _selectTilesFinestContiguousAt(e,t,l){let i=e.layer;if(e.selectTilesAtLOD(t),t<0)return;let a=i.tilemapCache,o=e.getTilesToFetch();try{if(a&&!$(a))await (0,s.Hl)(Promise.all(o.map(e=>a.fetchAvailability(e.level,e.row,e.col,{signal:l}))),l);else if(await F(e,l),!e.allElevationTilesFetched())throw e.clearElevationTiles(),new n.Z("elevation-query:has-unavailable-tiles")}catch(i){(0,s.r9)(i),await this._selectTilesFinestContiguousAt(e,t-1,l)}}async _selectTilesAuto(e,t){(function(e){let{tileInfo:t,tilemapCache:l}=e.layer,i=Z(t,l,e.options.minDemResolution);e.selectTilesAtLOD(i,e.options.maximumAutoTileRequests)})(e),function(e){let t=e.layer.tileInfo,l=0,i={},n=e=>{null!=e.id&&(e.id in i?i[e.id]++:(i[e.id]=1,l++))},a=e=>{if(null==e.id)return;let t=i[e.id];1===t?(delete i[e.id],l--):i[e.id]=t-1};e.forEachTileToFetch(n,a);let s=!0;for(;s&&(s=!1,e.forEachTileToFetch(i=>{l<=e.options.maximumAutoTileRequests||(a(i),t.upsampleTile(i)&&(s=!0),n(i))},a),s););}(e);let l=e.layer.tilemapCache;if(!l||$(l))return this._selectTilesAutoPrefetchUpsample(e,t);let n=e.getTilesToFetch(),a={},o=n.map(async e=>{let n=new E.f(null,0,0,0,(0,f.Ue)()),o=await (0,i.q6)(l.fetchAvailabilityUpsample(e.level,e.row,e.col,n,{signal:t}));!1!==o.ok?null!=e.id&&(a[e.id]=n):(0,s.r9)(o.error)});await (0,s.Hl)(Promise.all(o),t),e.remapTiles(a)}async _selectTilesAutoPrefetchUpsample(e,t){let l=e.layer.tileInfo;await F(e,t);let i=!1;e.forEachTileToFetch((e,t)=>{l.upsampleTile(e)?i=!0:t()}),i&&await this._selectTilesAutoPrefetchUpsample(e,t)}}class q{export(){return this._exporter(this.coordinates,this.spatialReference)}clone(e){let t=new q;return t.geometry=this.geometry,t.spatialReference=this.spatialReference,t.coordinates=e||this.coordinates.map(e=>e.clone()),t._exporter=this._exporter,t}async project(e,t){if(this.spatialReference.equals(e))return this.clone();await (0,h.initializeProjection)([{source:this.spatialReference,dest:e}],{signal:t});let l=new r.Z({spatialReference:this.spatialReference,points:this.coordinates.map(e=>[e.x,e.y])}),i=(0,h.project)(l,e);if(!i)return null;let n=this.coordinates.map((e,t)=>{let l=e.clone(),n=i.points[t];return l.x=n[0],l.y=n[1],l}),a=this.clone(n);return a.spatialReference=e,a}static fromGeometry(e){let t=new q;if(t.geometry=e,t.spatialReference=e.spatialReference,e instanceof q)t.coordinates=e.coordinates.map(e=>e.clone()),t._exporter=(t,l)=>{let i=e.clone(t);return i.spatialReference=l,i};else switch(e.type){case"point":{let{hasZ:l,hasM:i}=e;t.coordinates=l&&i?[new D(e.x,e.y,e.z,e.m)]:l?[new D(e.x,e.y,e.z)]:i?[new D(e.x,e.y,null,e.m)]:[new D(e.x,e.y)],t._exporter=(t,l)=>e.hasM?new u.Z(t[0].x,t[0].y,t[0].z,t[0].m,l):new u.Z(t[0].x,t[0].y,t[0].z,l);break}case"multipoint":{let{hasZ:l,hasM:i}=e;t.coordinates=l&&i?e.points.map(e=>new D(e[0],e[1],e[2],e[3])):l?e.points.map(e=>new D(e[0],e[1],e[2])):i?e.points.map(e=>new D(e[0],e[1],null,e[2])):e.points.map(e=>new D(e[0],e[1])),t._exporter=(t,l)=>e.hasM?new r.Z({points:t.map(e=>[e.x,e.y,e.z,e.m]),hasZ:!0,hasM:!0,spatialReference:l}):new r.Z(t.map(e=>[e.x,e.y,e.z]),l);break}case"polyline":{let l=[],i=[],{hasZ:n,hasM:a}=e,s=0;for(let t of e.paths)if(i.push([s,s+t.length]),s+=t.length,n&&a)for(let e of t)l.push(new D(e[0],e[1],e[2],e[3]));else if(n)for(let e of t)l.push(new D(e[0],e[1],e[2]));else if(a)for(let e of t)l.push(new D(e[0],e[1],null,e[2]));else for(let e of t)l.push(new D(e[0],e[1]));t.coordinates=l,t._exporter=(t,l)=>{let n=e.hasM?t.map(e=>[e.x,e.y,e.z,e.m]):t.map(e=>[e.x,e.y,e.z]),a=i.map(e=>n.slice(e[0],e[1]));return new c.Z({paths:a,hasM:e.hasM,hasZ:!0,spatialReference:l})}}}return t}}class D{constructor(e,t,l=null,i=null,n=null,a=null){this.x=e,this.y=t,this.z=l,this.m=i,this.tile=n,this.elevationTile=a}clone(){return new D(this.x,this.y,this.z,this.m)}}class I{constructor(e,t){this.layer=e,this.options=t}}class C extends I{constructor(e,t,l){super(e,l),this.outSpatialReference=t,this.type="geometry"}selectTilesAtLOD(e){if(e<0)this.geometry.coordinates.forEach(e=>e.tile=null);else{let{tileInfo:t,tilemapCache:l}=this.layer,i=k(t,l)[e].level;this.geometry.coordinates.forEach(e=>e.tile=t.tileAt(i,e.x,e.y))}}allElevationTilesFetched(){return!this.geometry.coordinates.some(e=>!e.elevationTile)}clearElevationTiles(){for(let e of this.geometry.coordinates)e.elevationTile!==this.outsideExtentTile&&(e.elevationTile=null)}populateElevationTiles(e){for(let t of this.geometry.coordinates)!t.elevationTile&&t.tile?.id&&(t.elevationTile=e[t.tile.id])}remapTiles(e){for(let t of this.geometry.coordinates){let l=t.tile?.id;t.tile=l?e[l]:null}}getTilesToFetch(){let e={},t=[];for(let l of this.geometry.coordinates){let i=l.tile;if(!i)continue;let n=l.tile?.id;l.elevationTile||!n||e[n]||(e[n]=i,t.push(i))}return t}forEachTileToFetch(e){for(let t of this.geometry.coordinates)t.tile&&!t.elevationTile&&e(t.tile,()=>{t.tile=null})}}class z extends I{constructor(e,t,l,i){super(e,l),this.type="extent",this.elevationTiles=[],this._candidateTiles=[],this._fetchedCandidates=new Set,this.extent=t.clone().intersection(e.fullExtent),this.maskExtents=i}selectTilesAtLOD(e,t){let l=Math.min(this._maximumLodForRequests(t),e);l<0?this._candidateTiles.length=0:this._selectCandidateTilesCoveringExtentAt(l)}_maximumLodForRequests(e){let{tileInfo:t,tilemapCache:l}=this.layer,i=k(t,l);if(!e)return i.length-1;let n=this.extent;if(null==n)return -1;for(let l=i.length-1;l>=0;l--){let a=i[l],s=a.resolution*t.size[0],o=a.resolution*t.size[1];if(Math.ceil(n.width/s)*Math.ceil(n.height/o)<=e)return l}return -1}allElevationTilesFetched(){return this._candidateTiles.length===this.elevationTiles.length}clearElevationTiles(){this.elevationTiles.length=0,this._fetchedCandidates.clear()}populateElevationTiles(e){for(let t of this._candidateTiles){let l=t.id&&e[t.id];l&&(this._fetchedCandidates.add(t),this.elevationTiles.push(l))}}remapTiles(e){this._candidateTiles=b(this._candidateTiles.map(t=>e[t.id]))}getTilesToFetch(){return this._candidateTiles}forEachTileToFetch(e,t){let l=this._candidateTiles;this._candidateTiles=[],l.forEach(l=>{if(this._fetchedCandidates.has(l))return void(t&&t(l));let i=!1;e(l,()=>i=!0),i?t&&t(l):this._candidateTiles.push(l)}),this._candidateTiles=b(this._candidateTiles,t)}_selectCandidateTilesCoveringExtentAt(e){this._candidateTiles.length=0;let t=this.extent;if(null==t)return;let{tileInfo:l,tilemapCache:i}=this.layer,n=k(l,i)[e],a=l.tileAt(n.level,t.xmin,t.ymin),s=a.extent;if(null==s)return;let o=n.resolution*l.size[0],r=n.resolution*l.size[1],u=Math.ceil((t.xmax-s[0])/o),c=Math.ceil((t.ymax-s[1])/r);for(let e=0;e<c;e++)for(let t=0;t<u;t++){let i=new E.f(null,a.level,a.row-e,a.col+t);l.updateTileInfo(i),this._tileIsMasked(i)||this._candidateTiles.push(i)}}_tileIsMasked(e){return!!this.maskExtents&&this.maskExtents.some(t=>e.extent&&(0,f.r3)(t,e.extent))}}function Z(e,t,l=0){let i=k(e,t),n=i.length-1;if(l>0){let t=l/(0,o.c9)(e.spatialReference),a=i.findIndex(e=>e.resolution<t);0===a?n=0:a>0&&(n=a-1)}return n}let M={maximumAutoTileRequests:20,noDataValue:0,returnSampleInfo:!1,demResolution:"auto",minDemResolution:0};async function V(e,t,l){let i;let a=e.layer.tileInfo.spatialReference;if(t instanceof q?i=await t.project(a,l):(await (0,h.initializeProjection)([{source:t.spatialReference,dest:a}],{signal:l}),i=(0,h.project)(t,a)),!i)throw new n.Z("elevation-query:spatial-reference-mismatch",`Cannot query elevation in '${t.spatialReference.wkid}' on an elevation service in '${a.wkid}'`);e.geometry=q.fromGeometry(i)}function k(e,t){let l=e.lods;if($(t)){let{effectiveMinLOD:e,effectiveMaxLOD:i}=t;return l.filter(t=>t.level>=e&&t.level<=i)}return l}async function F(e,t){let l=e.getTilesToFetch(),i={},n=e.options.cache,a=e.options.noDataValue,o=l.map(async l=>{if(null==l.id)return;let s=`${e.layer.uid}:${l.id}:${a}`,o=null!=n?n.get(s):null,r=null!=o?o:await e.layer.fetchTile(l.level,l.row,l.col,{noDataValue:a,signal:t});null!=n&&n.put(s,r),i[l.id]=new R(l,r)});await (0,s.Hl)(Promise.allSettled(o),t),e.populateElevationTiles(i)}function b(e,t){let l={},i=[];for(let n of e){let e=n.id;e&&!l[e]?(l[e]=n,i.push(n)):t&&t(n)}let n=i.sort((e,t)=>e.level-t.level);return n.filter((e,l)=>{for(let i=0;i<l;i++){let l=n[i].extent;if(l&&e.extent&&(0,f.r3)(l,e.extent))return t&&t(e),!1}return!0})}async function S(e,t){let l=await e.geometry.project(e.outSpatialReference,t);(0,a.O3)(l);let i={geometry:l.export(),noDataValue:e.options.noDataValue};return e.options.returnSampleInfo&&(i.sampleInfo=function(e){let t=e.layer.tileInfo,l=(0,o.c9)(t.spatialReference);return e.geometry.coordinates.map(i=>{let n=-1;return i.elevationTile&&i.elevationTile!==e.outsideExtentTile&&(n=t.lodAt(i.elevationTile.tile.level).resolution*l),{demResolution:n}})}(e)),e.geometry.coordinates.forEach(e=>{e.tile=null,e.elevationTile=null}),i}function $(e){return null!=e?.tileInfo}}}]);