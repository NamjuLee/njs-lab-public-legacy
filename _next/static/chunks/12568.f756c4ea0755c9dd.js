"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[12568],{18642:function(e,t,s){s.d(t,{Z:function(){return eB}});var r=s(14707),i=s(39931),n=s(47824);let a=n.C9;function o(e,t){return{attribute:e,format:t.size>1?`${t.type}x${t.size}`:t.type,byteOffset:t.offset||0}}function l(e){return e.stride||e.size*e.bytesPerElement}var u=s(28763),h=s(41558),c=s(9577);function d(e,t){t.offset&&c.Z.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let s=l(e),r=(void 0!==t.vertexOffset?t.vertexOffset:e.vertexOffset||0)*s+(t.elementOffset||0)*e.bytesPerElement+(e.offset||0);return{...t,offset:r,stride:s}}class f{constructor(e,t,s){let r;this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;let i=t.logicalType||t.type,a="float64"===i,{defaultValue:o}=t;o=Number.isFinite(o)?[o]:o||Array(this.size).fill(0),r=a?"float32":!i&&t.isIndexed?"uint32":i||"float32";let l=function(e){switch(e){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return(0,n.Xs)(e)}}(i||r);this.doublePrecision=a,a&&!1===t.fp64&&(l=Float32Array),this.value=null,this.settings={...t,defaultType:l,defaultValue:o,logicalType:i,type:r,normalized:r.includes("norm"),size:this.size,bytesPerElement:l.BYTES_PER_ELEMENT},this.state={...s,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){let e=this.getAccessor();return e.vertexOffset?e.vertexOffset*l(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),u.Z.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){let s={};if(this.state.constant){let r=this.value;if(t){let i=d(this.getAccessor(),t),n=i.offset/r.BYTES_PER_ELEMENT,a=i.size||this.size;s[e]=r.subarray(n,n+a)}else s[e]=r}else s[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?s[`${e}64Low`]=s[e]:s[`${e}64Low`]=new Float32Array(this.size)),s}_getBufferLayout(e=this.id,t=null){let s=this.getAccessor(),r=[],i={name:this.id,byteStride:l(s),attributes:r};if(this.doublePrecision){let i=function(e,t){let s=d(e,t);return{high:s,low:{...s,offset:s.offset+4*e.size}}}(s,t||{});r.push(o(e,{...s,...i.high}),o(`${e}64Low`,{...s,...i.low}))}else if(t){let i=d(s,t);r.push(o(e,{...s,...i}))}else r.push(o(e,s));return i}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){let t=Array.from(this.value);e=[t,t]}else{let{value:t,numInstances:s,size:r}=this,i=s*r;if(t&&i&&t.length>=i){let s=Array(r).fill(1/0),n=Array(r).fill(-1/0);for(let e=0;e<i;)for(let i=0;i<r;i++){let r=t[e++];r<s[i]&&(s[i]=r),r>n[i]&&(n[i]=r)}e=[s,n]}}return this.state.bounds=e,e}setData(e){let t;let{state:s}=this;t=ArrayBuffer.isView(e)?{value:e}:e instanceof r.l?{buffer:e}:e;let i={...this.settings,...t};if(ArrayBuffer.isView(t.value)){if(!t.type){if(this.doublePrecision&&t.value instanceof Float64Array)i.type="float32";else{let e=a(t.value);i.type=i.normalized?e.replace("int","norm"):e}}i.bytesPerElement=t.value.BYTES_PER_ELEMENT,i.stride=l(i)}if(s.bounds=null,t.constant){let e=t.value;if(e=this._normalizeValue(e,[],0),this.settings.normalized&&(e=this.normalizeConstant(e)),!(!s.constant||!this._areValuesEqual(e,this.value)))return!1;s.externalBuffer=null,s.constant=!0,this.value=ArrayBuffer.isView(e)?e:new Float32Array(e)}else if(t.buffer){let e=t.buffer;s.externalBuffer=e,s.constant=!1,this.value=t.value||null}else if(t.value){this._checkExternalBuffer(t);let e=t.value;s.externalBuffer=null,s.constant=!1,this.value=e;let{buffer:r}=this,n=l(i),a=(i.vertexOffset||0)*n;if(this.doublePrecision&&e instanceof Float64Array&&(e=(0,h.TK)(e,i)),this.settings.isIndexed){let t=this.settings.defaultType;e.constructor!==t&&(e=new t(e))}let o=e.byteLength+a+2*n;(!r||r.byteLength<o)&&(r=this._createBuffer(o)),r.write(e,a)}return this.setAccessor(i),!0}updateSubBuffer(e={}){this.state.bounds=null;let t=this.value,{startOffset:s=0,endOffset:r}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?(0,h.TK)(t,{size:this.size,startIndex:s,endIndex:r}):t.subarray(s,r),s*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){let{state:s}=this,r=s.allocatedValue,i=u.Z.allocate(r,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=i;let{byteOffset:n}=this,{buffer:a}=this;return(!a||a.byteLength<i.byteLength+n)&&(a=this._createBuffer(i.byteLength+n),t&&r&&a.write(r instanceof Float64Array?(0,h.TK)(r,this):r,n)),s.allocatedValue=i,s.constant=!1,s.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){let{value:t}=e;if(!ArrayBuffer.isView(t))throw Error(`Attribute ${this.id} value is not TypedArray`);let s=this.settings.defaultType,r=!1;if(this.doublePrecision&&(r=t.BYTES_PER_ELEMENT<4),r)throw Error(`Attribute ${this.id} does not support ${t.constructor.name}`);t instanceof s||!this.settings.normalized||"normalized"in e||c.Z.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(e=>(e+128)/255*2-1);case"snorm16":return new Float32Array(e).map(e=>(e+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(e=>e/255);case"unorm16":return new Float32Array(e).map(e=>e/65535);default:return e}}_normalizeValue(e,t,s){let{defaultValue:r,size:i}=this.settings;if(Number.isFinite(e))return t[s]=e,t;if(!e){let e=i;for(;--e>=0;)t[s+e]=r[e];return t}switch(i){case 4:t[s+3]=Number.isFinite(e[3])?e[3]:r[3];case 3:t[s+2]=Number.isFinite(e[2])?e[2]:r[2];case 2:t[s+1]=Number.isFinite(e[1])?e[1]:r[1];case 1:t[s+0]=Number.isFinite(e[0])?e[0]:r[0];break;default:let n=i;for(;--n>=0;)t[s+n]=Number.isFinite(e[n])?e[n]:r[n]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;let{size:s}=this;for(let r=0;r<s;r++)if(e[r]!==t[r])return!1;return!0}_createBuffer(e){this._buffer&&this._buffer.destroy();let{isIndexed:t,type:s}=this.settings;return this._buffer=this.device.createBuffer({...this._buffer?.props,id:this.id,usage:t?r.l.INDEX:r.l.VERTEX,indexType:t?s:void 0,byteLength:e}),this._buffer}}var p=s(56435);let _=[],g=[];function m(e){return e&&e[Symbol.asyncIterator]}var y=s(86433);let b=[],v=[[0,1/0]],w={interpolation:{duration:0,easing:e=>e},spring:{stiffness:.05,damping:.5}};function x(e,t){if(!e)return null;Number.isFinite(e)&&(e={type:"interpolation",duration:e});let s=e.type||"interpolation";return{...w[s],...t,...e,type:s}}class k extends f{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:v}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){let t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t;this.state.layoutChanged||=(t=this.getAccessor(),e.type!==t.type||e.size!==t.size||l(e)!==l(t)||(e.offset||0)!==(t.offset||0)),super.setAccessor(e)}getUpdateTriggers(){let{accessor:e}=this.settings;return[this.id].concat("function"!=typeof e&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;let{accessor:t}=this.settings,s=this.settings.transition;return x(Array.isArray(t)?e[t.find(t=>e[t])]:e[t],s)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){let{startRow:e=0,endRow:s=1/0}=t;this.state.updateRanges=function(e,t){if(e===v||(t[0]<0&&(t[0]=0),t[0]>=t[1]))return e;let s=[],r=e.length,i=0;for(let n=0;n<r;n++){let r=e[n];r[1]<t[0]?(s.push(r),i=n+1):r[0]>t[1]?s.push(r):t=[Math.min(r[0],t[0]),Math.max(r[1],t[1])]}return s.splice(i,0,t),s}(this.state.updateRanges,[e,s])}else this.state.updateRanges=v}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=b}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){let{state:t,settings:s}=this;return!s.noAlloc&&!!s.update&&(super.allocate(e,t.updateRanges!==v),!0)}updateBuffer({numInstances:e,data:t,props:s,context:r}){if(!this.needsUpdate())return!1;let{state:{updateRanges:i},settings:{update:n,noAlloc:a}}=this,o=!0;if(n){for(let[a,o]of i)n.call(r,this,{data:t,startRow:a,endRow:o,props:s,numInstances:e});if(this.value){if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[t,s]of i){let r=Number.isFinite(t)?this.getVertexOffset(t):0,i=Number.isFinite(s)?this.getVertexOffset(s):a||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:r,endOffset:i})}}this._checkAttributeArray()}else o=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),o}setConstantValue(e){return void 0!==e&&"function"!=typeof e&&(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){let{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e),!0)):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){let{state:s,settings:r}=this;if(!e)return s.binaryValue=null,s.binaryAccessor=null,!1;if(r.noAlloc)return!1;if(s.binaryValue===e)return this.clearNeedsUpdate(),!0;if(s.binaryValue=e,this.setNeedsRedraw(),r.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});let i=e;(0,p.Z)(ArrayBuffer.isView(i.value),`invalid ${r.accessor}`);let n=!!i.size&&i.size!==this.size;return s.binaryAccessor=function(e,t){let{size:s,stride:r,offset:i,startIndices:n,nested:a}=t,o=e.BYTES_PER_ELEMENT,l=r?r/o:s,u=i?i/o:0,h=Math.floor((e.length-u)/l);return(t,{index:r,target:i})=>{let o;if(!n){let t=r*l+u;for(let r=0;r<s;r++)i[r]=e[t+r];return i}let c=n[r],d=n[r+1]||h;if(a){o=Array(d-c);for(let t=c;t<d;t++){let r=t*l+u;i=Array(s);for(let t=0;t<s;t++)i[t]=e[r+t];o[t-c]=i}}else if(l===s)o=e.subarray(c*s+u,d*s+u);else{o=new e.constructor((d-c)*s);let t=0;for(let r=c;r<d;r++){let i=r*l+u;for(let r=0;r<s;r++)o[t++]=e[i+r]}}return o}}(i.value,{size:i.size||this.size,stride:i.stride,offset:i.offset,startIndices:t,nested:n}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){let{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){let e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(let s in e)Object.assign(t,super.getValue(s,e[s]));return t}getBufferLayout(e){this.state.layoutChanged=!1;let t=this.settings.shaderAttributes,s=super._getBufferLayout(),{stepMode:r}=this.settings;if("dynamic"===r?s.stepMode=e?e.isInstanced?"instance":"vertex":"instance":s.stepMode=r??"vertex",!t)return s;for(let e in t){let r=super._getBufferLayout(e,t[e]);s.attributes.push(...r.attributes)}return s}_autoUpdater(e,{data:t,startRow:s,endRow:r,props:i,numInstances:n}){if(e.constant)return;let{settings:a,state:o,value:l,size:u,startIndices:h}=e,{accessor:c,transform:d}=a,f=o.binaryAccessor||("function"==typeof c?c:i[c]);(0,p.Z)("function"==typeof f,`accessor "${c}" is not a function`);let m=e.getVertexOffset(s),{iterable:b,objectInfo:v}=function(e,t=0,s=1/0){let r=_,i={index:-1,data:e,target:[]};return e?"function"==typeof e[Symbol.iterator]?r=e:e.length>0&&(g.length=e.length,r=g):r=_,(t>0||Number.isFinite(s))&&(r=(Array.isArray(r)?r:Array.from(r)).slice(t,s),i.index=t-1),{iterable:r,objectInfo:i}}(t,s,r);for(let t of b){v.index++;let s=f(t,v);if(d&&(s=d.call(this,s)),h){let t=(v.index<h.length-1?h[v.index+1]:n)-h[v.index];if(s&&Array.isArray(s[0])){let t=m;for(let r of s)e._normalizeValue(r,l,t),t+=u}else s&&s.length>u?l.set(s,m):(e._normalizeValue(s,v.target,0),(0,y.k)({target:l,source:v.target,start:m,count:t}));m+=t*u}else e._normalizeValue(s,l,m),m+=u}}_validateAttributeUpdaters(){let{settings:e}=this;if(!(e.noAlloc||"function"==typeof e.update))throw Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){let{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let s=!0;switch(t){case 4:s=s&&Number.isFinite(e[3]);case 3:s=s&&Number.isFinite(e[2]);case 2:s=s&&Number.isFinite(e[1]);case 1:s=s&&Number.isFinite(e[0]);break;default:s=!1}if(!s)throw Error(`Illegal attribute generated for ${this.id}`)}}}var A=s(98),T=s(51116),P=s(58859);let S=`\
out vec4 transform_output;
void main() {
transform_output = vec4(0);
}`,C=`#version 300 es
${S}`;var E=s(87444);class I{device;model;transformFeedback;static isSupported(e){return e?.info?.type==="webgl"}constructor(e,t=E.H.defaultProps){(0,P.h)(I.isSupported(e),"BufferTransform not yet implemented on WebGPU"),this.device=e,this.model=new E.H(this.device,{id:t.id||"buffer-transform-model",fs:t.fs||function(e){let{input:t,inputChannels:s,output:r}={};if(!t)return C;if(!s)throw Error("inputChannels");let i=function(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw Error(`invalid channels: ${e}`)}}(s),n=function(e,t){switch(t){case 1:return`vec4(${e}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${e}, 0.0, 1.0)`;case 3:return`vec4(${e}, 1.0)`;case 4:return e;default:throw Error(`invalid channels: ${t}`)}}(t,s);return`\
#version 300 es
in ${i} ${t};
out vec4 ${r};
void main() {
  ${r} = ${n};
}`}(),topology:t.topology||"point-list",...t}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:t.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){let t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}update(...e){console.warn("TextureTransform#update() not implemented")}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){let t=this.getBuffer(e);if(t instanceof r.l)return t.readAsync();let{buffer:s,byteOffset:i=0,byteLength:n=s.byteLength}=t;return s.readAsync(i,n)}}function L(e,t=[],s=0){let r=Math.fround(e),i=e-r;return t[s]=r,t[s+1]=i,t}let O={ONE:1},R={name:"fp64-arithmetic",vs:`\
uniform float ONE;
vec2 split(float a) {
const float SPLIT = 4097.0;
float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
float a_hi = t * ONE - (t - a);
float a_lo = a * ONE - a_hi;
#else
float a_hi = t - (t - a);
float a_lo = a - a_hi;
#endif
return vec2(a_hi, a_lo);
}
vec2 split2(vec2 a) {
vec2 b = split(a.x);
b.y += a.y;
return b;
}
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
float sum = (a + b) * ONE;
float err = b - (sum - a) * ONE;
#else
float sum = a + b;
float err = b - (sum - a);
#endif
return vec2(sum, err);
}
vec2 twoSum(float a, float b) {
float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
float v = (s * ONE - a) * ONE;
float err = (a - (s - v) * ONE) * ONE * ONE * ONE + (b - v);
#else
float v = s - a;
float err = (a - (s - v)) + (b - v);
#endif
return vec2(s, err);
}
vec2 twoSub(float a, float b) {
float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
float v = (s * ONE - a) * ONE;
float err = (a - (s - v) * ONE) * ONE * ONE * ONE - (b + v);
#else
float v = s - a;
float err = (a - (s - v)) - (b + v);
#endif
return vec2(s, err);
}
vec2 twoSqr(float a) {
float prod = a * a;
vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
float err = ((a_fp64.x * a_fp64.x - prod) * ONE + 2.0 * a_fp64.x *
a_fp64.y * ONE * ONE) + a_fp64.y * a_fp64.y * ONE * ONE * ONE;
#else
float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
return vec2(prod, err);
}
vec2 twoProd(float a, float b) {
float prod = a * b;
vec2 a_fp64 = split(a);
vec2 b_fp64 = split(b);
float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
return vec2(prod, err);
}
vec2 sum_fp64(vec2 a, vec2 b) {
vec2 s, t;
s = twoSum(a.x, b.x);
t = twoSum(a.y, b.y);
s.y += t.x;
s = quickTwoSum(s.x, s.y);
s.y += t.y;
s = quickTwoSum(s.x, s.y);
return s;
}
vec2 sub_fp64(vec2 a, vec2 b) {
vec2 s, t;
s = twoSub(a.x, b.x);
t = twoSub(a.y, b.y);
s.y += t.x;
s = quickTwoSum(s.x, s.y);
s.y += t.y;
s = quickTwoSum(s.x, s.y);
return s;
}
vec2 mul_fp64(vec2 a, vec2 b) {
vec2 prod = twoProd(a.x, b.x);
prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
prod = split2(prod);
#endif
prod = quickTwoSum(prod.x, prod.y);
prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
prod = split2(prod);
#endif
prod = quickTwoSum(prod.x, prod.y);
return prod;
}
vec2 div_fp64(vec2 a, vec2 b) {
float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
vec2 yn = a * xn;
#endif
float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
vec2 prod = twoProd(xn, diff);
return sum_fp64(yn, prod);
}
vec2 sqrt_fp64(vec2 a) {
if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);
float x = 1.0 / sqrt(a.x);
float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
vec2 yn_sqr = twoSqr(yn) * ONE;
#else
vec2 yn_sqr = twoSqr(yn);
#endif
float diff = sub_fp64(a, yn_sqr).x;
vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
return sum_fp64(split(yn), prod);
#else
return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,getUniforms:function(){return O},fp64ify:L,fp64LowPart:function(e){return e-Math.fround(e)},fp64ifyMatrix4:function(e){let t=new Float32Array(32);for(let s=0;s<4;++s)for(let r=0;r<4;++r){let i=4*s+r;L(e[4*r+s],t,2*i)}return t}};function N(e){let{source:t,target:s,start:r=0,size:i,getData:n}=e,a=e.end||s.length,o=t.length,l=a-r;if(o>l){s.set(t.subarray(0,l),r);return}if(s.set(t,r),!n)return;let u=o;for(;u<l;){let e=n(u,t);for(let t=0;t<i;t++)s[r+u]=e[t]||0,u++}}function U(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw Error(`No defined attribute type for size "${e}"`)}}function M(e){switch(e){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw Error("invalid type size")}}function F(e){e.push(e.shift())}function B({device:e,source:t,target:s}){return(!s||s.byteLength<t.byteLength)&&(s?.destroy(),s=e.createBuffer({byteLength:t.byteLength,usage:t.usage})),s}function z({device:e,buffer:t,attribute:s,fromLength:r,toLength:i,fromStartIndices:n,getData:a=e=>e}){let o=s.doublePrecision&&s.value instanceof Float64Array?2:1,l=s.size*o,u=s.byteOffset,h=s.settings.bytesPerElement<4?u/s.settings.bytesPerElement*4:u,c=s.startIndices,d=n&&c,f=s.isConstant;if(!d&&t&&r>=i)return t;let p=s.value instanceof Float64Array?Float32Array:s.value.constructor,_=f?s.value:new p(s.getBuffer().readSyncWebGL(u,i*p.BYTES_PER_ELEMENT).buffer);if(s.settings.normalized&&!f){let e=a;a=(t,r)=>s.normalizeConstant(e(t,r))}let g=f?(e,t)=>a(_,t):(e,t)=>a(_.subarray(e+u,e+u+l),t),m=new Float32Array(t?t.readSyncWebGL(h,4*r).buffer:0),y=new Float32Array(i);return!function({source:e,target:t,size:s,getData:r,sourceStartIndices:i,targetStartIndices:n}){if(!i||!n)return N({source:e,target:t,size:s,getData:r});let a=0,o=0,l=r&&((e,t)=>r(e+o,t)),u=Math.min(i.length,n.length);for(let r=1;r<u;r++){let u=i[r]*s,h=n[r]*s;N({source:e.subarray(a,u),target:t,start:o,end:h,size:s,getData:l}),a=u,o=h}o<t.length&&N({source:[],target:t,start:o,size:s,getData:l})}({source:m,target:y,sourceStartIndices:n,targetStartIndices:c,size:l,getData:g}),(!t||t.byteLength<y.byteLength+h)&&(t?.destroy(),t=e.createBuffer({byteLength:y.byteLength+h,usage:35050})),t.write(y,h),t}var j=s(16451);class D{constructor({device:e,attribute:t,timeline:s}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new j.Z(s),this.attribute=t,this.attributeInTransition=function(e){let{device:t,settings:s,value:r}=e,i=new k(t,s);return i.setData({value:r instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:s.normalized}),i}(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,s=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=function(e,t){let{doublePrecision:s,settings:r,value:i,size:n}=e,a=s&&i instanceof Float64Array?2:1,o=0,{shaderAttributes:l}=e.settings;if(l)for(let e of Object.values(l))o=Math.max(o,e.vertexOffset??0);return(r.noAlloc?i.length:(t+o)*n)*a}(this.attribute,t),this.transition.start({...e,duration:s})}update(){let e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){for(let e of(this.cancel(),this.buffers))e.destroy();this.buffers.length=0}}class V extends D{constructor({device:e,attribute:t,timeline:s}){super({device:e,attribute:t,timeline:s}),this.type="interpolation",this.transform=function(e,t){let s=t.size,r=U(s),i=M(s),n=t.getBufferLayout();return G(t)?new I(e,{vs:$,bufferLayout:[{name:"aFrom",byteStride:8*s,attributes:[{attribute:"aFrom",format:i,byteOffset:0},{attribute:"aFrom64Low",format:i,byteOffset:4*s}]},{name:"aTo",byteStride:8*s,attributes:[{attribute:"aTo",format:i,byteOffset:0},{attribute:"aTo64Low",format:i,byteOffset:4*s}]}],modules:[R],defines:{ATTRIBUTE_TYPE:r,ATTRIBUTE_SIZE:s},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new I(e,{vs:q,bufferLayout:[{name:"aFrom",format:i},{name:"aTo",format:n.attributes[0].format}],defines:{ATTRIBUTE_TYPE:r},varyings:["vCurrent"],disableWarnings:!0})}(e,t)}start(e,t){let s=this.currentLength,r=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0){this.transition.cancel();return}let{buffers:i,attribute:n}=this;F(i),i[0]=z({device:this.device,buffer:i[0],attribute:n,fromLength:s,toLength:this.currentLength,fromStartIndices:r,getData:e.enter}),i[1]=B({device:this.device,source:i[0],target:i[1]}),this.setBuffer(i[1]);let{transform:a}=this,o=a.model,l=Math.floor(this.currentLength/n.size);G(n)&&(l/=2),o.setVertexCount(l),n.isConstant?(o.setAttributes({aFrom:i[0]}),o.setConstantAttributes({aTo:n.value})):o.setAttributes({aFrom:i[0],aTo:n.getBuffer()}),a.transformFeedback.setBuffers({vCurrent:i[1]})}onUpdate(){let{duration:e,easing:t}=this.settings,{time:s}=this.transition,r=s/e;t&&(r=t(r));let{model:i}=this.transform;i.setUniforms({time:r}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}let q=`\
#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`,$=`\
#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function G(e){return e.doublePrecision&&e.value instanceof Float64Array}class Z extends D{constructor({device:e,attribute:t,timeline:s}){var r;super({device:e,attribute:t,timeline:s}),this.type="spring",this.texture=e.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1}),this.framebuffer=(r=this.texture,e.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[r]})),this.transform=function(e,t){let s=U(t.size),r=M(t.size);return new I(e,{vs:W,fs:H,bufferLayout:[{name:"aPrev",format:r},{name:"aCur",format:r},{name:"aTo",format:t.getBufferLayout().attributes[0].format}],varyings:["vNext"],defines:{ATTRIBUTE_TYPE:s},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}(e,t)}start(e,t){let s=this.currentLength,r=this.currentStartIndices;super.start(e,t);let{buffers:i,attribute:n}=this;for(let t=0;t<2;t++)i[t]=z({device:this.device,buffer:i[t],attribute:n,fromLength:s,toLength:this.currentLength,fromStartIndices:r,getData:e.enter});i[2]=B({device:this.device,source:i[0],target:i[2]}),this.setBuffer(i[1]);let{model:a}=this.transform;a.setVertexCount(Math.floor(this.currentLength/n.size)),n.isConstant?a.setConstantAttributes({aTo:n.value}):a.setAttributes({aTo:n.getBuffer()})}onUpdate(){let{buffers:e,transform:t,framebuffer:s,transition:r}=this,i=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]}),t.model.setUniforms({stiffness:i.stiffness,damping:i.damping}),t.run({framebuffer:s,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),F(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(s)[0]>0||r.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}let W=`\
#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,H=`\
#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`,Y={interpolation:V,spring:Z};class K{constructor(e,{id:t,timeline:s}){if(!e)throw Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=s,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(let e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:s}){for(let r in this.numInstances=s||1,e){let s=e[r],i=s.getTransitionSetting(t);i&&this._updateAttribute(r,s,i)}for(let s in this.transitions){let r=e[s];r&&r.getTransitionSetting(t)||this._removeTransition(s)}}hasAttribute(e){let t=this.transitions[e];return t&&t.inProgress}getAttributes(){let e={};for(let t in this.transitions){let s=this.transitions[t];s.inProgress&&(e[t]=s.attributeInTransition)}return e}run(){if(0===this.numInstances)return!1;for(let e in this.transitions)this.transitions[e].update()&&(this.needsRedraw=!0);let e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,s){let r=this.transitions[e],i=!r||r.type!==s.type;if(i){r&&this._removeTransition(e);let n=Y[s.type];n?this.transitions[e]=new n({attribute:t,timeline:this.timeline,device:this.device}):(c.Z.error(`unsupported transition type '${s.type}'`)(),i=!1)}(i||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(s,this.numInstances))}}let X="attributeManager.invalidate";class J{constructor(e,{id:t="attribute-manager",stats:s,timeline:r}={}){this.mergeBoundsMemoized=(0,A.Z)(h.cc),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=s,this.attributeTransitionManager=new K(e,{id:`${t}-transitions`,timeline:r}),Object.seal(this)}finalize(){for(let e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){let t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(let t of e)void 0!==this.attributes[t]&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){let s=this._invalidateTrigger(e,t);(0,T.Z)(X,this,e,s)}invalidateAll(e){for(let t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);(0,T.Z)(X,this,"all")}update({data:e,numInstances:t,startIndices:s=null,transitions:r,props:i={},buffers:n={},context:a={}}){let o=!1;for(let r in(0,T.Z)("attributeManager.updateStart",this),this.stats&&this.stats.get("Update Attributes").timeStart(),this.attributes){let l=this.attributes[r],u=l.settings.accessor;l.startIndices=s,l.numInstances=t,i[r]&&c.Z.removed(`props.${r}`,`data.attributes.${r}`)(),l.setExternalBuffer(n[r])||l.setBinaryValue("string"==typeof u?n[u]:void 0,e.startIndices)||"string"==typeof u&&!n[u]&&l.setConstantValue(i[u])||l.needsUpdate()&&(o=!0,this._updateAttribute({attribute:l,numInstances:t,data:e,props:i,context:a})),this.needsRedraw=this.needsRedraw||l.needsRedraw()}o&&(0,T.Z)("attributeManager.updateEnd",this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:r})}updateTransition(){let{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){let t=e.map(e=>this.attributes[e]?.getBounds());return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){let{attributes:t,attributeTransitionManager:s}=this,r={...s.getAttributes()};for(let i in t){let n=t[i];n.needsRedraw(e)&&!s.hasAttribute(i)&&(r[i]=n)}return r}getBufferLayouts(e){return Object.values(this.getAttributes()).map(t=>t.getBufferLayout(e))}_add(e,t){for(let s in e){let r=e[s],i={...r,id:s,size:r.isIndexed&&1||r.size||1,...t};this.attributes[s]=new k(this.device,i)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){let e={};for(let t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(s=>{e[s]||(e[s]=[]),e[s].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){let{attributes:s,updateTriggers:r}=this,i=r[e];return i&&i.forEach(e=>{let r=s[e];r&&r.setNeedsUpdate(r.id,t)}),i}_updateAttribute(e){let{attribute:t,numInstances:s}=e;if((0,T.Z)("attribute.updateStart",t),t.constant){t.setConstantValue(t.value);return}t.allocate(s)&&(0,T.Z)("attribute.allocate",t,s),t.updateBuffer(e)&&(this.needsRedraw=!0,(0,T.Z)("attribute.updateEnd",t,s))}}var Q=s(99764);class ee extends j.Z{get value(){return this._value}_onUpdate(){let{time:e,settings:{fromValue:t,toValue:s,duration:r,easing:i}}=this,n=i(e/r);this._value=(0,Q.t7)(t,s,n)}}function et(e,t,s,r,i){let n=t-e;return(s-t)*i+-n*r+n+t}function es(e,t){if(Array.isArray(e)){let s=0;for(let r=0;r<e.length;r++){let i=e[r]-t[r];s+=i*i}return Math.sqrt(s)}return Math.abs(e-t)}class er extends j.Z{get value(){return this._currValue}_onUpdate(){let{fromValue:e,toValue:t,damping:s,stiffness:r}=this.settings,{_prevValue:i=e,_currValue:n=e}=this,a=function(e,t,s,r,i){if(Array.isArray(s)){let n=[];for(let a=0;a<s.length;a++)n[a]=et(e[a],t[a],s[a],r,i);return n}return et(e,t,s,r,i)}(i,n,t,s,r),o=es(a,t),l=es(a,n);o<1e-5&&l<1e-5&&(a=t,this.end()),this._prevValue=n,this._currValue=a}}let ei={interpolation:ee,spring:er};class en{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,s,r){let{transitions:i}=this;if(i.has(e)){let s=i.get(e),{value:r=s.settings.fromValue}=s;t=r,this.remove(e)}if(!(r=x(r)))return;let n=ei[r.type];if(!n){c.Z.error(`unsupported transition type '${r.type}'`)();return}let a=new n(this.timeline);a.start({...r,fromValue:t,toValue:s}),i.set(e,a)}remove(e){let{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){let e={};for(let[t,s]of this.transitions)s.update(),e[t]=s.value,s.inProgress||this.remove(t);return e}clear(){for(let e of this.transitions.keys())this.remove(e)}}var ea=s(22296);function eo({newProps:e,oldProps:t,ignoreProps:s={},propTypes:r={},triggerName:i="props"}){if(t===e)return!1;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return`${i} changed shallowly`;for(let n of Object.keys(e))if(!(n in s)){if(!(n in t))return`${i}.${n} added`;let s=el(e[n],t[n],r[n]);if(s)return`${i}.${n} ${s}`}for(let n of Object.keys(t))if(!(n in s)){if(!(n in e))return`${i}.${n} dropped`;if(!Object.hasOwnProperty.call(e,n)){let s=el(e[n],t[n],r[n]);if(s)return`${i}.${n} ${s}`}}return!1}function el(e,t,s){let r=s&&s.equal;return r&&!r(e,t,s)||!r&&(r=e&&t&&e.equals)&&!r.call(e,t)?"changed deeply":r||t===e?null:"changed shallowly"}function eu(e,t,s){let r=e.updateTriggers[s];r=null==r?{}:r;let i=t.updateTriggers[s];return eo({oldProps:i=null==i?{}:i,newProps:r,triggerName:s})}function eh(e,t){if(!t)return e;let s={...e,...t};if("defines"in t&&(s.defines={...e.defines,...t.defines}),"modules"in t&&(s.modules=(e.modules||[]).concat(t.modules),t.modules.some(e=>"project64"===e.name))){let e=s.modules.findIndex(e=>"project32"===e.name);e>=0&&s.modules.splice(e,1)}if("inject"in t){if(e.inject){let r={...e.inject};for(let e in t.inject)r[e]=(r[e]||"")+t.inject[e];s.inject=r}else s.inject=t.inject}return s}var ec=s(57723),ed=s(38634),ef=s(87185),ep=s(39729),e_=s(65486);let eg=[0,0,0];function em(e,t,s=!1){let r=t.projectPosition(e);if(s&&t instanceof ed.Z){let[s,i,n=0]=e,a=t.getDistanceScales([s,i]);r[2]=n*a.unitsPerMeter[2]}return r}function ey(e,{viewport:t,modelMatrix:s,coordinateSystem:r,coordinateOrigin:n,offsetMode:a}){let[o,l,u=0]=e;switch(s&&([o,l,u]=ef.fF([],[o,l,u,1],s)),r){case i.Df.LNGLAT:return em([o,l,u],t,a);case i.Df.LNGLAT_OFFSETS:return em([o+n[0],l+n[1],u+(n[2]||0)],t,a);case i.Df.METER_OFFSETS:return em((0,e_.eG)(n,[o,l,u]),t,a);case i.Df.CARTESIAN:default:return t.isGeospatial?[o+n[0],l+n[1],u+n[2]]:t.projectPosition([o,l,u])}}var eb=s(33609);let ev={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},ew={};var ex=s(94791);let ek={boolean:{validate:(e,t)=>!0,equal:(e,t,s)=>!!e==!!t},number:{validate:(e,t)=>Number.isFinite(e)&&(!("max"in t)||e<=t.max)&&(!("min"in t)||e>=t.min)},color:{validate:(e,t)=>t.optional&&!e||eT(e)&&(3===e.length||4===e.length),equal:(e,t,s)=>(0,ex.v)(e,t,1)},accessor:{validate(e,t){let s=eP(e);return"function"===s||s===eP(t.value)},equal:(e,t,s)=>"function"==typeof t||(0,ex.v)(e,t,1)},array:{validate:(e,t)=>t.optional&&!e||eT(e),equal(e,t,s){let{compare:r}=s,i=Number.isInteger(r)?r:r?1:0;return r?(0,ex.v)(e,t,i):e===t}},object:{equal(e,t,s){if(s.ignore)return!0;let{compare:r}=s,i=Number.isInteger(r)?r:r?1:0;return r?(0,ex.v)(e,t,i):e===t}},function:{validate:(e,t)=>t.optional&&!e||"function"==typeof e,equal:(e,t,s)=>!s.compare&&!1!==s.ignore||e===t},data:{transform:(e,t,s)=>{if(!e)return e;let{dataTransform:r}=s.props;return r?r(e):"string"==typeof e.shape&&e.shape.endsWith("-table")&&Array.isArray(e.data)?e.data:e}},image:{transform:(e,t,s)=>{let r=s.context;return r&&r.device?function(e,t,s,r){if(s instanceof eb.x)return s;s.constructor&&"Object"!==s.constructor.name&&(s={data:s});let i=null;s.compressed&&(i={minFilter:"linear",mipmapFilter:s.data.length>1?"nearest":"linear"});let n=t.createTexture({...s,sampler:{...ev,...i,...r}});return ew[n.id]=e,n}(s.id,r.device,e,{...t.parameters,...s.props.textureParameters}):null},release:(e,t,s)=>{var r;r=s.id,e&&e instanceof eb.x&&ew[e.id]===r&&(e.delete(),delete ew[e.id])}}};function eA(e,t){return"type"in t?{name:e,...ek[t.type],...t}:"value"in t?{name:e,type:eP(t.value),...t}:{name:e,type:"object",value:t}}function eT(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function eP(e){return eT(e)?"array":null===e?"null":typeof e}function eS(e,t){return Object.prototype.hasOwnProperty.call(e,t)}let eC=0;class eE{static{this.componentName="Component"}static{this.defaultProps={}}constructor(...e){this.props=function(e,t){let s;for(let e=t.length-1;e>=0;e--){let r=t[e];"extensions"in r&&(s=r.extensions)}let r=Object.create(function e(t,s){var r;let i="_mergedDefaultProps";if(s)for(let e of s){let t=e.constructor;t&&(i+=`:${t.extensionName||t.name}`)}return eS(t,r=i)&&t[r]||(t[i]=function(t,s){var r,i;if(!t.prototype)return null;let n=e(Object.getPrototypeOf(t)),a=function(e){let t={},s={},r={};for(let[i,n]of Object.entries(e)){let e=n?.deprecatedFor;if(e)r[i]=Array.isArray(e)?e:[e];else{let e=function(e,t){switch(eP(t)){case"object":return eA(e,t);case"array":return eA(e,{type:"array",value:t,compare:!1});case"boolean":return eA(e,{type:"boolean",value:t});case"number":return eA(e,{type:"number",value:t});case"function":return eA(e,{type:"function",value:t,compare:!0});default:return{name:e,type:"unknown",value:t}}}(i,n);t[i]=e,s[i]=e.value}}return{propTypes:t,defaultProps:s,deprecatedProps:r}}((i="defaultProps",eS(r=t,i)&&r[i]||{})),o=Object.assign(Object.create(null),n,a.defaultProps),l=Object.assign(Object.create(null),n?.[ea.Wb],a.propTypes),u=Object.assign(Object.create(null),n?.[ea.E7],a.deprecatedProps);for(let t of s){let s=e(t.constructor);s&&(Object.assign(o,s),Object.assign(l,s[ea.Wb]),Object.assign(u,s[ea.E7]))}return Object.defineProperties(o,{id:{writable:!0,value:function(e){let t=e.componentName;return t||c.Z.warn(`${e.name}.componentName not specified`)(),t||e.name}(t)}}),function(e,t){let s={},r={};for(let e in t){let i=t[e],{name:n,value:a}=i;i.async&&(s[n]=a,r[n]=function(e){return{enumerable:!0,set(t){"string"==typeof t||t instanceof Promise||m(t)?this[ea.fO][e]=t:this[ea.bN][e]=t},get(){if(this[ea.bN]){if(e in this[ea.bN])return this[ea.bN][e]||this[ea.lY][e];if(e in this[ea.fO]){let t=this[ea.fm]&&this[ea.fm].internalState;if(t&&t.hasAsyncProp(e))return t.getAsyncProp(e)||this[ea.lY][e]}}return this[ea.lY][e]}}}(n))}e[ea.lY]=s,e[ea.fO]={},Object.defineProperties(e,r)}(o,l),function(e,t){for(let s in t)Object.defineProperty(e,s,{enumerable:!1,set(e){let r=`${this.id}: ${s}`;for(let r of t[s])eS(this,r)||(this[r]=e);c.Z.deprecated(r,t[s].join("/"))()}})}(o,u),o[ea.Wb]=l,o[ea.E7]=u,0!==s.length||eS(t,"_propTypes")||(t._propTypes=l),o}(t,s||[]))}(e.constructor,s));r[ea.fm]=e,r[ea.fO]={},r[ea.bN]={};for(let e=0;e<t.length;++e){let s=t[e];for(let e in s)r[e]=s[e]}return Object.freeze(r),r}(this,e),this.id=this.props.id,this.count=eC++}clone(e){let{props:t}=this,s={};for(let e in t[ea.lY])e in t[ea.bN]?s[e]=t[ea.bN][e]:e in t[ea.fO]&&(s[e]=t[ea.fO][e]);return new this.constructor({...t,...s,...e})}}let eI=Object.freeze({});class eL{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let e in this.asyncProps){let t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||eI}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){let t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){let t=this.asyncProps[e];return!!(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(let e in this.asyncProps)if(this.isAsyncPropLoading(e))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[ea.fm]||this.component;let t=e[ea.bN]||{},s=e[ea.fO]||e,r=e[ea.lY]||{};for(let e in t){let s=t[e];this._createAsyncPropData(e,r[e]),this._updateAsyncProp(e,s),t[e]=this.getAsyncProp(e)}for(let e in s){let t=s[e];this._createAsyncPropData(e,r[e]),this._updateAsyncProp(e,t)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(this._didAsyncInputValueChange(e,t)){if("string"==typeof t&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(m(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps)for(let e in this.oldAsyncProps=Object.create(this.oldProps),this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}_didAsyncInputValueChange(e,t){let s=this.asyncProps[e];return t!==s.resolvedValue&&t!==s.lastValue&&(s.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();let s=this.asyncProps[e];s&&(t=this._postProcessValue(s,t),s.resolvedValue=t,s.pendingLoadCount++,s.resolvedLoadCount=s.pendingLoadCount)}_setAsyncPropValue(e,t,s){let r=this.asyncProps[e];r&&s>=r.resolvedLoadCount&&void 0!==t&&(this._freezeAsyncOldProps(),r.resolvedValue=t,r.resolvedLoadCount=s,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){let s=this.asyncProps[e];if(s){s.pendingLoadCount++;let r=s.pendingLoadCount;t.then(t=>{this.component&&(t=this._postProcessValue(s,t),this._setAsyncPropValue(e,t,r),this._onResolve(e,t))}).catch(t=>{this._onError(e,t)})}}async _resolveAsyncIterable(e,t){if("data"!==e){this._setPropValue(e,t);return}let s=this.asyncProps[e];if(!s)return;s.pendingLoadCount++;let r=s.pendingLoadCount,i=[],n=0;for await(let s of t){if(!this.component)return;let{dataTransform:t}=this.component.props;Object.defineProperty(i=t?t(s,i):i.concat(s),"__diff",{enumerable:!1,value:[{startRow:n,endRow:i.length}]}),n=i.length,this._setAsyncPropValue(e,i,r)}this._onResolve(e,i)}_postProcessValue(e,t){let s=e.type;return s&&this.component&&(s.release&&s.release(e.resolvedValue,s,this.component),s.transform)?s.transform(t,s,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){let s=this.component&&this.component.props[ea.Wb];this.asyncProps[e]={type:s&&s[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class eO extends eL{constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){let s=this.layer,r=s?.props.fetch;return r?r(t,{propName:e,layer:s}):super._fetch(e,t)}_onResolve(e,t){let s=this.layer;if(s){let r=s.props.onDataLoad;"data"===e&&r&&r(t,{propName:e,layer:s})}}_onError(e,t){let s=this.layer;s&&s.raiseError(t,`loading ${e} of ${this.layer}`)}}var eR=s(2642);let eN=Object.freeze([]),eU=(0,A.Z)(({oldViewport:e,viewport:t})=>e.equals(t)),eM=new Uint8ClampedArray(0),eF={data:{type:"data",value:eN,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:e=>e&&e.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(e,{propName:t,layer:s,loaders:r,loadOptions:i,signal:n})=>{let{resourceManager:a}=s.context;i=i||s.getLoadOptions(),r=r||s.props.loaders,n&&(i={...i,fetch:{...i?.fetch,signal:n}});let o=a.contains(e);return(o||i||(a.add({resourceId:e,data:(0,eR.z)(e,r),persistent:!1}),o=!0),o)?a.subscribe({resourceId:e,onChange:e=>s.internalState?.reloadAsyncProp(t,e),consumerId:s.id,requestId:t}):(0,eR.z)(e,r,i)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:i.Df.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:e})=>[0,-(100*e)]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class eB extends eE{constructor(){super(...arguments),this.internalState=null,this.lifecycle=ea.dt.NO_STATE,this.parent=null}static{this.defaultProps=eF}static{this.layerName="Layer"}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){let e=this.constructor.layerName||this.constructor.name;return`${e}({id: '${this.props.id}'})`}project(e){(0,p.Z)(this.internalState);let t=this.internalState.viewport||this.context.viewport,s=ey(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[r,i,n]=(0,e_.aW)(s,t.pixelProjectionMatrix);return 2===e.length?[r,i]:[r,i,n]}unproject(e){return(0,p.Z)(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){return(0,p.Z)(this.internalState),function(e,t){let{viewport:s,coordinateSystem:r,coordinateOrigin:n,modelMatrix:a,fromCoordinateSystem:o,fromCoordinateOrigin:l}=function(e){let{viewport:t,modelMatrix:s,coordinateOrigin:r}=e,{coordinateSystem:n,fromCoordinateSystem:a,fromCoordinateOrigin:o}=e;return n===i.Df.DEFAULT&&(n=t.isGeospatial?i.Df.LNGLAT:i.Df.CARTESIAN),void 0===a&&(a=n),void 0===o&&(o=r),{viewport:t,coordinateSystem:n,coordinateOrigin:r,modelMatrix:s,fromCoordinateSystem:a,fromCoordinateOrigin:o}}(t),{autoOffset:u=!0}=t,{geospatialOrigin:h=eg,shaderCoordinateOrigin:c=eg,offsetMode:d=!1}=u?(0,ec.v)(s,r,n):{},f=ey(e,{viewport:s,modelMatrix:a,coordinateSystem:o,coordinateOrigin:l,offsetMode:d});if(d){let e=s.projectPosition(h||c);ep.lu(f,f,e)}return f}(e,{viewport:this.internalState.viewport||this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return!!this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){let e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setModuleParameters(e){for(let t of this.getModels())t.updateModuleSettings(e)}setShaderModuleProps(...e){for(let t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){let{coordinateSystem:e}=this.props;return e===i.Df.DEFAULT||e===i.Df.LNGLAT||e===i.Df.CARTESIAN}onHover(e,t){return!!this.props.onHover&&(this.props.onHover(e,t)||!1)}onClick(e,t){return!!this.props.onClick&&(this.props.onClick(e,t)||!1)}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){(0,p.Z)(e instanceof Uint8Array);let[t,s,r]=e;return t+256*s+65536*r-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&void 0!==this.state.numInstances?this.state.numInstances:function(e){if(!(null!==e&&"object"==typeof e))throw Error("count(): argument not an object");if("function"==typeof e.count)return e.count();if(Number.isFinite(e.size))return e.size;if(Number.isFinite(e.length))return e.length;if(null!==e&&"object"==typeof e&&e.constructor===Object)return Object.keys(e).length;throw Error("count(): argument not a container")}(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){return this.getAttributeManager()?.getBounds(["positions","instancePositions"])}getShaders(e){for(let t of(e=eh(e,{disableWarnings:!0,modules:this.context.defaultShaderModules}),this.props.extensions))e=eh(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){let t=this.getAttributeManager(),{dataChanged:s}=e.changeFlags;if(s&&t){if(Array.isArray(s))for(let e of s)t.invalidateAll(e);else t.invalidateAll()}if(t){let{props:s}=e,r=this.internalState.hasPickingBuffer,i=Number.isInteger(s.highlightedObjectIndex)||s.pickable||s.extensions.some(e=>e.getNeedsPickingBuffer.call(this,e));if(r!==i){this.internalState.hasPickingBuffer=i;let{pickingColors:e,instancePickingColors:s}=t.attributes,r=e||s;!r||(i&&r.constant&&(r.constant=!1,t.invalidate(r.id)),r.value||i||(r.constant=!0,r.value=[0,0,0]))}}}finalizeState(e){for(let e of this.getModels())e.destroy();let t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(let t of this.getModels())t.draw(e)}getPickingInfo({info:e,mode:t,sourceLayer:s}){let{index:r}=e;return r>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[r]),e}raiseError(e,t){t&&(e=Error(`${t}: ${e.message}`,{cause:e})),this.props.onError?.(e)||this.context?.onError?.(e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return!!this.internalState&&(this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()))}hasUniformTransition(){return this.internalState?.uniformTransitions.active||!1}activateViewport(e){if(!this.internalState)return;let t=this.internalState.viewport;this.internalState.viewport=e,t&&eU({oldViewport:t,viewport:e})||(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){let t=this.getAttributeManager();t&&("all"===e?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(let s in e)e[s].layoutChanged()&&(t=!0);for(let s of this.getModels())this._setModelAttributes(s,e,t)}_updateAttributes(){let e=this.getAttributeManager();if(!e)return;let t=this.props,s=this.getNumInstances(),r=this.getStartIndices();e.update({data:t.data,numInstances:s,startIndices:r,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});let i=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(i)}_updateAttributeTransition(){let e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){let{uniformTransitions:e}=this.internalState;if(e.active){let t=e.update(),s=Object.create(this.props);for(let e in t)Object.defineProperty(s,e,{value:t[e]});return s}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;let s=Math.floor(eM.length/4);if(this.internalState.usesPickingColorCache=!0,s<t){t>16777215&&c.Z.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")();let e=Math.floor((eM=u.Z.allocate(eM,t,{size:4,copy:!0,maxCount:Math.max(t,16777215)})).length/4),r=[];for(let t=s;t<e;t++)this.encodePickingColor(t,r),eM[4*t+0]=r[0],eM[4*t+1]=r[1],eM[4*t+2]=r[2]}e.value=eM.subarray(0,4*t)}_setModelAttributes(e,t,s=!1){if(!Object.keys(t).length)return;if(s){let s=this.getAttributeManager();e.setBufferLayout(s.getBufferLayouts(e)),t=s.getAttributes()}let i=e.userData?.excludeAttributes||{},n={},a={};for(let s in t){if(i[s])continue;let o=t[s].getValue();for(let i in o){let l=o[i];l instanceof r.l?t[s].settings.isIndexed?e.setIndexBuffer(l):n[i]=l:l&&(a[i]=l)}}e.setAttributes(n),e.setConstantAttributes(a)}disablePickingIndex(e){let t=this.props.data;if(!("attributes"in t)){this._disablePickingIndex(e);return}let{pickingColors:s,instancePickingColors:r}=this.getAttributeManager().attributes,i=s||r,n=i&&t.attributes&&t.attributes[i.id];if(n&&n.value){let s=n.value,r=this.encodePickingColor(e);for(let e=0;e<t.length;e++){let t=i.getVertexOffset(e);s[t]===r[0]&&s[t+1]===r[1]&&s[t+2]===r[2]&&this._disablePickingIndex(e)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){let{pickingColors:t,instancePickingColors:s}=this.getAttributeManager().attributes,r=t||s;if(!r)return;let i=r.getVertexOffset(e),n=r.getVertexOffset(e+1);r.buffer.write(new Uint8Array(n-i),i)}restorePickingColors(){let{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,s=e||t;s&&(this.internalState.usesPickingColorCache&&s.value.buffer!==eM.buffer&&(s.value=eM.subarray(0,s.value.length)),s.updateSubBuffer({startOffset:0}))}_initialize(){(0,p.Z)(!this.internalState),(0,p.Z)(Number.isFinite(this.props.coordinateSystem)),(0,T.Z)("layer.initialize",this);let e=this._getAttributeManager();for(let t of(e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new eO({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(c.Z.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new en(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context),this.props.extensions))t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){(0,T.Z)("layer.matched",this,this===e);let{state:t,internalState:s}=e;this!==e&&(this.internalState=s,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){let e=this.needsUpdate();if((0,T.Z)("layer.update",this,e),!e)return;let t=this.props,s=this.context,r=this.internalState,i=s.viewport,n=this._updateUniformTransition();r.propsInTransition=n,s.viewport=r.viewport||i,this.props=n;try{let e=this._getUpdateParams(),t=this.getModels();if(s.device)this.updateState(e);else try{this.updateState(e)}catch(e){}for(let t of this.props.extensions)t.updateState.call(this,e,t);let r=this.getModels()[0]!==t[0];this._postUpdate(e,r)}finally{s.viewport=i,this.props=t,this._clearChangeFlags(),r.needsUpdate=!1,r.resetOldProps()}}_finalize(){for(let e of((0,T.Z)("layer.finalize",this),this.finalizeState(this.context),this.props.extensions))e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,moduleParameters:t=null,uniforms:s={},parameters:r={}}){this._updateAttributeTransition();let i=this.props,n=this.context;this.props=this.internalState.propsInTransition||i;let a=this.props.opacity;s.opacity=Math.pow(a,1/2.2);try{if(t){let{isActive:e,isAttribute:s}=t.picking;this.setModuleParameters(t),this.setShaderModuleProps({picking:{isActive:e,isAttribute:s}})}let{getPolygonOffset:i}=this.props,a=i&&i(s)||[0,0];for(let e of(n.device.setParametersWebGL({polygonOffset:a}),this.getModels()))e.setParameters(r);n.device.withParametersWebGL(r,()=>{let i={renderPass:e,moduleParameters:t,uniforms:s,parameters:r,context:n};for(let e of this.props.extensions)e.draw.call(this,i,e);this.draw(i)})}finally{this.props=i}}getChangeFlags(){return this.internalState?.changeFlags}setChangeFlags(e){if(!this.internalState)return;let{changeFlags:t}=this.internalState;for(let s in e)if(e[s]){let r=!1;if("dataChanged"===s){let i=e[s],n=t[s];i&&Array.isArray(n)&&(t.dataChanged=Array.isArray(i)?n.concat(i):i,r=!0)}t[s]||(t[s]=e[s],r=!0),r&&(0,T.Z)("layer.changeFlag",this,s,e)}let s=!!(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=s,t.somethingChanged=s||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){let s=function(e,t){let s=eo({newProps:e,oldProps:t,propTypes:e[ea.Wb],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),r=function(e,t){if(null===t)return"oldProps is null, initial diff";let s=!1,{dataComparator:r,_dataDiff:i}=e;return r?r(e.data,t.data)||(s="Data comparator detected a change"):e.data!==t.data&&(s="A new data container was supplied"),s&&i&&(s=i(e.data,t.data)||s),s}(e,t),i=!1;return r||(i=function(e,t){if(null===t||"all"in e.updateTriggers&&eu(e,t,"all"))return{all:!0};let s={},r=!1;for(let i in e.updateTriggers)"all"!==i&&eu(e,t,i)&&(s[i]=!0,r=!0);return!!r&&s}(e,t)),{dataChanged:r,propsChanged:s,updateTriggersChanged:i,extensionsChanged:function(e,t){if(null===t)return!0;let s=t.extensions,{extensions:r}=e;if(r===s)return!1;if(!s||!r||r.length!==s.length)return!0;for(let e=0;e<r.length;e++)if(!r[e].equals(s[e]))return!0;return!1}(e,t),transitionsChanged:function(e,t){if(!e.transitions)return!1;let s={},r=e[ea.Wb],i=!1;for(let n in e.transitions){let a=r[n],o=a&&a.type;("number"===o||"color"===o||"array"===o)&&el(e[n],t[n],a)&&(s[n]=!0,i=!0)}return!!i&&s}(e,t)}}(e,t);if(s.updateTriggersChanged)for(let e in s.updateTriggersChanged)s.updateTriggersChanged[e]&&this.invalidateAttribute(e);if(s.transitionsChanged)for(let r in s.transitionsChanged)this.internalState.uniformTransitions.add(r,t[r],e[r],e.transitions?.[r]);return this.setChangeFlags(s)}validateProps(){!function(e){let t=e[ea.Wb];for(let s in t){let r=t[s],{validate:i}=r;if(i&&!i(e[s],r))throw Error(`Invalid prop ${s}: ${e[s]}`)}}(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){let t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:s}=this.props;e.picked&&"function"==typeof s&&(t.highlightColor=s(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){let e=this.context;return new J(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){let{props:s,oldProps:r}=e;this.setNeedsRedraw(),this._updateAttributes();let i=this.state.model;i?.isInstanced&&i.setInstanceCount(this.getNumInstances());let{autoHighlight:n,highlightedObjectIndex:a,highlightColor:o}=s;if(t||r.autoHighlight!==n||r.highlightedObjectIndex!==a||r.highlightColor!==o){let e={};Array.isArray(o)&&(e.highlightColor=o),(t||r.autoHighlight!==n||a!==r.highlightedObjectIndex)&&(e.highlightedObjectColor=Number.isFinite(a)&&a>=0?this.encodePickingColor(a):null),this.setShaderModuleProps({picking:e})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=this.internalState.needsRedraw&&this.id;let s=this.getAttributeManager(),r=!!s&&s.getNeedsRedraw(e);if(t=t||r)for(let e of this.props.extensions)e.onNeedsRedraw.call(this,e);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}},25022:function(e,t,s){s.d(t,{Z:function(){return i}});let r={name:"picking",vs:`\
uniform pickingUniforms {
float isActive;
float isAttribute;
float isHighlightActive;
float useFloatColors;
vec3 highlightedObjectColor;
vec4 highlightColor;
} picking;
out vec4 picking_vRGBcolor_Avalid;
vec3 picking_normalizeColor(vec3 color) {
return picking.useFloatColors > 0.5 ? color : color / 255.0;
}
vec4 picking_normalizeColor(vec4 color) {
return picking.useFloatColors > 0.5 ? color : color / 255.0;
}
bool picking_isColorZero(vec3 color) {
return dot(color, vec3(1.0)) < 0.00001;
}
bool picking_isColorValid(vec3 color) {
return dot(color, vec3(1.0)) > 0.00001;
}
bool isVertexHighlighted(vec3 vertexColor) {
vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
return
bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}
void picking_setPickingColor(vec3 pickingColor) {
pickingColor = picking_normalizeColor(pickingColor);
if (bool(picking.isActive)) {
picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));
if (!bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.rgb = pickingColor;
}
} else {
picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
}
}
void picking_setPickingAttribute(float value) {
if (bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.r = value;
}
}
void picking_setPickingAttribute(vec2 value) {
if (bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.rg = value;
}
}
void picking_setPickingAttribute(vec3 value) {
if (bool(picking.isAttribute)) {
picking_vRGBcolor_Avalid.rgb = value;
}
}
`,fs:`\
uniform pickingUniforms {
float isActive;
float isAttribute;
float isHighlightActive;
float useFloatColors;
vec3 highlightedObjectColor;
vec4 highlightColor;
} picking;
in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
if (picking.isActive > 0.5) {
return color;
}
bool selected = bool(picking_vRGBcolor_Avalid.a);
if (selected) {
float highLightAlpha = picking.highlightColor.a;
float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
float highLightRatio = highLightAlpha / blendedAlpha;
vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
return vec4(blendedRGB, blendedAlpha);
} else {
return color;
}
}
vec4 picking_filterPickingColor(vec4 color) {
if (bool(picking.isActive)) {
if (picking_vRGBcolor_Avalid.a == 0.0) {
discard;
}
return picking_vRGBcolor_Avalid;
}
return color;
}
vec4 picking_filterColor(vec4 color) {
vec4 highlightColor = picking_filterHighlightColor(color);
return picking_filterPickingColor(highlightColor);
}
`,uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:[0,1,1,1]},getUniforms:function(e={},t){let s={};if(void 0===e.highlightedObjectColor);else if(null===e.highlightedObjectColor)s.isHighlightActive=!1;else{s.isHighlightActive=!0;let t=e.highlightedObjectColor.slice(0,3);s.highlightedObjectColor=t}if(e.highlightColor){let t=Array.from(e.highlightColor,e=>e/255);Number.isFinite(t[3])||(t[3]=1),s.highlightColor=t}return void 0!==e.isActive&&(s.isActive=!!e.isActive,s.isAttribute=!!e.isAttribute),void 0!==e.useFloatColors&&(s.useFloatColors=!!e.useFloatColors),s}};var i={...r,defaultUniforms:{...r.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}}},5915:function(e,t,s){var r=s(99647);let i=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`;t.Z={name:"project32",dependencies:[r.Z],vs:i}},50567:function(e,t,s){s.d(t,{Z:function(){return f}});var r=s(18642),i=s(5915),n=s(25022),a=s(39931),o=s(79335),l=s(87444),u=`\
#version 300 es
#define SHADER_NAME arc-layer-vertex-shader
in vec3 positions;
in vec4 instanceSourceColors;
in vec4 instanceTargetColors;
in vec3 instanceSourcePositions;
in vec3 instanceSourcePositions64Low;
in vec3 instanceTargetPositions;
in vec3 instanceTargetPositions64Low;
in vec3 instancePickingColors;
in float instanceWidths;
in float instanceHeights;
in float instanceTilts;
uniform bool greatCircle;
uniform bool useShortestPath;
uniform float numSegments;
uniform float opacity;
uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform int widthUnits;
out vec4 vColor;
out vec2 uv;
out float isValid;
float paraboloid(float distance, float sourceZ, float targetZ, float ratio) {
float deltaZ = targetZ - sourceZ;
float dh = distance * instanceHeights;
if (dh == 0.0) {
return sourceZ + deltaZ * ratio;
}
float unitZ = deltaZ / dh;
float p2 = unitZ * unitZ + 1.0;
float dir = step(deltaZ, 0.0);
float z0 = mix(sourceZ, targetZ, dir);
float r = mix(ratio, 1.0 - ratio, dir);
return sqrt(r * (p2 - r)) * dh + z0;
}
vec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction, float width) {
vec2 dir_screenspace = normalize(line_clipspace * project_uViewportSize);
dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);
return dir_screenspace * offset_direction * width / 2.0;
}
float getSegmentRatio(float index) {
return smoothstep(0.0, 1.0, index / (numSegments - 1.0));
}
vec3 interpolateFlat(vec3 source, vec3 target, float segmentRatio) {
float distance = length(source.xy - target.xy);
float z = paraboloid(distance, source.z, target.z, segmentRatio);
float tiltAngle = radians(instanceTilts);
vec2 tiltDirection = normalize(target.xy - source.xy);
vec2 tilt = vec2(-tiltDirection.y, tiltDirection.x) * z * sin(tiltAngle);
return vec3(
mix(source.xy, target.xy, segmentRatio) + tilt,
z * cos(tiltAngle)
);
}
float getAngularDist (vec2 source, vec2 target) {
vec2 sourceRadians = radians(source);
vec2 targetRadians = radians(target);
vec2 sin_half_delta = sin((sourceRadians - targetRadians) / 2.0);
vec2 shd_sq = sin_half_delta * sin_half_delta;
float a = shd_sq.y + cos(sourceRadians.y) * cos(targetRadians.y) * shd_sq.x;
return 2.0 * asin(sqrt(a));
}
vec3 interpolateGreatCircle(vec3 source, vec3 target, vec3 source3D, vec3 target3D, float angularDist, float t) {
vec2 lngLat;
if(abs(angularDist - PI) < 0.001) {
lngLat = (1.0 - t) * source.xy + t * target.xy;
} else {
float a = sin((1.0 - t) * angularDist);
float b = sin(t * angularDist);
vec3 p = source3D.yxz * a + target3D.yxz * b;
lngLat = degrees(vec2(atan(p.y, -p.x), atan(p.z, length(p.xy))));
}
float z = paraboloid(angularDist * EARTH_RADIUS, source.z, target.z, t);
return vec3(lngLat, z);
}
void main(void) {
geometry.worldPosition = instanceSourcePositions;
geometry.worldPositionAlt = instanceTargetPositions;
float segmentIndex = positions.x;
float segmentRatio = getSegmentRatio(segmentIndex);
float prevSegmentRatio = getSegmentRatio(max(0.0, segmentIndex - 1.0));
float nextSegmentRatio = getSegmentRatio(min(numSegments - 1.0, segmentIndex + 1.0));
float indexDir = mix(-1.0, 1.0, step(segmentIndex, 0.0));
isValid = 1.0;
uv = vec2(segmentRatio, positions.y);
geometry.uv = uv;
geometry.pickingColor = instancePickingColors;
vec4 curr;
vec4 next;
vec3 source;
vec3 target;
if ((greatCircle || project_uProjectionMode == PROJECTION_MODE_GLOBE) && project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
source = project_globe_(vec3(instanceSourcePositions.xy, 0.0));
target = project_globe_(vec3(instanceTargetPositions.xy, 0.0));
float angularDist = getAngularDist(instanceSourcePositions.xy, instanceTargetPositions.xy);
vec3 prevPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, prevSegmentRatio);
vec3 currPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, segmentRatio);
vec3 nextPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, nextSegmentRatio);
if (abs(currPos.x - prevPos.x) > 180.0) {
indexDir = -1.0;
isValid = 0.0;
} else if (abs(currPos.x - nextPos.x) > 180.0) {
indexDir = 1.0;
isValid = 0.0;
}
nextPos = indexDir < 0.0 ? prevPos : nextPos;
nextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;
if (isValid == 0.0) {
nextPos.x += nextPos.x > 0.0 ? -360.0 : 360.0;
float t = ((currPos.x > 0.0 ? 180.0 : -180.0) - currPos.x) / (nextPos.x - currPos.x);
currPos = mix(currPos, nextPos, t);
segmentRatio = mix(segmentRatio, nextSegmentRatio, t);
}
vec3 currPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, segmentRatio);
vec3 nextPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, nextSegmentRatio);
curr = project_position_to_clipspace(currPos, currPos64Low, vec3(0.0), geometry.position);
next = project_position_to_clipspace(nextPos, nextPos64Low, vec3(0.0));
} else {
vec3 source_world = instanceSourcePositions;
vec3 target_world = instanceTargetPositions;
if (useShortestPath) {
source_world.x = mod(source_world.x + 180., 360.0) - 180.;
target_world.x = mod(target_world.x + 180., 360.0) - 180.;
float deltaLng = target_world.x - source_world.x;
if (deltaLng > 180.) target_world.x -= 360.;
if (deltaLng < -180.) source_world.x -= 360.;
}
source = project_position(source_world, instanceSourcePositions64Low);
target = project_position(target_world, instanceTargetPositions64Low);
float antiMeridianX = 0.0;
if (useShortestPath) {
if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
antiMeridianX = -(project_uCoordinateOrigin.x + 180.) / 360. * TILE_SIZE;
}
float thresholdRatio = (antiMeridianX - source.x) / (target.x - source.x);
if (prevSegmentRatio <= thresholdRatio && nextSegmentRatio > thresholdRatio) {
isValid = 0.0;
indexDir = sign(segmentRatio - thresholdRatio);
segmentRatio = thresholdRatio;
}
}
nextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;
vec3 currPos = interpolateFlat(source, target, segmentRatio);
vec3 nextPos = interpolateFlat(source, target, nextSegmentRatio);
if (useShortestPath) {
if (nextPos.x < antiMeridianX) {
currPos.x += TILE_SIZE;
nextPos.x += TILE_SIZE;
}
}
curr = project_common_position_to_clipspace(vec4(currPos, 1.0));
next = project_common_position_to_clipspace(vec4(nextPos, 1.0));
geometry.position = vec4(currPos, 1.0);
}
float widthPixels = clamp(
project_size_to_pixel(instanceWidths * widthScale, widthUnits),
widthMinPixels, widthMaxPixels
);
vec3 offset = vec3(
getExtrusionOffset((next.xy - curr.xy) * indexDir, positions.y, widthPixels),
0.0);
DECKGL_FILTER_SIZE(offset, geometry);
DECKGL_FILTER_GL_POSITION(curr, geometry);
gl_Position = curr + vec4(project_pixel_size_to_clipspace(offset.xy), 0.0, 0.0);
vec4 color = mix(instanceSourceColors, instanceTargetColors, segmentRatio);
vColor = vec4(color.rgb, color.a * opacity);
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,h=`\
#version 300 es
#define SHADER_NAME arc-layer-fragment-shader
precision highp float;
in vec4 vColor;
in vec2 uv;
in float isValid;
out vec4 fragColor;
void main(void) {
if (isValid == 0.0) {
discard;
}
fragColor = vColor;
geometry.uv = uv;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`;let c=[0,0,0,255],d={getSourcePosition:{type:"accessor",value:e=>e.sourcePosition},getTargetPosition:{type:"accessor",value:e=>e.targetPosition},getSourceColor:{type:"accessor",value:c},getTargetColor:{type:"accessor",value:c},getWidth:{type:"accessor",value:1},getHeight:{type:"accessor",value:1},getTilt:{type:"accessor",value:0},greatCircle:!1,numSegments:{type:"number",value:50,min:1},widthUnits:"pixels",widthScale:{type:"number",value:1,min:0},widthMinPixels:{type:"number",value:0,min:0},widthMaxPixels:{type:"number",value:Number.MAX_SAFE_INTEGER,min:0}};class f extends r.Z{static{this.layerName="ArcLayer"}static{this.defaultProps=d}getBounds(){return this.getAttributeManager()?.getBounds(["instanceSourcePositions","instanceTargetPositions"])}getShaders(){return super.getShaders({vs:u,fs:h,modules:[i.Z,n.Z]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({instanceSourcePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getSourcePosition"},instanceTargetPositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getTargetPosition"},instanceSourceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getSourceColor",defaultValue:c},instanceTargetColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getTargetColor",defaultValue:c},instanceWidths:{size:1,transition:!0,accessor:"getWidth",defaultValue:1},instanceHeights:{size:1,transition:!0,accessor:"getHeight",defaultValue:1},instanceTilts:{size:1,transition:!0,accessor:"getTilt",defaultValue:0}})}updateState(e){super.updateState(e);let{props:t,oldProps:s,changeFlags:r}=e;(r.extensionsChanged||t.numSegments!==s.numSegments)&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){let{widthUnits:t,widthScale:s,widthMinPixels:r,widthMaxPixels:i,greatCircle:n,wrapLongitude:o}=this.props,l=this.state.model;l.setUniforms(e),l.setUniforms({greatCircle:n,widthUnits:a.iI[t],widthScale:s,widthMinPixels:r,widthMaxPixels:i,useShortestPath:o}),l.draw(this.context.renderPass)}_getModel(){let{numSegments:e}=this.props,t=[];for(let s=0;s<e;s++)t=t.concat([s,1,0,s,-1,0]);let s=new l.H(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new o.Z({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array(t)}}}),isInstanced:!0});return s.setUniforms({numSegments:e}),s}}},77520:function(e,t,s){s.d(t,{Z:function(){return f}});var r=s(18642),i=s(5915),n=s(25022),a=s(39931),o=s(79335),l=s(87444),u=`\
#version 300 es
#define SHADER_NAME scatterplot-layer-vertex-shader
in vec3 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceRadius;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
uniform float opacity;
uniform float radiusScale;
uniform float radiusMinPixels;
uniform float radiusMaxPixels;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform float stroked;
uniform bool filled;
uniform bool antialiasing;
uniform bool billboard;
uniform int radiusUnits;
uniform int lineWidthUnits;
out vec4 vFillColor;
out vec4 vLineColor;
out vec2 unitPosition;
out float innerUnitRadius;
out float outerRadiusPixels;
void main(void) {
geometry.worldPosition = instancePositions;
outerRadiusPixels = clamp(
project_size_to_pixel(radiusScale * instanceRadius, radiusUnits),
radiusMinPixels, radiusMaxPixels
);
float lineWidthPixels = clamp(
project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
lineWidthMinPixels, lineWidthMaxPixels
);
outerRadiusPixels += stroked * lineWidthPixels / 2.0;
float edgePadding = antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;
unitPosition = edgePadding * positions.xy;
geometry.uv = unitPosition;
geometry.pickingColor = instancePickingColors;
innerUnitRadius = 1.0 - stroked * lineWidthPixels / outerRadiusPixels;
if (billboard) {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = edgePadding * positions * outerRadiusPixels;
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,h=`\
#version 300 es
#define SHADER_NAME scatterplot-layer-fragment-shader
precision highp float;
uniform bool filled;
uniform float stroked;
uniform bool antialiasing;
in vec4 vFillColor;
in vec4 vLineColor;
in vec2 unitPosition;
in float innerUnitRadius;
in float outerRadiusPixels;
out vec4 fragColor;
void main(void) {
geometry.uv = unitPosition;
float distToCenter = length(unitPosition) * outerRadiusPixels;
float inCircle = antialiasing ?
smoothedge(distToCenter, outerRadiusPixels) :
step(distToCenter, outerRadiusPixels);
if (inCircle == 0.0) {
discard;
}
if (stroked > 0.5) {
float isLine = antialiasing ?
smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
step(innerUnitRadius * outerRadiusPixels, distToCenter);
if (filled) {
fragColor = mix(vFillColor, vLineColor, isLine);
} else {
if (isLine == 0.0) {
discard;
}
fragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
}
} else if (!filled) {
discard;
} else {
fragColor = vFillColor;
}
fragColor.a *= inCircle;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`;let c=[0,0,0,255],d={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:e=>e.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:c},getLineColor:{type:"accessor",value:c},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class f extends r.Z{static{this.defaultProps=d}static{this.layerName="ScatterplotLayer"}getShaders(){return super.getShaders({vs:u,fs:h,modules:[i.Z,n.Z]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e),e.changeFlags.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){let{radiusUnits:t,radiusScale:s,radiusMinPixels:r,radiusMaxPixels:i,stroked:n,filled:o,billboard:l,antialiasing:u,lineWidthUnits:h,lineWidthScale:c,lineWidthMinPixels:d,lineWidthMaxPixels:f}=this.props,p=this.state.model;p.setUniforms(e),p.setUniforms({stroked:n?1:0,filled:o,billboard:l,antialiasing:u,radiusUnits:a.iI[t],radiusScale:s,radiusMinPixels:r,radiusMaxPixels:i,lineWidthUnits:a.iI[h],lineWidthScale:c,lineWidthMinPixels:d,lineWidthMaxPixels:f}),p.draw(this.context.renderPass)}_getModel(){return new l.H(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new o.Z({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0])}}}),isInstanced:!0})}}},47824:function(e,t,s){function r(e){let t=ArrayBuffer.isView(e)?e.constructor:e;switch(t){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw Error(t.constructor.name)}}function i(e){switch(e){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw Error(e)}}function n(e,t,s){if(!t||t>4)throw Error(`size ${t}`);let i=r(e);if("uint8"===i&&s&&1===t)return"unorm8-webgl";if("uint8"===i&&s&&3===t)return"unorm8x3-webgl";if("uint8"===i||"sint8"===i||"uint16"===i||"sint16"===i){if(1===t||3===t)throw Error(`size: ${t}`);return s&&(i=i.replace("int","norm")),`${i}x${t}`}return 1===t?i:`${i}x${t}`}s.d(t,{C9:function(){return r},Xs:function(){return i},sk:function(){return n}})},79335:function(e,t,s){s.d(t,{Z:function(){return n}});var r=s(10538),i=s(58859);class n{id;topology;vertexCount;indices;attributes;userData={};constructor(e){let{attributes:t={},indices:s=null,vertexCount:n=null}=e;for(let[n,a]of(this.id=e.id||(0,r.h)("geometry"),this.topology=e.topology,s&&(this.indices=ArrayBuffer.isView(s)?{value:s,size:1}:s),this.attributes={},Object.entries(t))){let e=ArrayBuffer.isView(a)?{value:a}:a;(0,i.h)(ArrayBuffer.isView(e.value),`${this._print(n)}: must be typed array or object with value as typed array`),"POSITION"!==n&&"positions"!==n||e.size||(e.size=3),"indices"===n?((0,i.h)(!this.indices),this.indices=e):this.attributes[n]=e}this.indices&&void 0!==this.indices.isIndexed&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=n||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let s=1/0;for(let t of Object.values(e)){let{value:e,size:r,constant:i}=t;!i&&e&&r>=1&&(s=Math.min(s,e.length/r))}return(0,i.h)(Number.isFinite(s)),s}}},87444:function(e,t,s){s.d(t,{H:function(){return e9}});var r,i,n,a,o,l,u,h,c,d=s(497),f=s(14707),p=s(33609),_=s(68667),g=s(96839),m=s(95802);class y{name;uniforms={};modifiedUniforms={};modified=!0;bindingLayout={};needsRedraw="initialized";constructor(e){if(this.name=e?.name,e?.name&&e?.shaderLayout){let t=e?.shaderLayout.bindings?.find(t=>"uniform"===t.type&&t.name===e?.name);if(!t)throw Error(e?.name);for(let e of t.uniforms||[])this.bindingLayout[e.name]=e}}setUniforms(e){for(let[t,s]of Object.entries(e))this._setUniform(t,s),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${s}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){!function(e,t,s=16){if(e!==t)return!1;let r=(0,m.v)(e);if(!r)return!1;let i=(0,m.v)(t);if(i&&r.length===i.length){for(let e=0;e<r.length;++e)if(i[e]!==r[e])return!1}return!0}(this.uniforms[e],t)&&(this.uniforms[e]=function(e){let t=(0,m.v)(e);return t?t.slice():e}(t),this.modifiedUniforms[e]=!0,this.modified=!0)}}var b=s(58859);let v={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};var w=s(40999),x=s(48980);class k{layout={};byteLength;constructor(e){let t=0;for(let[s,r]of Object.entries(e)){let{type:e,components:i}=function(e){let t=v[e];return(0,b.h)(e),t}(r),n=t=function(e,t){switch(t){case 1:return e;case 2:return e+e%2;default:return e+(4-e%4)%4}}(t,i);t+=i,this.layout[s]={type:e,size:i,offset:n}}let s=4*(t+=(4-t%4)%4);this.byteLength=Math.max(s,1024)}getData(e){let t=Math.max(this.byteLength,1024),s=(0,w.D4)(t),r={i32:new Int32Array(s),u32:new Uint32Array(s),f32:new Float32Array(s),f16:new Uint16Array(s)};for(let[t,s]of Object.entries(e)){let e=this.layout[t];if(!e){x.c.warn(`Supplied uniform value ${t} not present in uniform block layout`)();continue}let{type:i,size:n,offset:a}=e,o=r[i];if(1===n){if("number"!=typeof s&&"boolean"!=typeof s){x.c.warn(`Supplied value for single component uniform ${t} is not a number: ${s}`)();continue}o[a]=Number(s)}else{let e=(0,m.v)(s);if(!e){x.c.warn(`Supplied value for multi component / array uniform ${t} is not a numeric array: ${s}`)();continue}o.set(e,a)}}return new Uint8Array(s)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}class A{uniformBlocks=new Map;uniformBufferLayouts=new Map;uniformBuffers=new Map;constructor(e){for(let[t,s]of Object.entries(e)){let e=new k(s.uniformTypes||{});this.uniformBufferLayouts.set(t,e);let r=new y({name:t});r.setUniforms(s.defaultUniforms||{}),this.uniformBlocks.set(t,r)}}destroy(){for(let e of this.uniformBuffers.values())e.destroy()}setUniforms(e){for(let[t,s]of Object.entries(e))this.uniformBlocks.get(t).setUniforms(s);this.updateUniformBuffers()}getUniformBufferByteLength(e){return this.uniformBufferLayouts.get(e).byteLength}getUniformBufferData(e){let t=this.uniformBlocks.get(e).getAllUniforms();return this.uniformBufferLayouts.get(e).getData(t)}createUniformBuffer(e,t,s){s&&this.setUniforms(s);let r=this.getUniformBufferByteLength(t),i=e.createBuffer({usage:f.l.UNIFORM|f.l.COPY_DST,byteLength:r}),n=this.getUniformBufferData(t);return i.write(n),i}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){let s=this.getUniformBufferByteLength(t),r=e.createBuffer({usage:f.l.UNIFORM|f.l.COPY_DST,byteLength:s});this.uniformBuffers.set(t,r)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(let t of this.uniformBlocks.keys()){let s=this.updateUniformBuffer(t);e||=s}return e&&x.c.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){let t=this.uniformBlocks.get(e),s=this.uniformBuffers.get(e),r=!1;if(s&&t.needsRedraw){r||=t.needsRedraw;let s=this.getUniformBufferData(e);this.uniformBuffers.get(e).write(s);let i=this.uniformBlocks.get(e).getAllUniforms();x.c.log(4,`Writing to uniform buffer ${String(e)}`,s,i)()}return r}}var T=s(10538),P=s(34811),S=s(1467),C=s(47824),E=s(87095);class I{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class L{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(e){throw Error("Cannot evaluate node")}evaluateString(e){return this.evaluate(e).toString()}search(e){}searchBlock(e,t){if(e){for(let s of(t(O.instance),e))s instanceof Array?this.searchBlock(s,t):s.search(t);t(R.instance)}}}class O extends L{}O.instance=new O;class R extends L{}R.instance=new R;class N extends L{constructor(){super()}}class U extends N{constructor(e,t,s,r,i,n){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=s,this.body=r,this.startLine=i,this.endLine=n}get astNodeType(){return"function"}search(e){this.searchBlock(this.body,e)}}class M extends N{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class F extends N{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class B extends N{constructor(e){super(),this.body=e}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class z extends N{constructor(e,t,s,r){super(),this.init=e,this.condition=t,this.increment=s,this.body=r}get astNodeType(){return"for"}search(e){var t,s,r;null===(t=this.init)||void 0===t||t.search(e),null===(s=this.condition)||void 0===s||s.search(e),null===(r=this.increment)||void 0===r||r.search(e),this.searchBlock(this.body,e)}}class j extends N{constructor(e,t,s,r,i){super(),this.name=e,this.type=t,this.storage=s,this.access=r,this.value=i}get astNodeType(){return"var"}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class D extends N{constructor(e,t,s){super(),this.name=e,this.type=t,this.value=s}get astNodeType(){return"override"}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class V extends N{constructor(e,t,s,r,i){super(),this.name=e,this.type=t,this.storage=s,this.access=r,this.value=i}get astNodeType(){return"let"}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class q extends N{constructor(e,t,s,r,i){super(),this.name=e,this.type=t,this.storage=s,this.access=r,this.value=i}get astNodeType(){return"const"}evaluate(e){return this.value.evaluate(e)}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}(r=l||(l={})).increment="++",r.decrement="--",(i=l||(l={})).parse=function(e){if("parse"==e)throw Error("Invalid value for IncrementOperator");return i[e]};class $ extends N{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(n=u||(u={})).assign="=",n.addAssign="+=",n.subtractAssin="-=",n.multiplyAssign="*=",n.divideAssign="/=",n.moduloAssign="%=",n.andAssign="&=",n.orAssign="|=",n.xorAssign="^=",n.shiftLeftAssign="<<=",n.shiftRightAssign=">>=",(u||(u={})).parse=function(e){if("parse"==e)throw Error("Invalid value for AssignOperator");return e};class G extends N{constructor(e,t,s){super(),this.operator=e,this.variable=t,this.value=s}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class Z extends N{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}search(e){for(let t of this.args)t.search(e);e(this)}}class W extends N{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}}class H extends N{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"body"}}class Y extends N{constructor(e,t,s,r){super(),this.condition=e,this.body=t,this.elseif=s,this.else=r}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class K extends N{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class X extends N{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class J extends N{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class Q extends N{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class ee extends N{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class et extends N{constructor(){super()}get astNodeType(){return"discard"}}class es extends N{constructor(){super()}get astNodeType(){return"break"}}class er extends N{constructor(){super()}get astNodeType(){return"continue"}}class ei extends N{constructor(e){super(),this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class en extends ei{constructor(e,t,s,r){super(e),this.members=t,this.startLine=s,this.endLine=r}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return -1}}class ea extends ei{constructor(e,t,s){super(e),this.format=t,this.access=s}get astNodeType(){return"template"}}class eo extends ei{constructor(e,t,s,r){super(e),this.storage=t,this.type=s,this.access=r}get astNodeType(){return"pointer"}}class el extends ei{constructor(e,t,s,r){super(e),this.attributes=t,this.format=s,this.count=r}get astNodeType(){return"array"}get isArray(){return!0}}class eu extends ei{constructor(e,t,s){super(e),this.format=t,this.access=s}get astNodeType(){return"sampler"}}class eh extends L{constructor(){super()}}class ec extends eh{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class ed extends eh{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){for(let t of(e(this),this.args))t.search(e)}}class ef extends eh{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"callExpr"}evaluate(e){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(e));case"acos":return Math.acos(this.args[0].evaluate(e));case"acosh":return Math.acosh(this.args[0].evaluate(e));case"asin":return Math.asin(this.args[0].evaluate(e));case"asinh":return Math.asinh(this.args[0].evaluate(e));case"atan":return Math.atan(this.args[0].evaluate(e));case"atan2":return Math.atan2(this.args[0].evaluate(e),this.args[1].evaluate(e));case"atanh":return Math.atanh(this.args[0].evaluate(e));case"ceil":return Math.ceil(this.args[0].evaluate(e));case"clamp":return Math.min(Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e)),this.args[2].evaluate(e));case"cos":return Math.cos(this.args[0].evaluate(e));case"degrees":return 180*this.args[0].evaluate(e)/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(e)-this.args[1].evaluate(e),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(e));case"exp2":return Math.pow(2,this.args[0].evaluate(e));case"floor":return Math.floor(this.args[0].evaluate(e));case"fma":return this.args[0].evaluate(e)*this.args[1].evaluate(e)+this.args[2].evaluate(e);case"fract":case"modf":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(e));case"log":return Math.log(this.args[0].evaluate(e));case"log2":return Math.log2(this.args[0].evaluate(e));case"max":return Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e));case"min":return Math.min(this.args[0].evaluate(e),this.args[1].evaluate(e));case"mix":return this.args[0].evaluate(e)*(1-this.args[2].evaluate(e))+this.args[1].evaluate(e)*this.args[2].evaluate(e);case"pow":return Math.pow(this.args[0].evaluate(e),this.args[1].evaluate(e));case"radians":return this.args[0].evaluate(e)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(e));case"sign":return Math.sign(this.args[0].evaluate(e));case"sin":return Math.sin(this.args[0].evaluate(e));case"sinh":return Math.sinh(this.args[0].evaluate(e));case"saturate":return Math.min(Math.max(this.args[0].evaluate(e),0),1);case"smoothstep":return this.args[0].evaluate(e)*this.args[0].evaluate(e)*(3-2*this.args[0].evaluate(e));case"sqrt":return Math.sqrt(this.args[0].evaluate(e));case"step":return this.args[0].evaluate(e)<this.args[1].evaluate(e)?0:1;case"tan":return Math.tan(this.args[0].evaluate(e));case"tanh":return Math.tanh(this.args[0].evaluate(e));case"trunc":return Math.trunc(this.args[0].evaluate(e));default:throw Error("Non const function: "+this.name)}}search(e){for(let t of this.args)t.search(e);e(this)}}class ep extends eh{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}evaluate(e){let t=e.constants.get(this.name);if(!t)throw Error("Cannot evaluate node");return t.evaluate(e)}}class e_ extends eh{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}evaluate(e){var t,s;if(this.initializer instanceof ed){let r=null===(t=this.postfix)||void 0===t?void 0:t.evaluateString(e),i=null===(s=this.initializer.type)||void 0===s?void 0:s.name,n=e.structs.get(i),a=null==n?void 0:n.getMemberIndex(r);if(-1!=a)return this.initializer.args[a].evaluate(e);console.log(a)}return this.initializer.evaluate(e)}search(e){this.initializer.search(e)}}class eg extends eh{constructor(e){super(),this.value=e}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class em extends eh{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class ey extends eh{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"typecastExpr"}evaluate(e){return this.args[0].evaluate(e)}search(e){this.searchBlock(this.args,e)}}class eb extends eh{constructor(e){super(),this.contents=e}get astNodeType(){return"groupExpr"}evaluate(e){return this.contents[0].evaluate(e)}search(e){this.searchBlock(this.contents,e)}}class ev extends eh{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class ew extends eh{constructor(){super()}}class ex extends ew{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}evaluate(e){switch(this.operator){case"+":return this.right.evaluate(e);case"-":return-this.right.evaluate(e);case"!":return this.right.evaluate(e)?0:1;case"~":return~this.right.evaluate(e);default:throw Error("Unknown unary operator: "+this.operator)}}search(e){this.right.search(e)}}class ek extends ew{constructor(e,t,s){super(),this.operator=e,this.left=t,this.right=s}get astNodeType(){return"binaryOp"}evaluate(e){switch(this.operator){case"+":return this.left.evaluate(e)+this.right.evaluate(e);case"-":return this.left.evaluate(e)-this.right.evaluate(e);case"*":return this.left.evaluate(e)*this.right.evaluate(e);case"/":return this.left.evaluate(e)/this.right.evaluate(e);case"%":return this.left.evaluate(e)%this.right.evaluate(e);case"==":return this.left.evaluate(e)==this.right.evaluate(e)?1:0;case"!=":return this.left.evaluate(e)!=this.right.evaluate(e)?1:0;case"<":return this.left.evaluate(e)<this.right.evaluate(e)?1:0;case">":return this.left.evaluate(e)>this.right.evaluate(e)?1:0;case"<=":return this.left.evaluate(e)<=this.right.evaluate(e)?1:0;case">=":return this.left.evaluate(e)>=this.right.evaluate(e)?1:0;case"&&":return this.left.evaluate(e)&&this.right.evaluate(e)?1:0;case"||":return this.left.evaluate(e)||this.right.evaluate(e)?1:0;default:throw Error(`Unknown operator ${this.operator}`)}}search(e){this.left.search(e),this.right.search(e)}}class eA extends L{constructor(){super()}}class eT extends eA{constructor(e,t){super(),this.selector=e,this.body=t}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class eP extends eA{constructor(e){super(),this.body=e}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class eS extends L{constructor(e,t,s){super(),this.name=e,this.type=t,this.attributes=s}get astNodeType(){return"argument"}}class eC extends L{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class eE extends L{constructor(e,t,s){super(),this.name=e,this.type=t,this.attributes=s}get astNodeType(){return"member"}}class eI extends L{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}(a=h||(h={}))[a.token=0]="token",a[a.keyword=1]="keyword",a[a.reserved=2]="reserved";class eL{constructor(e,t,s){this.name=e,this.type=t,this.rule=s}toString(){return this.name}}class eO{}eO.none=new eL("",h.reserved,""),eO.eof=new eL("EOF",h.token,""),eO.reserved={asm:new eL("asm",h.reserved,"asm"),bf16:new eL("bf16",h.reserved,"bf16"),do:new eL("do",h.reserved,"do"),enum:new eL("enum",h.reserved,"enum"),f16:new eL("f16",h.reserved,"f16"),f64:new eL("f64",h.reserved,"f64"),handle:new eL("handle",h.reserved,"handle"),i8:new eL("i8",h.reserved,"i8"),i16:new eL("i16",h.reserved,"i16"),i64:new eL("i64",h.reserved,"i64"),mat:new eL("mat",h.reserved,"mat"),premerge:new eL("premerge",h.reserved,"premerge"),regardless:new eL("regardless",h.reserved,"regardless"),typedef:new eL("typedef",h.reserved,"typedef"),u8:new eL("u8",h.reserved,"u8"),u16:new eL("u16",h.reserved,"u16"),u64:new eL("u64",h.reserved,"u64"),unless:new eL("unless",h.reserved,"unless"),using:new eL("using",h.reserved,"using"),vec:new eL("vec",h.reserved,"vec"),void:new eL("void",h.reserved,"void")},eO.keywords={array:new eL("array",h.keyword,"array"),atomic:new eL("atomic",h.keyword,"atomic"),bool:new eL("bool",h.keyword,"bool"),f32:new eL("f32",h.keyword,"f32"),i32:new eL("i32",h.keyword,"i32"),mat2x2:new eL("mat2x2",h.keyword,"mat2x2"),mat2x3:new eL("mat2x3",h.keyword,"mat2x3"),mat2x4:new eL("mat2x4",h.keyword,"mat2x4"),mat3x2:new eL("mat3x2",h.keyword,"mat3x2"),mat3x3:new eL("mat3x3",h.keyword,"mat3x3"),mat3x4:new eL("mat3x4",h.keyword,"mat3x4"),mat4x2:new eL("mat4x2",h.keyword,"mat4x2"),mat4x3:new eL("mat4x3",h.keyword,"mat4x3"),mat4x4:new eL("mat4x4",h.keyword,"mat4x4"),ptr:new eL("ptr",h.keyword,"ptr"),sampler:new eL("sampler",h.keyword,"sampler"),sampler_comparison:new eL("sampler_comparison",h.keyword,"sampler_comparison"),struct:new eL("struct",h.keyword,"struct"),texture_1d:new eL("texture_1d",h.keyword,"texture_1d"),texture_2d:new eL("texture_2d",h.keyword,"texture_2d"),texture_2d_array:new eL("texture_2d_array",h.keyword,"texture_2d_array"),texture_3d:new eL("texture_3d",h.keyword,"texture_3d"),texture_cube:new eL("texture_cube",h.keyword,"texture_cube"),texture_cube_array:new eL("texture_cube_array",h.keyword,"texture_cube_array"),texture_multisampled_2d:new eL("texture_multisampled_2d",h.keyword,"texture_multisampled_2d"),texture_storage_1d:new eL("texture_storage_1d",h.keyword,"texture_storage_1d"),texture_storage_2d:new eL("texture_storage_2d",h.keyword,"texture_storage_2d"),texture_storage_2d_array:new eL("texture_storage_2d_array",h.keyword,"texture_storage_2d_array"),texture_storage_3d:new eL("texture_storage_3d",h.keyword,"texture_storage_3d"),texture_depth_2d:new eL("texture_depth_2d",h.keyword,"texture_depth_2d"),texture_depth_2d_array:new eL("texture_depth_2d_array",h.keyword,"texture_depth_2d_array"),texture_depth_cube:new eL("texture_depth_cube",h.keyword,"texture_depth_cube"),texture_depth_cube_array:new eL("texture_depth_cube_array",h.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new eL("texture_depth_multisampled_2d",h.keyword,"texture_depth_multisampled_2d"),texture_external:new eL("texture_external",h.keyword,"texture_external"),u32:new eL("u32",h.keyword,"u32"),vec2:new eL("vec2",h.keyword,"vec2"),vec3:new eL("vec3",h.keyword,"vec3"),vec4:new eL("vec4",h.keyword,"vec4"),bitcast:new eL("bitcast",h.keyword,"bitcast"),block:new eL("block",h.keyword,"block"),break:new eL("break",h.keyword,"break"),case:new eL("case",h.keyword,"case"),continue:new eL("continue",h.keyword,"continue"),continuing:new eL("continuing",h.keyword,"continuing"),default:new eL("default",h.keyword,"default"),diagnostic:new eL("diagnostic",h.keyword,"diagnostic"),discard:new eL("discard",h.keyword,"discard"),else:new eL("else",h.keyword,"else"),enable:new eL("enable",h.keyword,"enable"),fallthrough:new eL("fallthrough",h.keyword,"fallthrough"),false:new eL("false",h.keyword,"false"),fn:new eL("fn",h.keyword,"fn"),for:new eL("for",h.keyword,"for"),function:new eL("function",h.keyword,"function"),if:new eL("if",h.keyword,"if"),let:new eL("let",h.keyword,"let"),const:new eL("const",h.keyword,"const"),loop:new eL("loop",h.keyword,"loop"),while:new eL("while",h.keyword,"while"),private:new eL("private",h.keyword,"private"),read:new eL("read",h.keyword,"read"),read_write:new eL("read_write",h.keyword,"read_write"),return:new eL("return",h.keyword,"return"),requires:new eL("requires",h.keyword,"requires"),storage:new eL("storage",h.keyword,"storage"),switch:new eL("switch",h.keyword,"switch"),true:new eL("true",h.keyword,"true"),alias:new eL("alias",h.keyword,"alias"),type:new eL("type",h.keyword,"type"),uniform:new eL("uniform",h.keyword,"uniform"),var:new eL("var",h.keyword,"var"),override:new eL("override",h.keyword,"override"),workgroup:new eL("workgroup",h.keyword,"workgroup"),write:new eL("write",h.keyword,"write"),r8unorm:new eL("r8unorm",h.keyword,"r8unorm"),r8snorm:new eL("r8snorm",h.keyword,"r8snorm"),r8uint:new eL("r8uint",h.keyword,"r8uint"),r8sint:new eL("r8sint",h.keyword,"r8sint"),r16uint:new eL("r16uint",h.keyword,"r16uint"),r16sint:new eL("r16sint",h.keyword,"r16sint"),r16float:new eL("r16float",h.keyword,"r16float"),rg8unorm:new eL("rg8unorm",h.keyword,"rg8unorm"),rg8snorm:new eL("rg8snorm",h.keyword,"rg8snorm"),rg8uint:new eL("rg8uint",h.keyword,"rg8uint"),rg8sint:new eL("rg8sint",h.keyword,"rg8sint"),r32uint:new eL("r32uint",h.keyword,"r32uint"),r32sint:new eL("r32sint",h.keyword,"r32sint"),r32float:new eL("r32float",h.keyword,"r32float"),rg16uint:new eL("rg16uint",h.keyword,"rg16uint"),rg16sint:new eL("rg16sint",h.keyword,"rg16sint"),rg16float:new eL("rg16float",h.keyword,"rg16float"),rgba8unorm:new eL("rgba8unorm",h.keyword,"rgba8unorm"),rgba8unorm_srgb:new eL("rgba8unorm_srgb",h.keyword,"rgba8unorm_srgb"),rgba8snorm:new eL("rgba8snorm",h.keyword,"rgba8snorm"),rgba8uint:new eL("rgba8uint",h.keyword,"rgba8uint"),rgba8sint:new eL("rgba8sint",h.keyword,"rgba8sint"),bgra8unorm:new eL("bgra8unorm",h.keyword,"bgra8unorm"),bgra8unorm_srgb:new eL("bgra8unorm_srgb",h.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new eL("rgb10a2unorm",h.keyword,"rgb10a2unorm"),rg11b10float:new eL("rg11b10float",h.keyword,"rg11b10float"),rg32uint:new eL("rg32uint",h.keyword,"rg32uint"),rg32sint:new eL("rg32sint",h.keyword,"rg32sint"),rg32float:new eL("rg32float",h.keyword,"rg32float"),rgba16uint:new eL("rgba16uint",h.keyword,"rgba16uint"),rgba16sint:new eL("rgba16sint",h.keyword,"rgba16sint"),rgba16float:new eL("rgba16float",h.keyword,"rgba16float"),rgba32uint:new eL("rgba32uint",h.keyword,"rgba32uint"),rgba32sint:new eL("rgba32sint",h.keyword,"rgba32sint"),rgba32float:new eL("rgba32float",h.keyword,"rgba32float"),static_assert:new eL("static_assert",h.keyword,"static_assert")},eO.tokens={decimal_float_literal:new eL("decimal_float_literal",h.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new eL("hex_float_literal",h.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new eL("int_literal",h.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new eL("uint_literal",h.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new eL("ident",h.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new eL("and",h.token,"&"),and_and:new eL("and_and",h.token,"&&"),arrow:new eL("arrow ",h.token,"->"),attr:new eL("attr",h.token,"@"),forward_slash:new eL("forward_slash",h.token,"/"),bang:new eL("bang",h.token,"!"),bracket_left:new eL("bracket_left",h.token,"["),bracket_right:new eL("bracket_right",h.token,"]"),brace_left:new eL("brace_left",h.token,"{"),brace_right:new eL("brace_right",h.token,"}"),colon:new eL("colon",h.token,":"),comma:new eL("comma",h.token,","),equal:new eL("equal",h.token,"="),equal_equal:new eL("equal_equal",h.token,"=="),not_equal:new eL("not_equal",h.token,"!="),greater_than:new eL("greater_than",h.token,">"),greater_than_equal:new eL("greater_than_equal",h.token,">="),shift_right:new eL("shift_right",h.token,">>"),less_than:new eL("less_than",h.token,"<"),less_than_equal:new eL("less_than_equal",h.token,"<="),shift_left:new eL("shift_left",h.token,"<<"),modulo:new eL("modulo",h.token,"%"),minus:new eL("minus",h.token,"-"),minus_minus:new eL("minus_minus",h.token,"--"),period:new eL("period",h.token,"."),plus:new eL("plus",h.token,"+"),plus_plus:new eL("plus_plus",h.token,"++"),or:new eL("or",h.token,"|"),or_or:new eL("or_or",h.token,"||"),paren_left:new eL("paren_left",h.token,"("),paren_right:new eL("paren_right",h.token,")"),semicolon:new eL("semicolon",h.token,";"),star:new eL("star",h.token,"*"),tilde:new eL("tilde",h.token,"~"),underscore:new eL("underscore",h.token,"_"),xor:new eL("xor",h.token,"^"),plus_equal:new eL("plus_equal",h.token,"+="),minus_equal:new eL("minus_equal",h.token,"-="),times_equal:new eL("times_equal",h.token,"*="),division_equal:new eL("division_equal",h.token,"/="),modulo_equal:new eL("modulo_equal",h.token,"%="),and_equal:new eL("and_equal",h.token,"&="),or_equal:new eL("or_equal",h.token,"|="),xor_equal:new eL("xor_equal",h.token,"^="),shift_right_equal:new eL("shift_right_equal",h.token,">>="),shift_left_equal:new eL("shift_left_equal",h.token,"<<=")},eO.simpleTokens={"@":eO.tokens.attr,"{":eO.tokens.brace_left,"}":eO.tokens.brace_right,":":eO.tokens.colon,",":eO.tokens.comma,"(":eO.tokens.paren_left,")":eO.tokens.paren_right,";":eO.tokens.semicolon},eO.literalTokens={"&":eO.tokens.and,"&&":eO.tokens.and_and,"->":eO.tokens.arrow,"/":eO.tokens.forward_slash,"!":eO.tokens.bang,"[":eO.tokens.bracket_left,"]":eO.tokens.bracket_right,"=":eO.tokens.equal,"==":eO.tokens.equal_equal,"!=":eO.tokens.not_equal,">":eO.tokens.greater_than,">=":eO.tokens.greater_than_equal,">>":eO.tokens.shift_right,"<":eO.tokens.less_than,"<=":eO.tokens.less_than_equal,"<<":eO.tokens.shift_left,"%":eO.tokens.modulo,"-":eO.tokens.minus,"--":eO.tokens.minus_minus,".":eO.tokens.period,"+":eO.tokens.plus,"++":eO.tokens.plus_plus,"|":eO.tokens.or,"||":eO.tokens.or_or,"*":eO.tokens.star,"~":eO.tokens.tilde,_:eO.tokens.underscore,"^":eO.tokens.xor,"+=":eO.tokens.plus_equal,"-=":eO.tokens.minus_equal,"*=":eO.tokens.times_equal,"/=":eO.tokens.division_equal,"%=":eO.tokens.modulo_equal,"&=":eO.tokens.and_equal,"|=":eO.tokens.or_equal,"^=":eO.tokens.xor_equal,">>=":eO.tokens.shift_right_equal,"<<=":eO.tokens.shift_left_equal},eO.regexTokens={decimal_float_literal:eO.tokens.decimal_float_literal,hex_float_literal:eO.tokens.hex_float_literal,int_literal:eO.tokens.int_literal,uint_literal:eO.tokens.uint_literal,ident:eO.tokens.ident},eO.storage_class=[eO.keywords.function,eO.keywords.private,eO.keywords.workgroup,eO.keywords.uniform,eO.keywords.storage],eO.access_mode=[eO.keywords.read,eO.keywords.write,eO.keywords.read_write],eO.sampler_type=[eO.keywords.sampler,eO.keywords.sampler_comparison],eO.sampled_texture_type=[eO.keywords.texture_1d,eO.keywords.texture_2d,eO.keywords.texture_2d_array,eO.keywords.texture_3d,eO.keywords.texture_cube,eO.keywords.texture_cube_array],eO.multisampled_texture_type=[eO.keywords.texture_multisampled_2d],eO.storage_texture_type=[eO.keywords.texture_storage_1d,eO.keywords.texture_storage_2d,eO.keywords.texture_storage_2d_array,eO.keywords.texture_storage_3d],eO.depth_texture_type=[eO.keywords.texture_depth_2d,eO.keywords.texture_depth_2d_array,eO.keywords.texture_depth_cube,eO.keywords.texture_depth_cube_array,eO.keywords.texture_depth_multisampled_2d],eO.texture_external_type=[eO.keywords.texture_external],eO.any_texture_type=[...eO.sampled_texture_type,...eO.multisampled_texture_type,...eO.storage_texture_type,...eO.depth_texture_type,...eO.texture_external_type],eO.texel_format=[eO.keywords.r8unorm,eO.keywords.r8snorm,eO.keywords.r8uint,eO.keywords.r8sint,eO.keywords.r16uint,eO.keywords.r16sint,eO.keywords.r16float,eO.keywords.rg8unorm,eO.keywords.rg8snorm,eO.keywords.rg8uint,eO.keywords.rg8sint,eO.keywords.r32uint,eO.keywords.r32sint,eO.keywords.r32float,eO.keywords.rg16uint,eO.keywords.rg16sint,eO.keywords.rg16float,eO.keywords.rgba8unorm,eO.keywords.rgba8unorm_srgb,eO.keywords.rgba8snorm,eO.keywords.rgba8uint,eO.keywords.rgba8sint,eO.keywords.bgra8unorm,eO.keywords.bgra8unorm_srgb,eO.keywords.rgb10a2unorm,eO.keywords.rg11b10float,eO.keywords.rg32uint,eO.keywords.rg32sint,eO.keywords.rg32float,eO.keywords.rgba16uint,eO.keywords.rgba16sint,eO.keywords.rgba16float,eO.keywords.rgba32uint,eO.keywords.rgba32sint,eO.keywords.rgba32float],eO.const_literal=[eO.tokens.int_literal,eO.tokens.uint_literal,eO.tokens.decimal_float_literal,eO.tokens.hex_float_literal,eO.keywords.true,eO.keywords.false],eO.literal_or_ident=[eO.tokens.ident,eO.tokens.int_literal,eO.tokens.uint_literal,eO.tokens.decimal_float_literal,eO.tokens.hex_float_literal],eO.element_count_expression=[eO.tokens.int_literal,eO.tokens.uint_literal,eO.tokens.ident],eO.template_types=[eO.keywords.vec2,eO.keywords.vec3,eO.keywords.vec4,eO.keywords.mat2x2,eO.keywords.mat2x3,eO.keywords.mat2x4,eO.keywords.mat3x2,eO.keywords.mat3x3,eO.keywords.mat3x4,eO.keywords.mat4x2,eO.keywords.mat4x3,eO.keywords.mat4x4,eO.keywords.atomic,eO.keywords.bitcast,...eO.any_texture_type],eO.attribute_name=[eO.tokens.ident,eO.keywords.block,eO.keywords.diagnostic],eO.assignment_operators=[eO.tokens.equal,eO.tokens.plus_equal,eO.tokens.minus_equal,eO.tokens.times_equal,eO.tokens.division_equal,eO.tokens.modulo_equal,eO.tokens.and_equal,eO.tokens.or_equal,eO.tokens.xor_equal,eO.tokens.shift_right_equal,eO.tokens.shift_left_equal],eO.increment_operators=[eO.tokens.plus_plus,eO.tokens.minus_minus];class eR{constructor(e,t,s){this.type=e,this.lexeme=t,this.line=s}toString(){return this.lexeme}isTemplateType(){return -1!=eO.template_types.indexOf(this.type)}isArrayType(){return this.type==eO.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class eN{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=null!=e?e:""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new eR(eO.eof,"",this._line)),this._tokens}scanToken(){let e=this._advance();if("\n"==e)return this._line++,!0;if(this._isWhitespace(e))return!0;if("/"==e){if("/"==this._peekAhead()){for(;"\n"!=e;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if("*"==this._peekAhead()){this._advance();let t=1;for(;t>0&&!this._isAtEnd();)if("\n"==(e=this._advance()))this._line++;else if("*"==e){if("/"==this._peekAhead()&&(this._advance(),0==--t))break}else"/"==e&&"*"==this._peekAhead()&&(this._advance(),t++);return!0}}let t=eO.simpleTokens[e];if(t)return this._addToken(t),!0;let s=eO.none,r=this._isAlpha(e),i="_"===e;if(this._isAlphaNumeric(e)){let t=this._peekAhead();for(;this._isAlphaNumeric(t);)e+=this._advance(),t=this._peekAhead()}if(r){let t=eO.keywords[e];if(t)return this._addToken(t),!0}if(r||i)return this._addToken(eO.tokens.ident),!0;for(;;){let t=this._findType(e),r=this._peekAhead();if(">"==e&&(">"==r||"="==r)){let e=!1,s=this._tokens.length-1;for(let t=0;t<5&&s>=0&&-1===eO.assignment_operators.indexOf(this._tokens[s].type);++t,--s)if(this._tokens[s].type===eO.tokens.less_than){s>0&&this._tokens[s-1].isArrayOrTemplateType()&&(e=!0);break}if(e)return this._addToken(t),!0}if(t===eO.none){let r=e,i=0;for(let e=0;e<2;++e)if(r+=this._peekAhead(e),(t=this._findType(r))!==eO.none){i=e;break}if(t===eO.none){if(s===eO.none)return!1;return this._current--,this._addToken(s),!0}e=r,this._current+=i+1}if(s=t,this._isAtEnd())break;e+=this._advance()}return s!==eO.none&&(this._addToken(s),!0)}_findType(e){for(let t in eO.regexTokens){let s=eO.regexTokens[t];if(this._match(e,s.rule))return s}return eO.literalTokens[e]||eO.none}_match(e,t){let s=t.exec(e);return s&&0==s.index&&s[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}_isAlphaNumeric(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||"_"==e||e>="0"&&e<="9"}_isWhitespace(e){return" "==e||"	"==e||"\r"==e}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return(e=e||0,this._current+e>=this._source.length)?"\0":this._source[this._current+e]}_addToken(e){let t=this._source.substring(this._start,this._current);this._tokens.push(new eR(e,t,this._line))}}class eU{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._context=new I,this._deferArrayCountEval=[]}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;let t=[];for(;!this._isAtEnd();){let e=this._global_decl_or_directive();if(!e)break;t.push(e)}if(this._deferArrayCountEval.length>0){for(let e of this._deferArrayCountEval){let t=e.arrayType,s=e.countNode;if(s instanceof ep){let e=s.name,r=this._context.constants.get(e);if(r)try{let e=r.evaluate(this._context);t.count=e}catch(e){}}}this._deferArrayCountEval.length=0}return t}_initialize(e){if(e){if("string"==typeof e){let t=new eN(e);this._tokens=t.scanTokens()}else this._tokens=e}else this._tokens=[];this._current=0}_error(e,t){return{token:e,message:t,toString:function(){return`${t}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==eO.eof}_match(e){if(e instanceof eL)return!!this._check(e)&&(this._advance(),!0);for(let t=0,s=e.length;t<s;++t){let s=e[t];if(this._check(s))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),t)}_check(e){if(this._isAtEnd())return!1;let t=this._peek();if(e instanceof Array){let s=t.type;return -1!=e.indexOf(s)}return t.type==e}_advance(){var e,t;return this._currentLine=null!==(t=null===(e=this._peek())||void 0===e?void 0:e.line)&&void 0!==t?t:-1,!this._isAtEnd()&&this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(eO.tokens.semicolon)&&!this._isAtEnd(););if(this._match(eO.keywords.alias)){let e=this._type_alias();return this._consume(eO.tokens.semicolon,"Expected ';'"),e}if(this._match(eO.keywords.diagnostic)){let e=this._diagnostic();return this._consume(eO.tokens.semicolon,"Expected ';'"),e}if(this._match(eO.keywords.requires)){let e=this._requires_directive();return this._consume(eO.tokens.semicolon,"Expected ';'"),e}if(this._match(eO.keywords.enable)){let e=this._enable_directive();return this._consume(eO.tokens.semicolon,"Expected ';'"),e}let e=this._attribute();if(this._check(eO.keywords.var)){let t=this._global_variable_decl();return null!=t&&(t.attributes=e),this._consume(eO.tokens.semicolon,"Expected ';'."),t}if(this._check(eO.keywords.override)){let t=this._override_variable_decl();return null!=t&&(t.attributes=e),this._consume(eO.tokens.semicolon,"Expected ';'."),t}if(this._check(eO.keywords.let)){let t=this._global_let_decl();return null!=t&&(t.attributes=e),this._consume(eO.tokens.semicolon,"Expected ';'."),t}if(this._check(eO.keywords.const)){let t=this._global_const_decl();return null!=t&&(t.attributes=e),this._consume(eO.tokens.semicolon,"Expected ';'."),t}if(this._check(eO.keywords.struct)){let t=this._struct_decl();return null!=t&&(t.attributes=e),t}if(this._check(eO.keywords.fn)){let t=this._function_decl();return null!=t&&(t.attributes=e),t}return null}_function_decl(){if(!this._match(eO.keywords.fn))return null;let e=this._currentLine,t=this._consume(eO.tokens.ident,"Expected function name.").toString();this._consume(eO.tokens.paren_left,"Expected '(' for function arguments.");let s=[];if(!this._check(eO.tokens.paren_right))do{if(this._check(eO.tokens.paren_right))break;let e=this._attribute(),t=this._consume(eO.tokens.ident,"Expected argument name.").toString();this._consume(eO.tokens.colon,"Expected ':' for argument type.");let r=this._attribute(),i=this._type_decl();null!=i&&(i.attributes=r,s.push(new eS(t,i,e)))}while(this._match(eO.tokens.comma));this._consume(eO.tokens.paren_right,"Expected ')' after function arguments.");let r=null;if(this._match(eO.tokens.arrow)){let e=this._attribute();null!=(r=this._type_decl())&&(r.attributes=e)}return new U(t,s,r,this._compound_statement(),e,this._currentLine)}_compound_statement(){let e=[];for(this._consume(eO.tokens.brace_left,"Expected '{' for block.");!this._check(eO.tokens.brace_right);){let t=this._statement();null!==t&&e.push(t)}return this._consume(eO.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(eO.tokens.semicolon)&&!this._isAtEnd(););if(this._check(eO.tokens.attr)&&this._attribute(),this._check(eO.keywords.if))return this._if_statement();if(this._check(eO.keywords.switch))return this._switch_statement();if(this._check(eO.keywords.loop))return this._loop_statement();if(this._check(eO.keywords.for))return this._for_statement();if(this._check(eO.keywords.while))return this._while_statement();if(this._check(eO.keywords.continuing))return this._continuing_statement();if(this._check(eO.keywords.static_assert))return this._static_assert_statement();if(this._check(eO.tokens.brace_left))return this._compound_statement();let e=null;return null!=(e=this._check(eO.keywords.return)?this._return_statement():this._check([eO.keywords.var,eO.keywords.let,eO.keywords.const])?this._variable_statement():this._match(eO.keywords.discard)?new et:this._match(eO.keywords.break)?new es:this._match(eO.keywords.continue)?new er:this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement())&&this._consume(eO.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){return this._match(eO.keywords.static_assert)?new M(this._optional_paren_expression()):null}_while_statement(){if(!this._match(eO.keywords.while))return null;let e=this._optional_paren_expression();return this._check(eO.tokens.attr)&&this._attribute(),new F(e,this._compound_statement())}_continuing_statement(){return this._match(eO.keywords.continuing)?new B(this._compound_statement()):null}_for_statement(){if(!this._match(eO.keywords.for))return null;this._consume(eO.tokens.paren_left,"Expected '('.");let e=this._check(eO.tokens.semicolon)?null:this._for_init();this._consume(eO.tokens.semicolon,"Expected ';'.");let t=this._check(eO.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(eO.tokens.semicolon,"Expected ';'.");let s=this._check(eO.tokens.paren_right)?null:this._for_increment();return this._consume(eO.tokens.paren_right,"Expected ')'."),this._check(eO.tokens.attr)&&this._attribute(),new z(e,t,s,this._compound_statement())}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(eO.keywords.var)){let e=this._variable_decl();if(null===e)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(eO.tokens.equal)&&(t=this._short_circuit_or_expression()),new j(e.name,e.type,e.storage,e.access,t)}if(this._match(eO.keywords.let)){let e=this._consume(eO.tokens.ident,"Expected name for let.").toString(),t=null;if(this._match(eO.tokens.colon)){let e=this._attribute();null!=(t=this._type_decl())&&(t.attributes=e)}return this._consume(eO.tokens.equal,"Expected '=' for let."),new V(e,t,null,null,this._short_circuit_or_expression())}if(this._match(eO.keywords.const)){let e=this._consume(eO.tokens.ident,"Expected name for const.").toString(),t=null;if(this._match(eO.tokens.colon)){let e=this._attribute();null!=(t=this._type_decl())&&(t.attributes=e)}return this._consume(eO.tokens.equal,"Expected '=' for const."),new q(e,t,null,null,this._short_circuit_or_expression())}return null}_increment_decrement_statement(){let e=this._current,t=this._unary_expression();return null==t?null:this._check(eO.increment_operators)?new $(this._consume(eO.increment_operators,"Expected increment operator").type===eO.tokens.plus_plus?l.increment:l.decrement,t):(this._current=e,null)}_assignment_statement(){let e=null;if(this._check(eO.tokens.brace_right))return null;let t=this._match(eO.tokens.underscore);if(t||(e=this._unary_expression()),!t&&null==e)return null;let s=this._consume(eO.assignment_operators,"Expected assignment operator."),r=this._short_circuit_or_expression();return new G(u.parse(s.lexeme),e,r)}_func_call_statement(){if(!this._check(eO.tokens.ident))return null;let e=this._current,t=this._consume(eO.tokens.ident,"Expected function name."),s=this._argument_expression_list();return null===s?(this._current=e,null):new Z(t.lexeme,s)}_loop_statement(){if(!this._match(eO.keywords.loop))return null;this._check(eO.tokens.attr)&&this._attribute(),this._consume(eO.tokens.brace_left,"Expected '{' for loop.");let e=[],t=this._statement();for(;null!==t;){if(Array.isArray(t))for(let s of t)e.push(s);else e.push(t);t=this._statement()}let s=null;return this._match(eO.keywords.continuing)&&(s=this._compound_statement()),this._consume(eO.tokens.brace_right,"Expected '}' for loop."),new W(e,s)}_switch_statement(){if(!this._match(eO.keywords.switch))return null;let e=this._optional_paren_expression();this._check(eO.tokens.attr)&&this._attribute(),this._consume(eO.tokens.brace_left,"Expected '{' for switch.");let t=this._switch_body();if(null==t||0==t.length)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(eO.tokens.brace_right,"Expected '}' for switch."),new H(e,t)}_switch_body(){let e=[];if(this._match(eO.keywords.case)){let t=this._case_selectors();this._match(eO.tokens.colon),this._check(eO.tokens.attr)&&this._attribute(),this._consume(eO.tokens.brace_left,"Exected '{' for switch case.");let s=this._case_body();this._consume(eO.tokens.brace_right,"Exected '}' for switch case."),e.push(new eT(t,s))}if(this._match(eO.keywords.default)){this._match(eO.tokens.colon),this._check(eO.tokens.attr)&&this._attribute(),this._consume(eO.tokens.brace_left,"Exected '{' for switch default.");let t=this._case_body();this._consume(eO.tokens.brace_right,"Exected '}' for switch default."),e.push(new eP(t))}if(this._check([eO.keywords.default,eO.keywords.case])){let t=this._switch_body();e.push(t[0])}return e}_case_selectors(){let e=[this._shift_expression()];for(;this._match(eO.tokens.comma);)e.push(this._shift_expression());return e}_case_body(){if(this._match(eO.keywords.fallthrough))return this._consume(eO.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(null==e)return[];e instanceof Array||(e=[e]);let t=this._case_body();return 0==t.length?e:[...e,t[0]]}_if_statement(){if(!this._match(eO.keywords.if))return null;let e=this._optional_paren_expression();this._check(eO.tokens.attr)&&this._attribute();let t=this._compound_statement(),s=[];this._match_elseif()&&(this._check(eO.tokens.attr)&&this._attribute(),s=this._elseif_statement(s));let r=null;return this._match(eO.keywords.else)&&(this._check(eO.tokens.attr)&&this._attribute(),r=this._compound_statement()),new Y(e,t,s,r)}_match_elseif(){return this._tokens[this._current].type===eO.keywords.else&&this._tokens[this._current+1].type===eO.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){let t=this._optional_paren_expression(),s=this._compound_statement();return e.push(new eC(t,s)),this._match_elseif()&&(this._check(eO.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){return this._match(eO.keywords.return)?new K(this._short_circuit_or_expression()):null}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(eO.tokens.or_or);)e=new ek(this._previous().toString(),e,this._short_circuit_and_expr());return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(eO.tokens.and_and);)e=new ek(this._previous().toString(),e,this._inclusive_or_expression());return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(eO.tokens.or);)e=new ek(this._previous().toString(),e,this._exclusive_or_expression());return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(eO.tokens.xor);)e=new ek(this._previous().toString(),e,this._and_expression());return e}_and_expression(){let e=this._equality_expression();for(;this._match(eO.tokens.and);)e=new ek(this._previous().toString(),e,this._equality_expression());return e}_equality_expression(){let e=this._relational_expression();return this._match([eO.tokens.equal_equal,eO.tokens.not_equal])?new ek(this._previous().toString(),e,this._relational_expression()):e}_relational_expression(){let e=this._shift_expression();for(;this._match([eO.tokens.less_than,eO.tokens.greater_than,eO.tokens.less_than_equal,eO.tokens.greater_than_equal]);)e=new ek(this._previous().toString(),e,this._shift_expression());return e}_shift_expression(){let e=this._additive_expression();for(;this._match([eO.tokens.shift_left,eO.tokens.shift_right]);)e=new ek(this._previous().toString(),e,this._additive_expression());return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([eO.tokens.plus,eO.tokens.minus]);)e=new ek(this._previous().toString(),e,this._multiplicative_expression());return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([eO.tokens.star,eO.tokens.forward_slash,eO.tokens.modulo]);)e=new ek(this._previous().toString(),e,this._unary_expression());return e}_unary_expression(){return this._match([eO.tokens.minus,eO.tokens.bang,eO.tokens.tilde,eO.tokens.star,eO.tokens.and])?new ex(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){let e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(eO.tokens.bracket_left)){let e=this._short_circuit_or_expression();this._consume(eO.tokens.bracket_right,"Expected ']'.");let t=new ev(e),s=this._postfix_expression();return s&&(t.postfix=s),t}if(this._match(eO.tokens.period)){let e=this._consume(eO.tokens.ident,"Expected member name."),t=this._postfix_expression(),s=new ec(e.lexeme);return t&&(s.postfix=t),s}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_primary_expression(){if(this._match(eO.tokens.ident)){let e=this._previous().toString();if(this._check(eO.tokens.paren_left)){let t=this._argument_expression_list(),s=this._getStruct(e);return null!=s?new ed(s,t):new ef(e,t)}if(this._context.constants.has(e)){let t=this._context.constants.get(e);return new e_(e,t.value)}return new ep(e)}if(this._match(eO.const_literal))return new eg(parseFloat(this._previous().toString()));if(this._check(eO.tokens.paren_left))return this._paren_expression();if(this._match(eO.keywords.bitcast)){this._consume(eO.tokens.less_than,"Expected '<'.");let e=this._type_decl();return this._consume(eO.tokens.greater_than,"Expected '>'."),new em(e,this._paren_expression())}return new ey(this._type_decl(),this._argument_expression_list())}_argument_expression_list(){if(!this._match(eO.tokens.paren_left))return null;let e=[];do{if(this._check(eO.tokens.paren_right))break;let t=this._short_circuit_or_expression();e.push(t)}while(this._match(eO.tokens.comma));return this._consume(eO.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(eO.tokens.paren_left);let e=this._short_circuit_or_expression();return this._match(eO.tokens.paren_right),new eb([e])}_paren_expression(){this._consume(eO.tokens.paren_left,"Expected '('.");let e=this._short_circuit_or_expression();return this._consume(eO.tokens.paren_right,"Expected ')'."),new eb([e])}_struct_decl(){if(!this._match(eO.keywords.struct))return null;let e=this._currentLine,t=this._consume(eO.tokens.ident,"Expected name for struct.").toString();this._consume(eO.tokens.brace_left,"Expected '{' for struct body.");let s=[];for(;!this._check(eO.tokens.brace_right);){let e=this._attribute(),t=this._consume(eO.tokens.ident,"Expected variable name.").toString();this._consume(eO.tokens.colon,"Expected ':' for struct member type.");let r=this._attribute(),i=this._type_decl();null!=i&&(i.attributes=r),this._check(eO.tokens.brace_right)?this._match(eO.tokens.comma):this._consume(eO.tokens.comma,"Expected ',' for struct member."),s.push(new eE(t,i,e))}this._consume(eO.tokens.brace_right,"Expected '}' after struct body.");let r=new en(t,s,e,this._currentLine);return this._context.structs.set(t,r),r}_global_variable_decl(){let e=this._variable_decl();return e&&this._match(eO.tokens.equal)&&(e.value=this._const_expression()),e}_override_variable_decl(){let e=this._override_decl();return e&&this._match(eO.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(eO.keywords.const))return null;let e=this._consume(eO.tokens.ident,"Expected variable name"),t=null;if(this._match(eO.tokens.colon)){let e=this._attribute();null!=(t=this._type_decl())&&(t.attributes=e)}let s=null;if(this._match(eO.tokens.equal)){let e=this._short_circuit_or_expression();if(e instanceof ed)s=e;else if(e instanceof e_&&e.initializer instanceof ed)s=e.initializer;else try{let t=e.evaluate(this._context);s=new eg(t)}catch(t){s=e}}let r=new q(e.toString(),t,"","",s);return this._context.constants.set(r.name,r),r}_global_let_decl(){if(!this._match(eO.keywords.let))return null;let e=this._consume(eO.tokens.ident,"Expected variable name"),t=null;if(this._match(eO.tokens.colon)){let e=this._attribute();null!=(t=this._type_decl())&&(t.attributes=e)}let s=null;return this._match(eO.tokens.equal)&&(s=this._const_expression()),new V(e.toString(),t,"","",s)}_const_expression(){if(this._match(eO.const_literal))return new ec(this._previous().toString());let e=this._type_decl();this._consume(eO.tokens.paren_left,"Expected '('.");let t=[];for(;!this._check(eO.tokens.paren_right)&&(t.push(this._const_expression()),this._check(eO.tokens.comma));)this._advance();return this._consume(eO.tokens.paren_right,"Expected ')'."),new ed(e,t)}_variable_decl(){if(!this._match(eO.keywords.var))return null;let e="",t="";this._match(eO.tokens.less_than)&&(e=this._consume(eO.storage_class,"Expected storage_class.").toString(),this._match(eO.tokens.comma)&&(t=this._consume(eO.access_mode,"Expected access_mode.").toString()),this._consume(eO.tokens.greater_than,"Expected '>'."));let s=this._consume(eO.tokens.ident,"Expected variable name"),r=null;if(this._match(eO.tokens.colon)){let e=this._attribute();null!=(r=this._type_decl())&&(r.attributes=e)}return new j(s.toString(),r,e,t,null)}_override_decl(){if(!this._match(eO.keywords.override))return null;let e=this._consume(eO.tokens.ident,"Expected variable name"),t=null;if(this._match(eO.tokens.colon)){let e=this._attribute();null!=(t=this._type_decl())&&(t.attributes=e)}return new D(e.toString(),t,null)}_diagnostic(){this._consume(eO.tokens.paren_left,"Expected '('");let e=this._consume(eO.tokens.ident,"Expected severity control name.");this._consume(eO.tokens.comma,"Expected ','");let t=this._consume(eO.tokens.ident,"Expected diagnostic rule name.");return this._consume(eO.tokens.paren_right,"Expected ')'"),new Q(e.toString(),t.toString())}_enable_directive(){return new X(this._consume(eO.tokens.ident,"identity expected.").toString())}_requires_directive(){let e=[this._consume(eO.tokens.ident,"identity expected.").toString()];for(;this._match(eO.tokens.comma);){let t=this._consume(eO.tokens.ident,"identity expected.");e.push(t.toString())}return new J(e)}_type_alias(){let e=this._consume(eO.tokens.ident,"identity expected.");this._consume(eO.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(null===t)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);let s=new ee(e.toString(),t);return this._context.aliases.set(s.name,s),s}_type_decl(){if(this._check([eO.tokens.ident,...eO.texel_format,eO.keywords.bool,eO.keywords.f32,eO.keywords.i32,eO.keywords.u32])){let e=this._advance(),t=e.toString();return this._context.structs.has(t)?this._context.structs.get(t):this._context.aliases.has(t)?this._context.aliases.get(t).type:new ei(e.toString())}let e=this._texture_sampler_types();if(e)return e;if(this._check(eO.template_types)){let e=this._advance().toString(),t=null,s=null;return this._match(eO.tokens.less_than)&&(t=this._type_decl(),s=null,this._match(eO.tokens.comma)&&(s=this._consume(eO.access_mode,"Expected access_mode for pointer").toString()),this._consume(eO.tokens.greater_than,"Expected '>' for type.")),new ea(e,t,s)}if(this._match(eO.keywords.ptr)){let e=this._previous().toString();this._consume(eO.tokens.less_than,"Expected '<' for pointer.");let t=this._consume(eO.storage_class,"Expected storage_class for pointer");this._consume(eO.tokens.comma,"Expected ',' for pointer.");let s=this._type_decl(),r=null;return this._match(eO.tokens.comma)&&(r=this._consume(eO.access_mode,"Expected access_mode for pointer").toString()),this._consume(eO.tokens.greater_than,"Expected '>' for pointer."),new eo(e,t.toString(),s,r)}let t=this._attribute();if(this._match(eO.keywords.array)){let e=null,s=-1,r=this._previous(),i=null;if(this._match(eO.tokens.less_than)){e=this._type_decl(),this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);let t="";if(this._match(eO.tokens.comma)){i=this._shift_expression();try{t=i.evaluate(this._context).toString(),i=null}catch(e){t="1"}}this._consume(eO.tokens.greater_than,"Expected '>' for array."),s=t?parseInt(t):0}let n=new el(r.toString(),t,e,s);return i&&this._deferArrayCountEval.push({arrayType:n,countNode:i}),n}return null}_texture_sampler_types(){if(this._match(eO.sampler_type)||this._match(eO.depth_texture_type))return new eu(this._previous().toString(),null,null);if(this._match(eO.sampled_texture_type)||this._match(eO.multisampled_texture_type)){let e=this._previous();this._consume(eO.tokens.less_than,"Expected '<' for sampler type.");let t=this._type_decl();return this._consume(eO.tokens.greater_than,"Expected '>' for sampler type."),new eu(e.toString(),t,null)}if(this._match(eO.storage_texture_type)){let e=this._previous();this._consume(eO.tokens.less_than,"Expected '<' for sampler type.");let t=this._consume(eO.texel_format,"Invalid texel format.").toString();this._consume(eO.tokens.comma,"Expected ',' after texel format.");let s=this._consume(eO.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(eO.tokens.greater_than,"Expected '>' for sampler type."),new eu(e.toString(),t,s)}return null}_attribute(){let e=[];for(;this._match(eO.tokens.attr);){let t=new eI(this._consume(eO.attribute_name,"Expected attribute name").toString(),null);if(this._match(eO.tokens.paren_left)){if(t.value=this._consume(eO.literal_or_ident,"Expected attribute value").toString(),this._check(eO.tokens.comma)){this._advance();do{let e=this._consume(eO.literal_or_ident,"Expected attribute value").toString();t.value instanceof Array||(t.value=[t.value]),t.value.push(e)}while(this._match(eO.tokens.comma))}this._consume(eO.tokens.paren_right,"Expected ')'")}e.push(t)}return 0==e.length?null:e}}class eM{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class eF{constructor(e,t,s){this.name=e,this.type=t,this.attributes=s,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class eB extends eM{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class ez extends eM{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}}class ej extends eM{constructor(e,t,s,r){super(e,s),this.format=t,this.access=r}get isTemplate(){return!0}}(o=c||(c={}))[o.Uniform=0]="Uniform",o[o.Storage=1]="Storage",o[o.Texture=2]="Texture",o[o.Sampler=3]="Sampler",o[o.StorageTexture=4]="StorageTexture";class eD{constructor(e,t,s,r,i,n,a){this.name=e,this.type=t,this.group=s,this.binding=r,this.attributes=i,this.resourceType=n,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class eV{constructor(e,t){this.name=e,this.type=t}}class eq{constructor(e,t){this.align=e,this.size=t}}class e${constructor(e,t,s,r){this.name=e,this.type=t,this.locationType=s,this.location=r,this.interpolation=null}}class eG{constructor(e,t,s,r){this.name=e,this.type=t,this.locationType=s,this.location=r}}class eZ{constructor(e,t=null){this.stage=null,this.inputs=[],this.outputs=[],this.resources=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t}}class eW{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class eH{constructor(e,t,s,r){this.name=e,this.type=t,this.attributes=s,this.id=r}}class eY{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class eK{constructor(e){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new eW,this.functions=[],this._types=new Map,this._functions=new Map,e&&this.update(e)}_isStorageTexture(e){return"texture_storage_1d"==e.name||"texture_storage_2d"==e.name||"texture_storage_2d_array"==e.name||"texture_storage_3d"==e.name}update(e){let t=new eU().parse(e);for(let e of t)e instanceof U&&this._functions.set(e.name,new eY(e));for(let e of t)if(e instanceof en){let t=this._getTypeInfo(e,null);t instanceof eB&&this.structs.push(t)}for(let e of t){if(e instanceof ee){this.aliases.push(this._getAliasInfo(e));continue}if(e instanceof D){let t=this._getAttributeNum(e.attributes,"id",0),s=null!=e.type?this._getTypeInfo(e.type,e.attributes):null;this.overrides.push(new eH(e.name,s,e.attributes,t));continue}if(this._isUniformVar(e)){let t=this._getAttributeNum(e.attributes,"group",0),s=this._getAttributeNum(e.attributes,"binding",0),r=this._getTypeInfo(e.type,e.attributes),i=new eD(e.name,r,t,s,e.attributes,c.Uniform,e.access);this.uniforms.push(i);continue}if(this._isStorageVar(e)){let t=this._getAttributeNum(e.attributes,"group",0),s=this._getAttributeNum(e.attributes,"binding",0),r=this._getTypeInfo(e.type,e.attributes),i=this._isStorageTexture(r),n=new eD(e.name,r,t,s,e.attributes,i?c.StorageTexture:c.Storage,e.access);this.storage.push(n);continue}if(this._isTextureVar(e)){let t=this._getAttributeNum(e.attributes,"group",0),s=this._getAttributeNum(e.attributes,"binding",0),r=this._getTypeInfo(e.type,e.attributes),i=this._isStorageTexture(r),n=new eD(e.name,r,t,s,e.attributes,i?c.StorageTexture:c.Texture,e.access);i?this.storage.push(n):this.textures.push(n);continue}if(this._isSamplerVar(e)){let t=this._getAttributeNum(e.attributes,"group",0),s=this._getAttributeNum(e.attributes,"binding",0),r=this._getTypeInfo(e.type,e.attributes),i=new eD(e.name,r,t,s,e.attributes,c.Sampler,e.access);this.samplers.push(i);continue}if(e instanceof U){let t=this._getAttribute(e,"vertex"),s=this._getAttribute(e,"fragment"),r=this._getAttribute(e,"compute"),i=t||s||r,n=new eZ(e.name,null==i?void 0:i.name);n.startLine=e.startLine,n.endLine=e.endLine,this.functions.push(n),this._functions.get(e.name).info=n,i&&(this._functions.get(e.name).inUse=!0,n.inUse=!0,n.resources=this._findResources(e,!!i),n.inputs=this._getInputs(e.args),n.outputs=this._getOutputs(e.returnType),this.entry[i.name].push(n));continue}}for(let e of this._functions.values())e.info&&(e.info.inUse=e.inUse,this._addCalls(e.node,e.info.calls));for(let e of this.uniforms)this._markStructsInUse(e.type);for(let e of this.storage)this._markStructsInUse(e.type)}_markStructsInUse(e){if(e.isStruct)for(let t of(e.inUse=!0,e.members))this._markStructsInUse(t.type);else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)this._markStructsInUse(e.format);else{let t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var s;for(let r of e.calls){let e=null===(s=this._functions.get(r.name))||void 0===s?void 0:s.info;e&&t.add(e)}}findResource(e,t){for(let s of this.uniforms)if(s.group==e&&s.binding==t)return s;for(let s of this.storage)if(s.group==e&&s.binding==t)return s;for(let s of this.textures)if(s.group==e&&s.binding==t)return s;for(let s of this.samplers)if(s.group==e&&s.binding==t)return s;return null}_findResource(e){for(let t of this.uniforms)if(t.name==e)return t;for(let t of this.storage)if(t.name==e)return t;for(let t of this.textures)if(t.name==e)return t;for(let t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){let t=this._getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){let s=[],r=this,i=[];return e.search(n=>{if(n instanceof O)i.push({});else if(n instanceof R)i.pop();else if(n instanceof j)t&&null!==n.type&&this._markStructsFromAST(n.type),i.length>0&&(i[i.length-1][n.name]=n);else if(n instanceof ed)t&&null!==n.type&&this._markStructsFromAST(n.type);else if(n instanceof V)t&&null!==n.type&&this._markStructsFromAST(n.type),i.length>0&&(i[i.length-1][n.name]=n);else if(n instanceof ep){if(i.length>0&&i[i.length-1][n.name])return;let e=r._findResource(n.name);e&&s.push(e)}else if(n instanceof ef){let i=r._functions.get(n.name);i&&(t&&(i.inUse=!0),e.calls.add(i.node),null===i.resources&&(i.resources=r._findResources(i.node,t)),s.push(...i.resources))}else if(n instanceof Z){let i=r._functions.get(n.name);i&&(t&&(i.inUse=!0),e.calls.add(i.node),null===i.resources&&(i.resources=r._findResources(i.node,t)),s.push(...i.resources))}}),[...new Map(s.map(e=>[e.name,e])).values()]}getBindGroups(){let e=[];function t(t,s){t>=e.length&&(e.length=t+1),void 0===e[t]&&(e[t]=[]),s>=e[t].length&&(e[t].length=s+1)}for(let s of this.uniforms)t(s.group,s.binding),e[s.group][s.binding]=s;for(let s of this.storage)t(s.group,s.binding),e[s.group][s.binding]=s;for(let s of this.textures)t(s.group,s.binding),e[s.group][s.binding]=s;for(let s of this.samplers)t(s.group,s.binding),e[s.group][s.binding]=s;return e}_getOutputs(e,t){if(void 0===t&&(t=[]),e instanceof en)this._getStructOutputs(e,t);else{let s=this._getOutputInfo(e);null!==s&&t.push(s)}return t}_getStructOutputs(e,t){for(let s of e.members)if(s.type instanceof en)this._getStructOutputs(s.type,t);else{let e=this._getAttribute(s,"location")||this._getAttribute(s,"builtin");if(null!==e){let r=this._getTypeInfo(s.type,s.type.attributes),i=this._parseInt(e.value),n=new eG(s.name,r,e.name,i);t.push(n)}}}_getOutputInfo(e){let t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){let s=this._getTypeInfo(e,e.attributes),r=this._parseInt(t.value);return new eG("",s,t.name,r)}return null}_getInputs(e,t){for(let s of(void 0===t&&(t=[]),e))if(s.type instanceof en)this._getStructInputs(s.type,t);else{let e=this._getInputInfo(s);null!==e&&t.push(e)}return t}_getStructInputs(e,t){for(let s of e.members)if(s.type instanceof en)this._getStructInputs(s.type,t);else{let e=this._getInputInfo(s);null!==e&&t.push(e)}}_getInputInfo(e){let t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){let s=this._getAttribute(e,"interpolation"),r=this._getTypeInfo(e.type,e.attributes),i=this._parseInt(t.value),n=new e$(e.name,r,t.name,i);return null!==s&&(n.interpolation=this._parseString(s.value)),n}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);let t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(let t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new eV(e.name,this._getTypeInfo(e.type,null))}_getTypeInfo(e,t){if(this._types.has(e))return this._types.get(e);if(e instanceof el){let s=this._getTypeInfo(e.format,e.attributes),r=new ez(e.name,t);return r.format=s,r.count=e.count,this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof en){let s=new eB(e.name,t);for(let t of(s.startLine=e.startLine,s.endLine=e.endLine,e.members)){let e=this._getTypeInfo(t.type,t.attributes);s.members.push(new eF(t.name,e,t.attributes))}return this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof eu){let s=e.format instanceof ei,r=e.format?s?this._getTypeInfo(e.format,null):new eM(e.format,null):null,i=new ej(e.name,r,t,e.access);return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof ea){let s=e.format?this._getTypeInfo(e.format,null):null,r=new ej(e.name,s,t,e.access);return this._types.set(e,r),this._updateTypeInfo(r),r}let s=new eM(e.name,t);return this._types.set(e,s),this._updateTypeInfo(s),s}_updateTypeInfo(e){var t,s;let r=this._getTypeSize(e);if(e.size=null!==(t=null==r?void 0:r.size)&&void 0!==t?t:0,e instanceof ez){let t=this._getTypeSize(e.format);e.stride=null!==(s=null==t?void 0:t.size)&&void 0!==s?s:0,this._updateTypeInfo(e.format)}e instanceof eB&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let s=0,r=0,i=0,n=0;for(let a=0,o=e.members.length;a<o;++a){let o=e.members[a],l=this._getTypeSize(o);if(!l)continue;null!==(t=this._getAlias(o.type.name))&&void 0!==t||o.type;let u=l.align,h=l.size;s=this._roundUp(u,s+r),r=h,i=s,n=Math.max(n,u),o.offset=s,o.size=h,this._updateTypeInfo(o.type)}e.size=this._roundUp(n,i+r),e.align=n}_getTypeSize(e){var t;if(null==e)return null;let s=this._getAttributeNum(e.attributes,"size",0),r=this._getAttributeNum(e.attributes,"align",0);if(e instanceof eF&&(e=e.type),e instanceof eM){let t=this._getAlias(e.name);null!==t&&(e=t)}{let t=eK._typeInfo[e.name];if(void 0!==t){let i="f16"===e.format?2:1;return new eq(Math.max(r,t.align/i),Math.max(s,t.size/i))}}{let t=eK._typeInfo[e.name.substring(0,e.name.length-1)];if(t){let i="h"===e.name[e.name.length-1]?2:1;return new eq(Math.max(r,t.align/i),Math.max(s,t.size/i))}}if(e instanceof ez){let i=e,n=8,a=8,o=this._getTypeSize(i.format);return null!==o&&(a=o.size,n=o.align),a=i.count*this._getAttributeNum(null!==(t=null==e?void 0:e.attributes)&&void 0!==t?t:null,"stride",this._roundUp(n,a)),s&&(a=s),new eq(Math.max(r,n),Math.max(s,a))}if(e instanceof eB){let t=0,i=0,n=0,a=0,o=0;for(let s of e.members){let e=this._getTypeSize(s.type);null!==e&&(t=Math.max(e.align,t),n=this._roundUp(e.align,n+a),a=e.size,o=n)}return i=this._roundUp(t,o+a),new eq(Math.max(r,t),Math.max(s,i))}return null}_isUniformVar(e){return e instanceof j&&"uniform"==e.storage}_isStorageVar(e){return e instanceof j&&"storage"==e.storage}_isTextureVar(e){return e instanceof j&&null!==e.type&&-1!=eK._textureTypes.indexOf(e.type.name)}_isSamplerVar(e){return e instanceof j&&null!==e.type&&-1!=eK._samplerTypes.indexOf(e.type.name)}_getAttribute(e,t){if(!e||!e.attributes)return null;for(let s of e.attributes)if(s.name==t)return s;return null}_getAttributeNum(e,t,s){if(null===e)return s;for(let r of e)if(r.name==t){let e=null!==r&&null!==r.value?r.value:s;if(e instanceof Array&&(e=e[0]),"number"==typeof e)return e;if("string"==typeof e)return parseInt(e);break}return s}_roundUp(e,t){return Math.ceil(t/e)*e}}function eX(e){return e.format?`${e.name}<${e.format.name}>`:e.name}eK._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},eK._textureTypes=eO.any_texture_type.map(e=>e.name),eK._samplerTypes=eO.sampler_type.map(e=>e.name);class eJ{id;userData={};topology;bufferLayout=[];vertexCount;indices;attributes;constructor(e){this.id=e.id||(0,T.h)("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&(0,b.h)(this.indices.usage===f.l.INDEX)}destroy(){for(let e of(this.indices?.destroy(),Object.values(this.attributes)))e.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices}_calculateVertexCount(e){return e.byteLength/12}}var eQ=s(67105);class e0{modules;moduleUniforms;moduleBindings;moduleUniformsChanged;constructor(e){for(let t of(0,eQ.WQ)(Object.values(e).filter(e=>e.dependencies)))e[t.name]=t;for(let[t,s]of(x.c.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={},Object.entries(e)))this.moduleUniforms[t]=s.defaultUniforms||{},this.moduleBindings[t]={}}destroy(){}setProps(e){for(let t of Object.keys(e)){let s=e[t],r=this.modules[t];if(!r){x.c.warn(`Module ${t} not found`)();continue}let i=this.moduleUniforms[t],n=this.moduleBindings[t],a=r.getUniforms?.(s,i)||s,{uniforms:o,bindings:l}=(0,P.y)(a);this.moduleUniforms[t]={...i,...o},this.moduleBindings[t]={...n,...l}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindings(){let e={};for(let t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){let e={};for(let[t,s]of Object.entries(this.moduleUniforms))for(let[r,i]of Object.entries(s))e[`${t}.${r}`]={type:this.modules[t].uniformTypes?.[r],value:String(i)};return e}}var e1=s(65126);class e2 extends e1._{static defaultProps={...e1._.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0};get[Symbol.toStringTag](){return"ComputePipeline"}hash="";constructor(e,t){super(e,t,e2.defaultProps)}}class e3{static defaultProps={...g.h.defaultProps};device;_hashCounter=0;_hashes={};_renderPipelineCache={};_computePipelineCache={};static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new e3(e),e._lumaData.defaultPipelineFactory}constructor(e){this.device=e}createRenderPipeline(e){let t={...g.h.defaultProps,...e},s=this._hashRenderPipeline(t);if(!this._renderPipelineCache[s]){let e=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:void 0});e.hash=s,this._renderPipelineCache[s]={pipeline:e,useCount:0}}return this._renderPipelineCache[s].useCount++,this._renderPipelineCache[s].pipeline}createComputePipeline(e){let t={...e2.defaultProps,...e},s=this._hashComputePipeline(t);if(!this._computePipelineCache[s]){let e=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0});e.hash=s,this._computePipelineCache[s]={pipeline:e,useCount:0}}return this._computePipelineCache[s].useCount++,this._computePipelineCache[s].pipeline}release(e){let t=e.hash,s=e instanceof e2?this._computePipelineCache:this._renderPipelineCache;s[t].useCount--,0===s[t].useCount&&(s[t].pipeline.destroy(),delete s[t])}_hashComputePipeline(e){let t=this._getHash(e.shader.source);return`${t}`}_hashRenderPipeline(e){let t=this._getHash(e.vs.source),s=e.fs?this._getHash(e.fs.source):0,r=this._getHash(JSON.stringify(e.bufferLayout));if("webgl"===this.device.type)return`${t}/${s}V-BL${r}`;{let i=this._getHash(JSON.stringify(e.parameters));return`${t}/${s}V-T${e.topology}P${i}BL${r}`}}_getHash(e){return void 0===this._hashes[e]&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}}var e4=s(10777);class e6{static defaultProps={...e4.e.defaultProps};device;_cache={};static getDefaultShaderFactory(e){return e._lumaData.defaultShaderFactory||=new e6(e),e._lumaData.defaultShaderFactory}constructor(e){this.device=e}createShader(e){let t=this._hashShader(e),s=this._cache[t];if(!s){let r=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=s={shader:r,useCount:0}}return s.useCount++,s.shader}release(e){let t=this._hashShader(e),s=this._cache[t];s&&(s.useCount--,0===s.useCount&&(delete this._cache[t],s.shader.destroy()))}_hashShader(e){return`${e.stage}:${e.source}`}}let e8=null,e5=null;class e9{static defaultProps={...g.h.defaultProps,source:null,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:E.q.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0};device;id;source;vs;fs;pipelineFactory;shaderFactory;userData={};parameters;topology;bufferLayout;isInstanced=void 0;instanceCount=0;vertexCount;indexBuffer=null;bufferAttributes={};constantAttributes={};bindings={};uniforms={};vertexArray;transformFeedback=null;pipeline;shaderInputs;_uniformStore;_attributeInfos={};_gpuGeometry=null;_getModuleUniforms;props;_pipelineNeedsUpdate="newly created";_needsRedraw="initializing";_destroyed=!1;_lastDrawTimestamp=-1;constructor(e,t){this.props={...e9.defaultProps,...t},t=this.props,this.id=t.id||(0,T.h)("model"),this.device=e,Object.assign(this.userData,t.userData);let s=Object.fromEntries(this.props.modules?.map(e=>[e.name,e])||[]);this.setShaderInputs(t.shaderInputs||new e0(s));let r={type:e.type,shaderLanguage:e.info.shadingLanguage,shaderLanguageVersion:e.info.shadingLanguageVersion,gpu:e.info.gpu,features:e.features},i=(this.props.modules?.length>0?this.props.modules:this.shaderInputs?.getModules())||[];if("webgpu"===this.device.type&&this.props.source){this.props.shaderLayout||=function(e){let t;let s={attributes:[],bindings:[]};try{t=function(e){try{return new eK(e)}catch(t){if(t instanceof Error)throw t;let e="WGSL parse error";throw"object"==typeof t&&t?.message&&(e+=`: ${t.message} `),"object"==typeof t&&t?.token&&(e+=t.token.line||""),Error(e,{cause:t})}}(e)}catch(e){return x.c.error(e.message)(),s}for(let e of t.uniforms){let t=[];for(let s of e.type?.members||[])t.push({name:s.name,type:eX(s.type)});s.bindings.push({type:"uniform",name:e.name,location:e.binding,group:e.group,members:t})}let r=t.entry.vertex[0],i=r?.inputs.length||0;for(let e=0;e<i;e++){let t=r.inputs[e];if("location"===t.locationType){let e=eX(t.type);s.attributes.push({name:t.name,location:Number(t.location),type:e})}}return s}(this.props.source);let{source:e,getUniforms:t}=this.props.shaderAssembler.assembleShader({platformInfo:r,...this.props,modules:i});this.source=e,this._getModuleUniforms=t}else{let{vs:e,fs:t,getUniforms:s}=this.props.shaderAssembler.assembleShaderPair({platformInfo:r,...this.props,modules:i});this.vs=e,this.fs=t,this._getModuleUniforms=s}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||e3.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||e6.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.uniforms&&this.setUniforms(t.uniforms),t.moduleSettings&&this.updateModuleSettings(t.moduleSettings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}destroy(){this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),this._gpuGeometry?.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");let e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||=e}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){let t;this.predraw();try{this._logDrawCallStart(),this.pipeline=this._updatePipeline(),this.pipeline.setBindings(this.bindings,{disableWarnings:this.props.disableWarnings}),(0,T.n)(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);let{indexBuffer:s}=this.vertexArray,r=s?s.byteLength/("uint32"===s.indexType?4:2):void 0;t=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:r,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{this._logDrawCallEnd()}return this._logFramebuffer(e),t?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",t}setGeometry(e){this._gpuGeometry?.destroy();let t=e&&function(e,t){if(t instanceof eJ)return t;let s=function(e,t){if(!t.indices)return;let s=t.indices.value;return e.createBuffer({usage:f.l.INDEX,data:s})}(e,t),{attributes:r,bufferLayout:i}=function(e,t){let s=[],r={};for(let[i,n]of Object.entries(t.attributes)){let t=i;switch(i){case"POSITION":t="positions";break;case"NORMAL":t="normals";break;case"TEXCOORD_0":t="texCoords";break;case"COLOR_0":t="colors"}r[t]=e.createBuffer({data:n.value,id:`${i}-buffer`});let{value:a,size:o,normalized:l}=n;s.push({name:t,format:(0,C.sk)(a,o,l)})}return{attributes:r,bufferLayout:s,vertexCount:t._calculateVertexCount(t.attributes,t.indices)}}(e,t);return new eJ({topology:t.topology||"triangle-list",bufferLayout:i,vertexCount:t.vertexCount,indices:s,attributes:r})}(this.device,e);t&&(this.setTopology(t.topology||"triangle-list"),this.bufferLayout=e7(t.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(t)),this._gpuGeometry=t}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){this.bufferLayout=this._gpuGeometry?e7(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){!function e(t,s,r){if(t===s)return!0;if(!r||!t||!s)return!1;if(Array.isArray(t)){if(!Array.isArray(s)||t.length!==s.length)return!1;for(let i=0;i<t.length;i++)if(!e(t[i],s[i],r-1))return!1;return!0}if(Array.isArray(s))return!1;if("object"==typeof t&&"object"==typeof s){let i=Object.keys(t),n=Object.keys(s);if(i.length!==n.length)return!1;for(let n of i)if(!s.hasOwnProperty(n)||!e(t[n],s[n],r-1))return!1;return!0}return!1}(e,this.parameters,2)&&(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,void 0===this.isInstanced&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){for(let t of(this.shaderInputs=e,this._uniformStore=new A(this.shaderInputs.modules),Object.keys(this.shaderInputs.modules))){let e=this._uniformStore.getManagedUniformBuffer(this.device,t);this.bindings[`${t}Uniforms`]=e}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindings()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){for(let[s,r]of(e.indices&&x.c.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)(),Object.entries(e))){let e=this.bufferLayout.find(e=>te(e).includes(s));if(!e){x.c.warn(`Model(${this.id}): Missing layout for buffer "${s}".`)();continue}let i=te(e),n=!1;for(let e of i){let t=this._attributeInfos[e];t&&(this.vertexArray.setBuffer(t.location,r),n=!0)}n||(t?.disableWarnings??this.props.disableWarnings)||x.c.warn(`Model(${this.id}): Ignoring buffer "${r.id}" for unknown attribute "${s}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(let[s,r]of Object.entries(e)){let e=this._attributeInfos[s];e?this.vertexArray.setConstantWebGL(e.location,r):(t?.disableWarnings??this.props.disableWarnings)||x.c.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${s}"`)()}this.setNeedsRedraw("constants")}setUniforms(e){(0,T.n)(e)||(this.pipeline.setUniformsWebGL(e),Object.assign(this.uniforms,e)),this.setNeedsRedraw("uniforms")}updateModuleSettings(e){let{bindings:t,uniforms:s}=(0,P.y)(this._getModuleUniforms(e));Object.assign(this.bindings,t),Object.assign(this.uniforms,s),this.setNeedsRedraw("moduleSettings")}_getBindingsUpdateTimestamp(){let e=0;for(let t of Object.values(this.bindings))t instanceof d.s?e=Math.max(e,t.texture.updateTimestamp):t instanceof f.l||t instanceof p.x?e=Math.max(e,t.updateTimestamp):t instanceof _.Z||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){let t={...e.attributes};for(let[e]of Object.entries(t))this.pipeline.shaderLayout.attributes.find(t=>t.name===e)||"positions"===e||delete t[e];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||=e,this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(x.c.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;let s=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debug:this.props.debugShaders}),r=null;this.source?r=s:this.fs&&(r=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debug:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,vs:s,fs:r}),this._attributeInfos=(0,S.G5)(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_lastLogTime=0;_logOpen=!1;_logDrawCallStart(){let e=x.c.level>3?0:1e4;x.c.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,x.c.group(2,`>>> DRAWING MODEL ${this.id}`,{collapsed:x.c.level<=2})())}_logDrawCallEnd(){if(this._logOpen){let e=function(e,t){let s={},r="Values";if(0===e.attributes.length&&!e.varyings?.length)return{"No attributes or varyings":{[r]:"N/A"}};for(let t of e.attributes)if(t){let e=`${t.location} ${t.name}: ${t.type}`;s[`in ${e}`]={[r]:t.stepMode||"vertex"}}for(let t of e.varyings||[]){let e=`${t.location} ${t.name}`;s[`out ${e}`]={[r]:JSON.stringify(t.accessor)}}return s}(this.pipeline.shaderLayout,this.id);x.c.table(2,e)();let t=this.shaderInputs.getDebugTable();for(let[e,s]of Object.entries(this.uniforms))t[e]={value:s};x.c.table(2,t)();let s=this._getAttributeDebugTable();x.c.table(2,this._attributeInfos)(),x.c.table(2,s)(),x.c.groupEnd(2)(),this._logOpen=!1}}_drawCount=0;_logFramebuffer(e){let t=x.c.get("framebuffer");if(this._drawCount++,!t||this._drawCount++>3&&this._drawCount%60)return;let s=e.props.framebuffer;s&&function(e,{id:t,minimap:s,opaque:r,top:i="0",left:n="0",rgbaScale:a=1}){e8||((e8=document.createElement("canvas")).id=t,e8.title=t,e8.style.zIndex="100",e8.style.position="absolute",e8.style.top=i,e8.style.left=n,e8.style.border="blue 1px solid",e8.style.transform="scaleY(-1)",document.body.appendChild(e8),e5=e8.getContext("2d")),(e8.width!==e.width||e8.height!==e.height)&&(e8.width=e.width/2,e8.height=e.height/2,e8.style.width="400px",e8.style.height="400px");let o=e.device.readPixelsToArrayWebGL(e),l=e5.createImageData(e.width,e.height);for(let e=0;e<o.length;e+=4)l.data[0+e+0]=o[e+0]*a,l.data[0+e+1]=o[e+1]*a,l.data[0+e+2]=o[e+2]*a,l.data[0+e+3]=r?255:o[e+3]*a;e5.putImageData(l,0,0)}(s,{id:s.id,minimap:!0})}_getAttributeDebugTable(){let e={};for(let[t,s]of Object.entries(this._attributeInfos))e[s.location]={name:t,type:s.shaderType,values:this._getBufferOrConstantValues(this.vertexArray.attributes[s.location],s.bufferDataType)};if(this.vertexArray.indexBuffer){let{indexBuffer:t}=this.vertexArray,s="uint32"===t.indexType?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:s.toString()}}return e}_getBufferOrConstantValues(e,t){let s=(0,C.Xs)(t);return(e instanceof f.l?new s(e.debugData):e).toString()}}function e7(e,t){let s=[...e];for(let e of t){let t=s.findIndex(t=>t.name===e.name);t<0?s.push(e):s[t]=e}return s}function te(e){return e.attributes?e.attributes?.map(e=>e.attribute):[e.name]}}}]);