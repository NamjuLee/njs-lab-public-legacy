"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[55053],{52069:function(e,t,s){s.d(t,{AC:function(){return u},Fz:function(){return c},Q_:function(){return g},_C:function(){return p},fB:function(){return d},i1:function(){return h},jO:function(){return f},kE:function(){return i},ks:function(){return l},s8:function(){return m},sc:function(){return n}});var r=s(94605);let o="upload-assets",a=()=>Error();class n extends r.Z{constructor(){super(`${o}:unsupported`,"Layer does not support asset uploads.",a())}}class l extends r.Z{constructor(){super(`${o}:no-glb-support`,"Layer does not support glb.",a())}}class i extends r.Z{constructor(){super(`${o}:no-supported-source`,"No supported external source found",a())}}class u extends r.Z{constructor(){super(`${o}:not-base-64`,"Expected gltf data in base64 format after conversion.",a())}}class p extends r.Z{constructor(){super(`${o}:unable-to-prepare-options`,"Unable to prepare uploadAsset request options.",a())}}class c extends r.Z{constructor(e,t){super(`${o}:bad-response`,`Bad response. Uploaded ${e} items and received ${t} results.`,a())}}class d extends r.Z{constructor(e,t){super(`${o}-layer:upload-failed`,`Failed to upload mesh file ${e}. Error code: ${t?.code??"-1"}. Error message: ${t?.messages??"unknown"}`,a())}}class f extends r.Z{constructor(e){super(`${o}-layer:unsupported-format`,`The service allowed us to upload an asset of FormatID ${e}, but it does not list it in its supported formats.`,a())}}class m extends r.Z{constructor(){super(`${o}:convert3D-failed`,"convert3D failed.")}}class g extends r.Z{constructor(){super("invalid-input:no-model","No supported model found")}}class h extends r.Z{constructor(){super("invalid-input:multiple-models","Multiple supported models found")}}},55053:function(e,t,s){s.d(t,{uploadAssets:function(){return A}});var r=s(54748),o=s(37180),a=s(65223),n=s(31124),l=s(21684),i=s(72659),u=s(85222),p=s(6817),c=s(52069);let d={prepareAssetItems:.9,uploadAssetItems:.1},f={uploadEditSource:.5,serviceAssetsToGlb:.5},m={meshToAssetBlob:.5,uploadAssetBlobs:.5};var g=s(96922),h=s(1662),y=s(59528);function w(e,t=e=>{},s){return new _(e,t,s)}class _{constructor(e,t=e=>{},s){if(this.onProgress=t,this.taskName=s,this._progressMap=new Map,this._startTime=void 0,this._timingsMap=new Map,"number"==typeof e){this._weights={};for(let t=0;t<e;t++){let s=t,r=1/e;this._weights[s]=r,this._progressMap.set(s,0)}}else this._weights=e;this.emitProgress()}emitProgress(){let e=0;for(let[t,s]of this._progressMap.entries())e+=s*this._weights[t];if(1===e&&(0,o.Z)("enable-feature:esri-3dofl-upload-timings")){let e=Math.round(performance.now()-(this._startTime??0))/1e3;for(let[t,s]of(console.log(`${this.taskName} done in ${e} sec`),this._timingsMap)){let r=Math.round(s.end-s.start)/1e3,o=Math.round(r/e*100);console.log(this.taskName??"Task",{stepKey:t,stepTime:r,relativeTime:o})}}this.onProgress(e)}setProgress(e,t){if(this._progressMap.set(e,t),(0,o.Z)("enable-feature:esri-3dofl-upload-timings")){let s=performance.now();this._startTime??=s;let r=(0,y.s1)(this._timingsMap,e,()=>({start:s,end:0}));1===t&&(r.end=s)}this.emitProgress()}simulate(e,t){return P(t=>this.setProgress(e,t),t)}makeOnProgress(e){return t=>this.setProgress(e,t)}}function P(e=e=>{},t=T){let s=performance.now();e(0);let r=setInterval(()=>{e(1-Math.exp(-(performance.now()-s)/t))},b);return(0,h.kB)(()=>{clearInterval(r),e(1)})}let b=(0,l.HA)(50),T=(0,l.HA)(1e3);async function k({data:e,name:t,description:s},o,a){let u=null;try{let p=(0,i.v_)(o,"uploads"),c=(0,i.v_)(p,"info"),{data:d}=await (0,r.Z)(c,{query:{f:"json"},responseType:"json"});(0,n.k_)(a);let f=(0,g.M8)(o),m=1e6*d.maxUploadFileSize,h=f?Math.min(2e7,m):2e7;if(e.size>(f?2e9:m))throw Error("Data too large");let y=(0,i.v_)(p,"register"),{data:_}=await (0,r.Z)(y,{query:{f:"json",itemName:t.replaceAll("/","_").replaceAll("\\","_"),description:s},responseType:"json",method:"post"});if((0,n.k_)(a),!_.success)throw Error("Registration failed");let{itemID:P}=_.item;u=(0,i.v_)(p,P);let b=(0,i.v_)(u,"uploadPart"),T=Math.ceil(e.size/h),k=[];for(let t=0;t<T;++t)k.push(e.slice(t*h,Math.min((t+1)*h,e.size)));let v=k.slice().reverse(),A=[],x=w(T,a?.onProgress,"uploadItem"),E=async()=>{for(;0!==v.length;){let e=k.length-v.length,t=v.pop(),s=new FormData,o=x.simulate(e,function(e,t=10){return(0,l.up)((0,l._H)(8e-6*e/t))}(t.size));try{s.append("f","json"),s.append("file",t),s.append("partId",`${e}`);let{data:o}=await (0,r.Z)(b,{timeout:0,body:s,responseType:"json",method:"post"});if((0,n.k_)(a),!o.success)throw Error("Part upload failed")}finally{o.remove()}}};for(let e=0;e<3&&0!==v.length;++e)A.push(E());await Promise.all(A);let Z=(0,i.v_)(u,"commit"),{data:j}=await (0,r.Z)(Z,{query:{f:"json",parts:k.map((e,t)=>t).join(",")},responseType:"json",method:"post"});if((0,n.k_)(a),!j.success)throw Error("Commit failed");return j.item}catch(e){if(null!=u){let e=(0,i.v_)(u,"delete");await (0,r.Z)(e,{query:{f:"json"},responseType:"json",method:"post"})}throw e}}var v=s(4193);async function A(e,t,s){let r=e.length;if(!r)return s?.onProgress?.(1),[];let o=w(r,s?.onProgress,"uploadAssets");return Promise.all(e.map((e,r)=>x(e,t,{...s,onProgress:o.makeOnProgress(r)})))}async function x(e,{layer:t,ongoingUploads:s},r){let o=s.get(e);if(o)return o;if(!(t.infoFor3D&&t.url))throw new c.sc;if(function(e,t){let{parsedUrl:s}=t;return null!=s&&e.metadata.externalSources.some(e=>(0,p.JG)(e,s))}(e,t))return r?.onProgress?.(1),e;let a=E(e,t,r);s.set(e,a);try{await a}finally{s.delete(e)}return e}async function E(e,t,s){let{metadata:r}=e,{displaySource:o}=r,a=N(o?.source,t),l=!!a,i=r.externalSources.length>0,u=l?Z(a,t,s):i?j(e,t,s):F(e,t,s),p=await u;return(0,n.k_)(s),e.addExternalSources([p]),e}async function Z(e,t,s){return{source:await M(e,t,s),original:!0}}async function j(e,t,s){let r=B(t),{externalSources:o}=e.metadata,a=function(e,t){for(let s of e){let e=N(s.source,t);if(e)return e}return null}(o,t);if(!a)throw new c.kE;let n=w(f,s?.onProgress,"uploadConvertibleSource"),i=await M(a,t,{onProgress:n.makeOnProgress("uploadEditSource")});e.addExternalSources([{source:i,original:!0}]);let u=a.reduce((e,{asset:t})=>t instanceof File?e+t.size:e,0),p=n.simulate("serviceAssetsToGlb",function(e,t=10){return(0,l.up)((0,l._H)(8e-6*e/t))}(u));try{return{source:await O(i,t,r)}}finally{p.remove()}}async function F(e,t,s){let r=w(m,s?.onProgress,"uploadLocalMesh"),o=$(e,t,{...s,onProgress:r.makeOnProgress("meshToAssetBlob")});return{source:await I([o],t,{...s,onProgress:r.makeOnProgress("uploadAssetBlobs")}),extent:e.extent.clone(),original:!0}}async function $(e,t,s){let r=B(t),o=await e.load(s),a=await o.toBinaryGLTF({origin:o.origin,signal:s?.signal,ignoreLocalTransform:!0});return(0,n.k_)(s),{blob:new Blob([a],{type:"model/gltf-binary"}),assetName:`${(0,u.zS)()}.glb`,assetType:r}}function N(e,t){if(!e)return null;let{infoFor3D:{supportedFormats:s,editFormats:r}}=t,o=(0,p.zE)(e),a=[],n=!1;for(let e=0;e<o.length;++e){let t=function(e,t){let s=(0,p.vj)(e,t);return s?{asset:e,assetType:s}:null}(o[e],s);if(!t)return null;r.includes(t.assetType)&&(n=!0),a.push(t)}return n?a:null}async function M(e,t,s){return I(e.map(e=>S(e,s)),t,s)}async function I(e,t,s){let r=w(d,s?.onProgress,"uploadAssetBlobs"),o=await function(e,t,s){let r=w(e.length,s?.onProgress,"prepareAssetItems");return Promise.all(e.map(async(e,o)=>{let a=D(await e,t,{...s,onProgress:r.makeOnProgress(o)});return(0,n.k_)(s),a}))}(e,t,{...s,onProgress:r.makeOnProgress("prepareAssetItems")});(0,n.k_)(s);let a=o.map(({item:e})=>e),{uploadResults:l}=await C(a,t,{...s,onProgress:r.makeOnProgress("uploadAssetItems")});return(0,n.k_)(s),e.map((e,s)=>(function(e,t,s){let{success:r}=t;if(!r){let{error:s}=t;throw new c.fB(e.assetName,s)}let{assetHash:o}=t,{assetName:a,item:{assetType:n}}=e,{infoFor3D:{supportedFormats:l}}=s,i=(0,v.d1)(n,l);if(!i)throw new c.jO(n);return new p.CP(a,i,[new p.LL(`${s.parsedUrl.path}/assets/${o}`,o)])})(o[s],l[s],t))}async function S(e,t){let{asset:s,assetType:r}=e;if(s instanceof File)return{blob:s,assetName:s.name,assetType:r};let o=await s.toBlob(t);return(0,n.k_)(t),{blob:o,assetName:s.assetName,assetType:r}}async function D(e,t,s){let{blob:r,assetType:o,assetName:l}=e,u=null;try{let e=await k({data:r,name:l},t.url,s);(0,n.k_)(s),u={assetType:o,assetUploadId:e.itemID}}catch(e){(0,n.r9)(e),a.Z.getLogger("esri.layers.graphics.sources.support.uploadAssets").warnOnce(`Service ${t.url} does not support the REST Uploads API.`)}if(!u){let e=await (0,i.IR)(r);if((0,n.k_)(s),!e.isBase64)throw new c.AC;u={assetType:o,assetData:e.data}}if(!u)throw new c._C;return{item:u,assetName:l}}async function C(e,t,s){let o=P(s?.onProgress);try{let o=await (0,r.Z)((0,i.v_)(t.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(e)},method:"post",responseType:"json"});if((0,n.k_)(s),o.data.uploadResults.length!==e.length)throw new c.Fz(e.length,o.data.uploadResults.length);return o.data}finally{o.remove()}}async function O(e,t,s){let o;let a=e.map(({assetName:e,parts:t})=>({assetName:e,assetHash:t[0].partHash})),n=t.capabilities?.operations.supportsAsyncConvert3D,l={f:"json",assets:JSON.stringify(a),transportType:"esriTransportTypeUrl",targetFormat:s,async:n},u=(0,i.v_)(t.parsedUrl.path,"convert3D");try{o=(await (n?U:function(e,t){return(0,r.Z)(e,t)})(u,{query:l,responseType:"json",timeout:0})).data}catch(e){throw new c.s8}let{supportedFormats:d}=t.infoFor3D;return o.assets.map(e=>{let t=(0,v.S0)(e.contentType,d);if(!t)throw new c.jO(t);return new p.CP(e.assetName,e.contentType,[new p.LL(e.assetURL,e.assetHash)])})}async function U(e,t){let s=(await (0,r.Z)(e,t)).data.statusUrl;for(;;){let e=(await (0,r.Z)(s,{query:{f:"json"},responseType:"json"})).data;switch(e.status){case"Completed":return(0,r.Z)(e.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw Error(e.status);case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw Error()}await (0,n.e4)(L)}}function B(e){let{infoFor3D:t}=e,s=(0,v.S0)("model/gltf-binary",t.supportedFormats)??(0,v.Ow)("glb",t.supportedFormats);if(!s)throw new c.ks;return s}let L=(0,l.HA)(1e3)}}]);