"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[25845],{57812:function(t,i,s){s.d(i,{z:function(){return a}});var r=s(85515);class a{constructor(t,i){this._storage=new r.WJ,this.id="",this.name="",this.size=0,this._storage.maxSize=t,this._storage.register(this),i&&this._storage.registerRemoveFunc("",i)}destroy(){this._storage.deregister(this),this._storage.destroy()}put(t,i,s=1){this._storage.put(this,t,i,s,1)}pop(t){return this._storage.pop(this,t)}get(t){return this._storage.get(this,t)}clear(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(t){this._storage.maxSize=t}resetHitRate(){}}},85515:function(t,i,s){s.d(i,{WJ:function(){return u},Xq:function(){return l}});var r,a,n=s(35313);(r=a||(a={}))[r.ALL=0]="ALL",r[r.SOME=1]="SOME";class l{constructor(t,i,s){this.name=t,this._storage=i,this.id=o+++":",this.size=0,this.maxSize=-1,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),s&&(this._storage.registerRemoveFunc(this.id,s),this._removeFunc=!0)}destroy(){this._storage.clear(this),this._removeFunc&&this._storage.deregisterRemoveFunc(this.id),this._storage.deregister(this),this._storage=null}get hitRate(){return this._hit/(this._hit+this._miss)}get storageSize(){return this._storage.size}getSize(t){return this._storage.getSize(this,t)}resetHitRate(){this._hit=this._miss=0}put(t,i,s,r=0){this._storage.put(this,t,i,s,r)}pop(t){let i=this._storage.pop(this,t);return void 0===i?++this._miss:++this._hit,i}get(t){let i=this._storage.get(this,t);return void 0===i?++this._miss:++this._hit,i}peek(t){return this._storage.peek(this,t)}updateSize(t,i,s){this._storage.updateSize(this,t,i,s)}clear(){this._storage.clear(this)}clearAll(){this._storage.clearAll()}get performanceInfo(){return this._storage.performanceInfo}resetStats(){this._storage.resetStats()}}class u{get size(){return this._size}constructor(t=10485760){this._maxSize=t,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new n.Z,this._users=new n.Z}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(t){this._users.push(t)}deregister(t){this._users.removeUnordered(t)}registerRemoveFunc(t,i){this._removeFuncs.push([t,i])}deregisterRemoveFunc(t){this._removeFuncs.filterInPlace(i=>i[0]!==t)}get maxSize(){return this._maxSize}set maxSize(t){this._maxSize=Math.max(t,-1),this._checkSize()}getSize(t,i){let s=this._db.get(t.id+i);return s?.size??0}put(t,i,s,r,n){i=t.id+i;let l=this._db.get(i);return(l&&(this._size-=l.size,t.size-=l.size,this._db.delete(i),l.entry!==s&&this._notifyRemove(i,l.entry,l.size,a.ALL)),r>this._maxSize)?void this._notifyRemove(i,s,r,a.ALL):void 0===s?void console.warn("Refusing to cache undefined entry "):!r||r<0?(console.warn(`Refusing to cache entry with size ${r} for key ${i}`),void this._notifyRemove(i,s,0,a.ALL)):void(this._db.set(i,new h(s,r,1+Math.max(n,-4)- -3)),this._size+=r,t.size+=r,this._checkSize())}updateSize(t,i,s,r){i=t.id+i;let n=this._db.get(i);if(n&&n.entry===s){for(this._size-=n.size,t.size-=n.size;r>this._maxSize;){let t=this._notifyRemove(i,s,r,a.SOME);if(!(null!=t&&t>0))return void this._db.delete(i);r=t}n.size=r,this._size+=r,t.size+=r,this._checkSize()}}pop(t,i){i=t.id+i;let s=this._db.get(i);if(s)return this._size-=s.size,t.size-=s.size,this._db.delete(i),++this._hit,s.entry;++this._miss}get(t,i){i=t.id+i;let s=this._db.get(i);if(void 0!==s)return this._db.delete(i),s.lives=s.lifetime,this._db.set(i,s),++this._hit,s.entry;++this._miss}peek(t,i){let s=this._db.get(t.id+i);return s?++this._hit:++this._miss,s?.entry}get performanceInfo(){let t={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},i={},s=[];this._db.forEach((t,r)=>{let a=t.lifetime;s[a]=(s[a]||0)+t.size,this._users.forAll(s=>{let{id:a,name:n}=s;if(r.startsWith(a)){let s=i[n]||0;i[n]=s+t.size}})});let r={};this._users.forAll(t=>{let s=t.name;if("hitRate"in t&&"number"==typeof t.hitRate&&!isNaN(t.hitRate)&&t.hitRate>0){let a=i[s]||0;i[s]=a,r[s]=Math.round(100*t.hitRate)+"%"}else r[s]="0%"});let a=Object.keys(i);a.sort((t,s)=>i[s]-i[t]),a.forEach(s=>t[s]=Math.round(i[s]/1048576)+"MB / "+r[s]);for(let i=s.length-1;i>=0;--i){let r=s[i];r&&(t["Priority "+(i+-3-1)]=Math.round(r/this._size*100)+"%")}return t}resetStats(){this._hit=this._miss=0,this._users.forAll(t=>t.resetHitRate())}clear(t){let i=t.id;this._db.forEach((t,s)=>{s.startsWith(i)&&(this._size-=t.size,this._db.delete(s),this._notifyRemove(s,t.entry,t.size,a.ALL))}),t.size=0}clearAll(){this._db.forEach((t,i)=>this._notifyRemove(i,t.entry,t.size,a.ALL)),this._users.forAll(t=>t.size=0),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(t,i,s,r){let a;return this._removeFuncs.some(n=>{if(t.startsWith(n[0])){let t=n[1](i,r,s);return"number"==typeof t&&(a=t),!0}return!1}),a}_checkSize(){this._users.forAll(t=>this._checkSizeLimits(t)),this._checkSizeLimits()}_checkSizeLimits(t){let i=t??this;if(i.maxSize<0||i.size<=i.maxSize)return;let s=t?.id,r=!0;for(;r;)for(let[a,n]of(r=!1,this._db))if(0===n.lifetime&&(!s||a.startsWith(s))){if(this._purgeItem(a,n,t),i.size<=.9*i.maxSize)return;r||=this._db.has(a)}for(let[r,a]of this._db)if((!s||r.startsWith(s))&&(this._purgeItem(r,a,t),i.size<=.9*i.maxSize))return}_purgeItem(t,i,s=this._users.find(i=>t.startsWith(i.id))){if(this._db.delete(t),i.lives<=1){this._size-=i.size,s&&(s.size-=i.size);let r=this._notifyRemove(t,i.entry,i.size,a.SOME);null!=r&&r>0&&(this._size+=r,s&&(s.size+=r),i.lives=i.lifetime,i.size=r,this._db.set(t,i))}else--i.lives,this._db.set(t,i)}}let o=0;class h{constructor(t,i,s){this.entry=t,this.size=i,this.lifetime=s,this.lives=s}}},71416:function(t,i,s){s.d(i,{q:function(){return eV}});var r,a,n,l,u,o,h,d=s(78628),c=s(94605),m=s(689),_=s(61764),f=s(36152),g=s(85515),p=s(31124),y=s(9266),x=s(20928),E=s(54053),T=s(20795),S=s(87394),I=s(5005),F=s(38028),R=s(62329),A=s(83339),b=s(57812),w=s(11243);class v{constructor(t,i){this._cache=new b.z(t),this._invalidCache=new b.z(i)}get(t,i){let s=`${i.uid}:${t}`,r=this._cache.get(s);if(r)return r;if(null!=this._invalidCache.get(s))return null;try{let r=w.WhereClause.create(t,i);return this._cache.put(s,r),r}catch(t){return this._invalidCache.put(s,t),null}}getError(t,i){let s=`${i.uid}:${t}`;return this._invalidCache.get(s)??null}}var C=s(13647);let N=new v(50,500),z="unsupported-query",O=" as ",L=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeBigInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"]),k=new Set(["esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"]),P=new Set(["esriFieldTypeString","esriFieldTypeGUID","esriFieldTypeGlobalID",...L,...k]);function D(t,i,s={}){let r=M(i,t);if(!r){let s=N.getError(i,t);throw new c.Z(z,"invalid SQL expression",{expression:i,error:s})}let a=s.expressionName||"expression";if(s.validateStandardized&&!r.isStandardized)throw new c.Z(z,`${a} is not standard`,{expression:i});if(s.validateAggregate&&!r.isAggregate)throw new c.Z(z,`${a} does not contain a valid aggregate function`,{expression:i});return r.fieldNames}function M(t,i){return t?N.get(t,i):null}function Q(t){return/\((.*?)\)/.test(t)?t:t.split(O)[0]}function G(t,i,s,r={}){let a=new Map;if(function(t,i,s,r,a){for(let n of a.includes("*")?[...s,...a.filter(t=>"*"!==t)]:a)if(i.get(n))V(t,i,s,r,n);else try{for(let a of D(i,Q(n),{validateStandardized:!0}))V(t,i,s,r,a)}catch(i){t.set(n,{type:"expression-error",expression:n,error:i})}}(a,t,i,r.allowedFieldTypes??P,s),a.size){let t=r.expressionName??"expression";throw new c.Z(z,`${t} contains invalid or missing fields`,{errors:Array.from(a.values()),query:r.query})}}function V(t,i,s,r,a){let n=i.get(a);n?s.has(n.name)?"all"!==r&&!1===r?.has(n.type)&&t.set(a,{type:"invalid-type",fieldName:n.name,fieldType:C.v.fromJSON(n.type),allowedFieldTypes:Array.from(r,t=>C.v.fromJSON(t))}):t.set(a,{type:"missing-field",fieldName:n.name}):t.set(a,{type:"invalid-field",fieldName:a})}var U=s(68144),q=s(26978),Z=s(51733),H=s(24458),j=s(223),B=s(48932),$=s(67009),Y=s(87400),W=s(32085),X=s(771);class J{constructor(t,i,s){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=t.returnDistinctValues??!1,this.fieldsIndex=s,this.featureAdapter=i;let r=t.outFields;if(r&&!r.includes("*")){this.outFields=r;let t=0;for(let i of r){let r=Q(i),a=this.fieldsIndex.get(r),n=a?null:M(r,s),l=a?a.name:i.split(O)[1]||"FIELD_EXP_"+t++;this._fieldDataCache.set(i,{alias:l,clause:n})}}}countDistinctValues(t){return this.returnDistinctValues?(t.forEach(t=>this.getAttributes(t)),this._returnDistinctMap.size):t.length}getAttributes(t){let i=this._processAttributesForOutFields(t);return this._processAttributesForDistinctValues(i)}getFieldValue(t,i,s){let r=s?s.name:i,a=null;return this._fieldDataCache.has(r)?a=this._fieldDataCache.get(r)?.clause:s||(a=M(i,this.fieldsIndex),this._fieldDataCache.set(r,{alias:r,clause:a})),s?this.featureAdapter.getAttribute(t,r):a?.calculateValue(t,this.featureAdapter)}getDataValues(t,i,s=!0){let r=i.normalizationType,a=i.normalizationTotal,n=this.fieldsIndex.get(i.field),l=(0,$.UQ)(n)||(0,$.ig)(n),u=(0,$.sX)(n);return t.map(t=>{let n=i.field&&this.getFieldValue(t,i.field,this.fieldsIndex.get(i.field));if(i.field2?(n=`${(0,W.wk)(n)}${i.fieldDelimiter}${(0,W.wk)(this.getFieldValue(t,i.field2,this.fieldsIndex.get(i.field2)))}`,i.field3&&(n=`${n}${i.fieldDelimiter}${(0,W.wk)(this.getFieldValue(t,i.field3,this.fieldsIndex.get(i.field3)))}`)):"string"==typeof n&&s&&(l?n=n?new Date(n).getTime():null:u&&(n=n?(0,Y.yO)(n):null)),r&&Number.isFinite(n)){let s="field"===r&&i.normalizationField?this.getFieldValue(t,i.normalizationField,this.fieldsIndex.get(i.normalizationField)):null;n=(0,W.fk)(n,r,s,a)}return n})}async getExpressionValues(t,i,s,r,a){let{arcadeUtils:n}=await (0,X.LC)(),l=n.hasGeometryOperations(i);l&&await n.enableGeometryOperations();let u=n.createFunction(i),o=n.getViewInfo(s),h={fields:this.fieldsIndex.fields};return t.map(t=>{let i={attributes:this.featureAdapter.getAttributes(t),layer:h,geometry:l?{...(0,U.Op)(r.geometryType,r.hasZ,r.hasM,this.featureAdapter.getGeometry(t)),spatialReference:s?.spatialReference}:null},d=n.createExecContext(i,o,a);return n.executeFunction(u,d)})}validateItem(t,i){return this._fieldDataCache.has(i)||this._fieldDataCache.set(i,{alias:i,clause:M(i,this.fieldsIndex)}),this._fieldDataCache.get(i)?.clause?.testFeature(t,this.featureAdapter)??!1}validateItems(t,i){return this._fieldDataCache.has(i)||this._fieldDataCache.set(i,{alias:i,clause:M(i,this.fieldsIndex)}),this._fieldDataCache.get(i)?.clause?.testSet(t,this.featureAdapter)??!1}_processAttributesForOutFields(t){let i=this.outFields;if(!i?.length)return this.featureAdapter.getAttributes(t);let s={};for(let r of i){let{alias:i,clause:a}=this._fieldDataCache.get(r);s[i]=a?a.calculateValue(t,this.featureAdapter):this.featureAdapter.getAttribute(t,i)}return s}_processAttributesForDistinctValues(t){if(null==t||!this.returnDistinctValues)return t;let i=this.outFields,s=[];if(i)for(let r of i){let{alias:i}=this._fieldDataCache.get(r);s.push(t[i])}else for(let i in t)s.push(t[i]);let r=`${(i||["*"]).join(",")}=${s.join(",")}`,a=this._returnDistinctMap.get(r)||0;return this._returnDistinctMap.set(r,++a),a>1?null:t}}function K(t,i,s){return{objectId:t,target:i,distance:s,type:"vertex"}}class ee{constructor(t,i,s){this.items=t,this.query=i,this.geometryType=s.geometryType,this.hasM=s.hasM,this.hasZ=s.hasZ,this.fieldsIndex=s.fieldsIndex,this.objectIdField=s.objectIdField,this.spatialReference=s.spatialReference,this.featureAdapter=s.featureAdapter}get size(){return this.items.length}createQueryResponseForCount(){let t=new J(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return t.countDistinctValues(this.items);let{groupByFieldsForStatistics:i,having:s,outStatistics:r}=this.query;if(!i?.length)return 1;let a=new Map,n=new Map,l=new Set;for(let u of r){let{statisticType:r}=u,o="exceedslimit"!==r?u.onStatisticField:void 0;if(!n.has(o)){let s=[];for(let r of i){let i=this._getAttributeValues(t,r,a);s.push(i)}n.set(o,this._calculateUniqueValues(s,t.returnDistinctValues))}let h=n.get(o);for(let i in h){let{data:r,items:a}=h[i],n=r.join(",");s&&!t.validateItems(a,s)||l.add(n)}}return l.size}async createQueryResponse(){let t;if(t=this.query.outStatistics?this.query.outStatistics.some(t=>"exceedslimit"===t.statisticType)?this._createExceedsLimitQueryResponse(this.query):await this._createStatisticsQueryResponse(this.query):this._createFeatureQueryResponse(this.query),this.query.returnQueryGeometry){let i=this.query.geometry;(0,R.JY)(this.query.outSR)&&!(0,R.fS)(i.spatialReference,this.query.outSR)?t.queryGeometry=(0,U.S2)({spatialReference:this.query.outSR,...(0,q.iV)(i,i.spatialReference,this.query.outSR)}):t.queryGeometry=(0,U.S2)({spatialReference:this.query.outSR,...i})}return t}createSnappingResponse(t,i){let s=this.featureAdapter,r=et(this.hasZ,this.hasM),{point:a,mode:n}=t,l="number"==typeof t.distance?t.distance:t.distance.x,u="number"==typeof t.distance?t.distance:t.distance.y,o={candidates:[]},h="esriGeometryPolygon"===this.geometryType,d=this._getPointCreator(n,this.spatialReference,i),c=new ei(null,0),m=new ei(null,0),_={x:0,y:0,z:0};for(let i of this.items){let n=s.getGeometry(i);if(null==n)continue;let{coords:f,lengths:g}=n;if(c.coords=f,m.coords=f,t.returnEdge){let t=0;for(let n=0;n<g.length;n++){let h=g[n];for(let n=0;n<h;n++,t+=r)if(c.coordsIndex=t,n!==h-1){m.coordsIndex=t+r,function(t,i,s,r){let a=r.x-s.x,n=r.y-s.y,l=Math.min(1,Math.max(0,((i.x-s.x)*a+(i.y-s.y)*n)/(a*a+n*n)));t.x=s.x+a*l,t.y=s.y+n*l}(_,a,c,m);let n=(a.x-_.x)/l,h=(a.y-_.y)/u,f=n*n+h*h;f<=1&&o.candidates.push(function(t,i,s,r,a,n=!1){return{objectId:t,target:i,distance:s,type:"edge",start:r,end:a,draped:n}}(s.getObjectId(i),d(_),Math.sqrt(f),d(c),d(m)))}}}if("none"!==t.vertexMode){let n=h?f.length-r:f.length;if("all"===t.vertexMode)for(let t=0;t<n;t+=r){c.coordsIndex=t;let r=(a.x-c.x)/l,n=(a.y-c.y)/u,h=r*r+n*n;h<=1&&o.candidates.push(K(s.getObjectId(i),d(c),Math.sqrt(h)))}else if("ends"===t.vertexMode){let t=[0];for(let n of(h||t.push(f.length-r),t)){c.coordsIndex=n;let t=(a.x-c.x)/l,r=(a.y-c.y)/u,h=t*t+r*r;h<=1&&o.candidates.push(K(s.getObjectId(i),d(c),Math.sqrt(h)))}}}}return o.candidates.sort((t,i)=>t.distance-i.distance),o}_getPointCreator(t,i,s){let r=null==s||(0,R.fS)(i,s)?t=>t:t=>(0,q.iV)(t,i,s),{hasZ:a}=this;return"3d"===t?a?({x:t,y:i,z:s})=>r({x:t,y:i,z:s}):({x:t,y:i})=>r({x:t,y:i,z:0}):({x:t,y:i})=>r({x:t,y:i})}async createSummaryStatisticsResponse(t){let{field:i,valueExpression:s,normalizationField:r,normalizationType:a,normalizationTotal:n,minValue:l,maxValue:u,scale:o,timeZone:h}=t,d=this.fieldsIndex.get(i),c=(0,$.y2)(d)||(0,$.UQ)(d)||(0,$.ig)(d),m=await this._getDataValues({field:i,valueExpression:s,normalizationField:r,normalizationType:a,normalizationTotal:n,scale:o,timeZone:h}),_=(0,W.S5)({normalizationType:a,normalizationField:r,minValue:l,maxValue:u}),f={value:.5,fieldType:d?.type},g=(0,$.qN)(d)?(0,W.H0)({values:m,supportsNullCount:_,percentileParams:f}):(0,W.i5)({values:m,minValue:l,maxValue:u,useSampleStdDev:!a,supportsNullCount:_,percentileParams:f});return(0,W.F_)(g,c)}async createUniqueValuesResponse(t){let{field:i,valueExpression:s,domains:r,returnAllCodedValues:a,scale:n,timeZone:l}=t,u=await this._getDataValues({field:i,field2:t.field2,field3:t.field3,fieldDelimiter:t.fieldDelimiter,valueExpression:s,scale:n,timeZone:l},!1),o=(0,W.eT)(u);return(0,W.Qm)(o,r,a,t.fieldDelimiter)}async createClassBreaksResponse(t){let{field:i,valueExpression:s,normalizationField:r,normalizationType:a,normalizationTotal:n,classificationMethod:l,standardDeviationInterval:u,minValue:o,maxValue:h,numClasses:d,scale:c,timeZone:m}=t,_=await this._getDataValues({field:i,valueExpression:s,normalizationField:r,normalizationType:a,normalizationTotal:n,scale:c,timeZone:m}),f=(0,W.G2)(_,{field:i,normalizationField:r,normalizationType:a,normalizationTotal:n,classificationMethod:l,standardDeviationInterval:u,minValue:o,maxValue:h,numClasses:d});return(0,W.DL)(f,l)}async createHistogramResponse(t){let{field:i,valueExpression:s,normalizationField:r,normalizationType:a,normalizationTotal:n,classificationMethod:l,standardDeviationInterval:u,minValue:o,maxValue:h,numBins:d,scale:c,timeZone:m}=t,_=await this._getDataValues({field:i,valueExpression:s,normalizationField:r,normalizationType:a,normalizationTotal:n,scale:c,timeZone:m});return(0,W.oF)(_,{field:i,normalizationField:r,normalizationType:a,normalizationTotal:n,classificationMethod:l,standardDeviationInterval:u,minValue:o,maxValue:h,numBins:d})}_sortFeatures(t,i,s){if(t.length>1&&i?.length)for(let r of i.reverse()){let i=r.split(" "),a=i[0],n=this.fieldsIndex.get(a),l=!!i[1]&&"desc"===i[1].toLowerCase(),u=(0,W.Lq)(n?.type,l);t.sort((t,i)=>u(s(t,a,n),s(i,a,n)))}}_createFeatureQueryResponse(t){let i=this.items,{geometryType:s,hasM:r,hasZ:a,objectIdField:n,spatialReference:l}=this,{outFields:u,outSR:o,quantizationParameters:h,resultRecordCount:d,resultOffset:c,returnZ:m,returnM:_}=t,f=null!=d&&i.length>(c||0)+d,g=u&&(u.includes("*")?[...this.fieldsIndex.fields]:u.map(t=>this.fieldsIndex.get(t)));return{exceededTransferLimit:f,features:this._createFeatures(t,i),fields:g,geometryType:s,hasM:r&&_,hasZ:a&&m,objectIdFieldName:n,spatialReference:(0,U.S2)(o||l),transform:h&&(0,B.vY)(h)||null}}_createFeatures(t,i){let s=new J(t,this.featureAdapter,this.fieldsIndex),{hasM:r,hasZ:a}=this,{orderByFields:n,quantizationParameters:l,returnGeometry:u,returnCentroid:o,maxAllowableOffset:h,resultOffset:d,resultRecordCount:c,returnZ:m=!1,returnM:_=!1}=t,f=a&&m,g=r&&_,p=[],y=0,x=[...i];if(this._sortFeatures(x,n,(t,i,r)=>s.getFieldValue(t,i,r)),this.geometryType&&(u||o)){let t=(0,B.vY)(l)??void 0,i="esriGeometryPolygon"===this.geometryType||"esriGeometryPolyline"===this.geometryType;if(u&&!o)for(let r of x){let a=this.featureAdapter.getGeometry(r),n={attributes:s.getAttributes(r),geometry:(0,U.Op)(this.geometryType,this.hasZ,this.hasM,a,h,t,f,g)};i&&a&&!n.geometry&&(n.centroid=(0,U.EG)(this,this.featureAdapter.getCentroid(r,this),t)),p[y++]=n}else if(!u&&o)for(let i of x)p[y++]={attributes:s.getAttributes(i),centroid:(0,U.EG)(this,this.featureAdapter.getCentroid(i,this),t)};else for(let i of x)p[y++]={attributes:s.getAttributes(i),centroid:(0,U.EG)(this,this.featureAdapter.getCentroid(i,this),t),geometry:(0,U.Op)(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(i),h,t,f,g)}}else for(let t of x){let i=s.getAttributes(t);i&&(p[y++]={attributes:i})}let E=d||0;if(null!=c){let t=E+c;p=p.slice(E,Math.min(p.length,t))}return p}_createExceedsLimitQueryResponse(t){let i=!1,s=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY;for(let i of t.outStatistics??[])if("exceedslimit"===i.statisticType){s=null!=i.maxPointCount?i.maxPointCount:Number.POSITIVE_INFINITY,r=null!=i.maxRecordCount?i.maxRecordCount:Number.POSITIVE_INFINITY,a=null!=i.maxVertexCount?i.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)i=this.items.length>s;else if(this.items.length>r)i=!0;else{let t=et(this.hasZ,this.hasM),s=this.featureAdapter;i=this.items.reduce((t,i)=>{let r=s.getGeometry(i);return t+(null!=r&&r.coords.length||0)},0)/t>a}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(i)}}]}}async _createStatisticsQueryResponse(t){let i={attributes:{}},s=[],r=new Map,a=new Map,n=new Map,l=new Map,u=new J(t,this.featureAdapter,this.fieldsIndex),o=t.outStatistics,{groupByFieldsForStatistics:h,having:d,orderByFields:c,resultRecordCount:m}=t,_=h?.length,f=!!_,g=f?h[0]:null,p=f&&!this.fieldsIndex.get(g);for(let t of o??[]){let{outStatisticFieldName:o,statisticType:c}=t,m="exceedslimit"!==c?t.onStatisticField:void 0,y="percentile_disc"===c||"percentile_cont"===c,x="EnvelopeAggregate"===c||"CentroidAggregate"===c||"ConvexHullAggregate"===c,E=f&&1===_&&(m===g||p)&&"count"===c;if(f){if(!n.has(m)){let t=[];for(let i of h){let s=this._getAttributeValues(u,i,r);t.push(s)}n.set(m,this._calculateUniqueValues(t,!x&&u.returnDistinctValues))}let i=n.get(m);if(!i)continue;for(let s of Object.keys(i)){let{count:a,data:n,items:c,itemPositions:_}=i[s],f=n.join(",");if(!d||u.validateItems(c,d)){let i=l.get(f)||{attributes:{}};if(x){i.aggregateGeometries||(i.aggregateGeometries={});let{aggregateGeometries:s,outStatisticFieldName:r}=await this._getAggregateGeometry(t,c);i.aggregateGeometries[r]=s}else{let s=null;if(E)s=a;else{let i=this._getAttributeValues(u,m,r),a=_.map(t=>i[t]);s=y&&"statisticParameters"in t?this._getPercentileValue(t,a):this._getStatisticValue(t,a,null,u.returnDistinctValues)}i.attributes[o]=s}let s=0;h.forEach((t,r)=>i.attributes[this.fieldsIndex.get(t)?t:"EXPR_"+ ++s]=n[r]),l.set(f,i)}}}else if(x){i.aggregateGeometries||(i.aggregateGeometries={});let{aggregateGeometries:s,outStatisticFieldName:r}=await this._getAggregateGeometry(t,this.items);i.aggregateGeometries[r]=s}else{let s=this._getAttributeValues(u,m,r);i.attributes[o]=y&&"statisticParameters"in t?this._getPercentileValue(t,s):this._getStatisticValue(t,s,a,u.returnDistinctValues)}let T=("min"===c||"max"===c)&&((0,$.qN)(this.fieldsIndex.get(m))||this._isAnyDateField(m))?this.fieldsIndex.get(m)?.type:null;s.push({name:o,alias:o,type:T||"esriFieldTypeDouble"})}let y=f?Array.from(l.values()):[i];return this._sortFeatures(y,c,(t,i)=>t.attributes[i]),m&&(y.length=Math.min(m,y.length)),{fields:s,features:y}}_isAnyDateField(t){let i=this.fieldsIndex.get(t);return(0,$.y2)(i)||(0,$.UQ)(i)||(0,$.ig)(i)||(0,$.sX)(i)}async _getAggregateGeometry(t,i){let{convexHull:r,union:a}=await Promise.all([s.e(58379),s.e(9042)]).then(s.bind(s,56362)),{statisticType:n,outStatisticFieldName:l}=t,{featureAdapter:u,spatialReference:o,geometryType:h,hasZ:d,hasM:c}=this,m=i.map(t=>(0,U.Op)(h,d,c,u.getGeometry(t))),_=r(o,m,!0)[0],f={aggregateGeometries:null,outStatisticFieldName:null};if("EnvelopeAggregate"===n){let t=_?(0,j._w)(_):(0,j.aO)(a(o,m));f.aggregateGeometries={...t,spatialReference:o},f.outStatisticFieldName=l||"extent"}else if("CentroidAggregate"===n){let t=_?(0,H.tO)(_):(0,H.$G)((0,j.aO)(a(o,m)));f.aggregateGeometries={x:t[0],y:t[1],spatialReference:o},f.outStatisticFieldName=l||"centroid"}else"ConvexHullAggregate"===n&&(f.aggregateGeometries=_,f.outStatisticFieldName=l||"convexHull");return f}_getStatisticValue(t,i,s,r){let{onStatisticField:a,statisticType:n}=t,l=null;return l=s?.has(a)?s.get(a):(0,$.qN)(this.fieldsIndex.get(a))||this._isAnyDateField(a)?(0,W.H0)({values:i,returnDistinct:r}):(0,W.i5)({values:r?[...new Set(i)]:i,minValue:null,maxValue:null,useSampleStdDev:!0}),s&&s.set(a,l),l["var"===n?"variance":n]}_getPercentileValue(t,i){let{onStatisticField:s,statisticParameters:r,statisticType:a}=t,{value:n,orderBy:l}=r,u=this.fieldsIndex.get(s);return(0,W.XL)(i,{value:n,orderBy:l,fieldType:u?.type,isDiscrete:"percentile_disc"===a})}_getAttributeValues(t,i,s){if(s.has(i))return s.get(i);let r=this.fieldsIndex.get(i),a=this.items.map(s=>t.getFieldValue(s,i,r));return s.set(i,a),a}_calculateUniqueValues(t,i){let s={},r=this.items,a=r.length;for(let n=0;n<a;n++){let a=r[n],l=[];for(let i of t)l.push(i[n]);let u=l.join(",");null==s[u]?s[u]={count:1,data:l,items:[a],itemPositions:[n]}:(i||s[u].count++,s[u].items.push(a),s[u].itemPositions.push(n))}return s}async _getDataValues(t,i=!0){let s=new J(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:r,scale:a,timeZone:n}=t;return r?s.getExpressionValues(this.items,r,{viewingMode:"map",scale:a,spatialReference:this.query.outSR||this.spatialReference},{geometryType:this.geometryType,hasZ:this.hasZ,hasM:this.hasM},n):s.getDataValues(this.items,(0,_.d9)(t),i)}}function et(t,i){return t?i?4:3:i?3:2}class ei{constructor(t,i){this.coords=t,this.coordsIndex=i}get x(){return this.coords[this.coordsIndex]}get y(){return this.coords[this.coordsIndex+1]}get z(){return this.coords[this.coordsIndex+2]}}var es=s(39695),er=s(32826);let ea="unsupported-query";async function en(t,{fieldsIndex:i,geometryType:s,spatialReference:r,availableFields:a}){if((t.distance??0)<0||null!=t.geometryPrecision||t.multipatchOption&&"xyFootprint"!==t.multipatchOption||t.pixelSize||t.relationParam||t.text)throw new c.Z(ea,"Unsupported query options",{query:t});return el(i,a,t),function(t,i,s){let{outStatistics:r,groupByFieldsForStatistics:a,having:n}=s,l=a?.length,u=r?.length;if(n){if(!l||!u)throw new c.Z(ea,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:s});!function(t,i,s,r,a){if(!s)return;let n="having clause",l=D(t,s,{validateAggregate:!0,expressionName:n});G(t,i,l,{expressionName:n,query:a});let u=M(s,t);if(!u?.getExpressions().every(i=>{let{aggregateType:s,field:a}=i,n=t.get(a)?.name;return r.some(i=>{let{onStatisticField:r,statisticType:a}=i;return t.get(r)?.name===n&&a.toLowerCase().trim()===s})}))throw new c.Z(z,"expressions in having clause should also exist in outStatistics",{having:s})}(t,i,n,r,s)}if(u){if(!(null!=r&&r.every(t=>"exceedslimit"!==t.statisticType)))return;for(let n of(G(t,i,r.map(t=>t.onStatisticField).filter(Boolean),{expressionName:"onStatisticFields",query:s}),l&&G(t,i,a,{expressionName:"groupByFieldsForStatistics",query:s}),r)){let{onStatisticField:r,statisticType:a}=n;if(("percentile_disc"===a||"percentile_cont"===a)&&"statisticParameters"in n){let{statisticParameters:t}=n;if(!t)throw new c.Z(ea,"statisticParameters should be set for percentile type",{definition:n,query:s})}else t.get(r)&&"count"!==a&&"min"!==a&&"max"!==a&&G(t,i,[r],{expressionName:`outStatistics with '${a}' statistic type`,allowedFieldTypes:eu,query:s})}}}(i,a,t),Promise.all([(0,er.P0)(t,s,r),(0,q._W)(r,t.outSR)]).then(()=>t)}function el(t,i,s){let{outFields:r,orderByFields:a,returnDistinctValues:n,outStatistics:l}=s,u=l?l.map(t=>t.outStatisticFieldName&&t.outStatisticFieldName.toLowerCase()).filter(Boolean):[];if(a&&a.length>0){let r=" asc",n=" desc";G(t,i,a.map(t=>{let i=t.toLowerCase();return i.includes(r)?i.split(r)[0]:i.includes(n)?i.split(n)[0]:t}).filter(t=>!u.includes(t)),{expressionName:"orderByFields",query:s})}if(r&&r.length>0)G(t,i,r,{expressionName:"outFields",query:s,allowedFieldTypes:"all"});else if(n)throw new c.Z(ea,"outFields should be specified for returnDistinctValues",{query:s});!function(t,i,s,r){if(!s)return;let a="where clause";G(t,i,D(t,s,{validateStandardized:!0,expressionName:a}),{expressionName:a,query:r})}(t,i,s.where,s)}let eu=new Set([...L,...k]);async function eo(t,i,{fieldsIndex:s,geometryType:r,spatialReference:a,availableFields:n}){if((t.distance??0)<0||null!=t.geometryPrecision||t.multipatchOption||t.pixelSize||t.relationParam||t.text||t.outStatistics||t.groupByFieldsForStatistics||t.having||t.orderByFields)throw new c.Z(ea,"Unsupported query options",{query:t});return el(s,n,t),Promise.all([eh(s,n,i,t),(0,er.P0)(t,r,a),(0,q._W)(a,t.outSR)]).then(()=>t)}async function eh(t,i,s,r){let a=[];if(s.valueExpression){let{arcadeUtils:t}=await (0,X.LC)();a=t.extractFieldNames(s.valueExpression)}if(s.field&&a.push(s.field),s.field2&&a.push(s.field2),s.field3&&a.push(s.field3),s.normalizationField&&a.push(s.normalizationField),!a.length&&!s.valueExpression)throw new c.Z(ea,"field or valueExpression is required",{params:s});G(t,i,a,{expressionName:"statistics",query:r})}var ed=s(93650),ec=s(32370),em=s(82985);s(37180);var e_=s(65223),ef=s(94944),eg=s(35313),ep=s(20128),ey=s(89163),ex=s(21684);let eE=Symbol("Yield");class eT{constructor(){this._tasks=[],this._runningTasks=(0,ey.t)(0)}get length(){return this._tasks.length}get running(){return this._runningTasks.value>0}destroy(){this.cancelAll()}runTask(t){if(0===this.length)return eE;for(;!t.done&&this._process(t);)t.madeProgress()}push(t,i,s){return++this._runningTasks.value,new Promise((r,a)=>this._tasks.push(new eS(r,a,t,i,s))).finally(()=>--this._runningTasks.value)}unshift(t,i,s){return++this._runningTasks.value,new Promise((r,a)=>this._tasks.unshift(new eS(r,a,t,i,s))).finally(()=>--this._runningTasks.value)}_process(t){if(0===this._tasks.length)return!1;let i=this._tasks.shift();try{let s=(0,p.Hc)(i.signal);if(s&&!i.abortCallback)i.reject((0,p.zE)());else{let r=s?i.abortCallback?.(p.zE()):i.callback(t);(0,p.y8)(r)?r.then(i.resolve,i.reject):i.resolve(r)}}catch(t){i.reject(t)}return!0}cancelAll(){let t=(0,p.zE)();for(let i of this._tasks)if(i.abortCallback){let s=i.abortCallback(t);i.resolve(s)}else i.reject(t);this._tasks.length=0}}class eS{constructor(t,i,s,r,a){this.resolve=t,this.reject=i,this.callback=s,this.signal=r,this.abortCallback=a}}var eI=s(86641),eF=s(94761),eR=s(89312);s(3457);var eA=s(64186);let eb=class extends eF.Z{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};(0,eI._)([(0,eR.Cb)()],eb.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),(0,eI._)([(0,eR.Cb)()],eb.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0);let ew=new(eb=(0,eI._)([(0,eA.j)("esri.views.support.debugFlags")],eb));(r=l||(l={}))[r.ANIMATING=0]="ANIMATING",r[r.INTERACTING=1]="INTERACTING",r[r.IDLE=2]="IDLE",(a=u||(u={})).RESOURCE_CONTROLLER_IMMEDIATE="immediate",a.RESOURCE_CONTROLLER="schedule",a.SLIDE="slide",a.STREAM_DATA_LOADER="stream loader",a.ELEVATION_QUERY="elevation query",a.TERRAIN_SURFACE="terrain",a.SURFACE_GEOMETRY_UPDATES="surface geometry updates",a.LOD_RENDERER="LoD renderer",a.GRAPHICS_CORE="Graphics3D",a.I3S_CONTROLLER="I3S",a.POINT_CLOUD_LAYER="point cloud",a.FEATURE_TILE_FETCHER="feature fetcher",a.OVERLAY="overlay",a.STAGE="stage",a.GRAPHICS_DECONFLICTOR="graphics deconflictor",a.FILTER_VISIBILITY="Graphics3D filter visibility",a.SCALE_VISIBILITY="Graphics3D scale visibility",a.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",a.POINT_OF_INTEREST_FREQUENT="POI frequent",a.POINT_OF_INTEREST_INFREQUENT="POI infrequent",a.LABELER="labeler",a.FEATURE_QUERY_ENGINE="feature query",a.FEATURE_TILE_TREE="feature tile tree",a.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",a.ELEVATION_ALIGNMENT="elevation alignment",a.ELEVATION_ALIGNMENT_SCENE="elevation alignment scene",a.TEXT_TEXTURE_ATLAS="text texture atlas",a.TEXTURE_UNLOAD="texture unload",a.LINE_OF_SIGHT_TOOL="line of sight tool",a.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",a.ELEVATION_PROFILE="elevation profile",a.SNAPPING="snapping",a.SHADOW_ACCUMULATOR="shadow accumulator",a.CLOUDS_GENERATOR="clouds generator",a[a.NONE=0]="NONE",a[a.TEST_PRIO=1]="TEST_PRIO";let ev=new Map([[u.RESOURCE_CONTROLLER_IMMEDIATE,0],[u.RESOURCE_CONTROLLER,4],[u.SLIDE,0],[u.STREAM_DATA_LOADER,0],[u.ELEVATION_QUERY,0],[u.TERRAIN_SURFACE,1],[u.SURFACE_GEOMETRY_UPDATES,1],[u.LOD_RENDERER,2],[u.GRAPHICS_CORE,2],[u.I3S_CONTROLLER,2],[u.POINT_CLOUD_LAYER,2],[u.FEATURE_TILE_FETCHER,2],[u.OVERLAY,4],[u.STAGE,4],[u.GRAPHICS_DECONFLICTOR,4],[u.FILTER_VISIBILITY,4],[u.SCALE_VISIBILITY,4],[u.FRUSTUM_VISIBILITY,4],[u.CLOUDS_GENERATOR,4],[u.POINT_OF_INTEREST_FREQUENT,6],[u.POINT_OF_INTEREST_INFREQUENT,30],[u.LABELER,8],[u.FEATURE_QUERY_ENGINE,8],[u.FEATURE_TILE_TREE,16],[u.FEATURE_TILE_TREE_ACTIVE,0],[u.ELEVATION_ALIGNMENT,12],[u.ELEVATION_ALIGNMENT_SCENE,14],[u.TEXT_TEXTURE_ATLAS,12],[u.TEXTURE_UNLOAD,12],[u.LINE_OF_SIGHT_TOOL,16],[u.LINE_OF_SIGHT_TOOL_INTERACTIVE,0],[u.SNAPPING,0],[u.SHADOW_ACCUMULATOR,30]]);function eC(t){return ev.has(t)?ev.get(t):"number"==typeof t?t:1}let eN=(0,ex.HA)(6.5),ez=(0,ex.HA)(1),eO=(0,ex.HA)(30),eL=(0,ex.HA)(1e3/30),ek=(0,ex.HA)(100);!function(t){class i{get updating(){return this._updating.value}_updatingChanged(){this._updating.value=this._tasks.some(t=>t.needsUpdate)}constructor(){for(let t of(this._updating=(0,ey.t)(!0),this._microTaskQueued=!1,this._frameNumber=0,this.performanceInfo={total:new ef.Z("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=new r,this._state=l.INTERACTING,this._tasks=new eg.Z,this._runQueue=new eg.Z,this._load=0,this._idleStateCallbacks=new eg.Z,this._idleUpdatesStartFired=!1,this._forceTask=!1,this._debug=!1,this._debugHandle=(0,ep.YP)(()=>ew.SCHEDULER_LOG_SLOW_TASKS,t=>this._debug=t,ep.nn),Object.keys(u)))this.performanceInfo.tasks.set(u[t],new ef.Z(u[t]))}destroy(){this._tasks.toArray().forEach(t=>t.remove()),this._tasks.clear(),(0,f.hw)(this._debugHandle),this._microTaskQueued=!1,this._updatingChanged()}taskRunningChanged(t){this._updatingChanged(),t&&this._budget.remaining>0&&!this._microTaskQueued&&(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.remaining>0&&this._schedule()&&this.frame())}))}registerTask(t,i){let r=new s(this,t,i);return this._tasks.push(r),this._updatingChanged(),this.performanceInfo.tasks.has(t)||this.performanceInfo.tasks.set(t,new ef.Z(t)),r}registerIdleStateCallbacks(t,i){let s={idleBegin:t,idleEnd:i};this._idleStateCallbacks.push(s),this.state===l.IDLE&&this._idleUpdatesStartFired&&s.idleBegin();let r=this;return{remove:()=>this._removeIdleStateCallbacks(s),set idleBegin(e){r._idleUpdatesStartFired&&(s.idleEnd(),r._state===l.IDLE&&e()),s.idleBegin=e},set idleEnd(e){s.idleEnd=e}}}get load(){return this._load}set state(t){this._state!==t&&(this._state=t,this.state!==l.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(t=>t.idleEnd())))}get state(){return this._state}updateBudget(t){++this._frameNumber;let i=eN,s=t.frameDuration,r=ez;switch(this.state){case l.IDLE:i=(0,ex.HA)(0),s=(0,ex.HA)(Math.max(ek,t.frameDuration)),r=eO;break;case l.INTERACTING:s=(0,ex.HA)(Math.max(eL,t.frameDuration));case l.ANIMATING:}return s=(0,ex.HA)(s-t.elapsedFrameTime-i),this.state!==l.IDLE&&s<ez&&!this._forceTask?(this._forceTask=!0,!1):(s=(0,ex.HA)(Math.max(s,r)),this._budget.reset(s,this.state),this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case l.IDLE:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(t=>t.idleBegin())),this._runIdle();break;case l.INTERACTING:this._runInteracting();break;default:this._runAnimating()}}stopFrame(){this._budget.reset((0,ex.HA)(0),this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(t){this._idleUpdatesStartFired&&t.idleEnd(),this._idleStateCallbacks.removeUnordered(t)}removeTask(t){this._tasks.removeUnordered(t),this._runQueue.removeUnordered(t),this._updatingChanged()}_updateTask(t){this._tasks.forAll(i=>{i.name===t&&i.setPriority(t)})}_getState(t){if(this._runQueue.some(i=>i.name===t))return h.SCHEDULED;let i=h.IDLE;return this._tasks.forAll(s=>{s.name===t&&s.needsUpdate&&(s.schedulePriority<=1?i=h.READY:i!==h.READY&&(i=h.WAITING))}),i}_getRuntime(t){let i=0;return this._tasks.forAll(s=>{s.name===t&&(i+=s.runtime)}),i}_resetRuntimes(){this._tasks.forAll(t=>t.runtime=0)}_getRunning(){let t=new Map;if(this._tasks.forAll(i=>{i.needsUpdate&&t.set(i.name,(t.get(i.name)||0)+1)}),0===t.size)return null;let i="";return t.forEach((t,s)=>{i+=t>1?` ${t}x ${s}`:` ${s}`}),i}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){let t=this._tasks.reduce((t,i)=>i.needsUpdate?++t:t,0);this._load=.9*this._load+.09999999999999998*t}_schedule(){for(this._runQueue.filterInPlace(t=>!!t.needsUpdate||(t.schedulePriority=t.basePriority,!1)),this._tasks.forAll(t=>{0===t.basePriority&&t.needsUpdate&&!this._runQueue.includes(t)&&t.blockFrame!==this._frameNumber&&this._runQueue.unshift(t)});0===this._runQueue.length;){let t=!1,i=0;if(this._tasks.forAll(s=>{s.needsUpdate&&0!==s.schedulePriority&&0!==s.basePriority&&s.blockFrame!==this._frameNumber&&((t=!0,i=Math.max(i,s.basePriority),1===s.schedulePriority)?(s.schedulePriority=0,this._runQueue.push(s)):--s.schedulePriority)}),!t)return this._updatingChanged(),!1}return this._updatingChanged(),!0}_run(){let t=this._budget.now();this._startFrameTaskTimes();do for(;this._runQueue.length>0;){let i=this._budget.now(),s=this._runQueue.pop();this._budget.resetProgress();try{s.task.runTask(this._budget)===eE&&(s.blockFrame=this._frameNumber)}catch(t){e_.Z.getLogger("esri.views.support.Scheduler").error(`Exception in task "${s.name}"`,t),s.blockFrame=this._frameNumber}!this._budget.hasProgressed&&s.blockFrame!==this._frameNumber&&s.needsUpdate&&(s.name,u.I3S_CONTROLLER,s.blockFrame=this._frameNumber),s.schedulePriority=s.basePriority;let r=this._budget.now()-i;if(s.runtime+=r,this._frameTaskTimes.set(s.priority,this._frameTaskTimes.get(s.priority)+r),this._budget.remaining<=0)return this._updatingChanged(),void this._recordFrameTaskTimes(this._budget.now()-t)}while(this._schedule());this._updatingChanged(),this._recordFrameTaskTimes(this._budget.now()-t)}_startFrameTaskTimes(){for(let t of Object.keys(u))this._frameTaskTimes.set(u[t],0)}_recordFrameTaskTimes(t){this._frameTaskTimes.forEach((t,i)=>this.performanceInfo.tasks.get(i).record(t)),this.performanceInfo.total.record(t)}get test(){}}t.Scheduler=i;class s{get task(){return this._task.value}get updating(){return this._queue.running}constructor(t,i,s){this._scheduler=t,this.name=i,this.blockFrame=0,this.runtime=0,this._queue=new eT,this._handles=new em.Z,this._basePriority=eC(i),this.schedulePriority=this._basePriority,this._task=(0,ey.t)(null!=s?s:this._queue),this._handles.add((0,ep.gx)(()=>this.task.running,i=>t.taskRunningChanged(i)))}remove(){this.processQueue(eP),this._scheduler.removeTask(this),this.schedule=eM.schedule,this.reschedule=eM.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(t){if(this.name===t)return;this.name=t;let i=eC(t);0!==this._basePriority&&0===this.schedulePriority||(this.schedulePriority=i),this._basePriority=i}get priority(){return this.name}set priority(t){this.setPriority(t)}get needsUpdate(){return this.updating||this.task.running}schedule(t,i,s){return this._queue.push(t,i,s)}reschedule(t,i,s){return this._queue.unshift(t,i,s)}processQueue(t){return this._queue.runTask(t)}}class r{constructor(){this._begin="undefined"!=typeof performance?performance.now():0,this._budget=0,this._state=l.IDLE,this._done=!1,this._progressed=!1,this._enabled=!0}run(t){return!this.done&&(!0===t()&&this.madeProgress(),!0)}get done(){return this._done}get budget(){return this._budget}madeProgress(){return this._progressed=!0,this._done=this.elapsed>=this._budget&&this._enabled,this._done}get state(){return this._state}get enabled(){return this._enabled}set enabled(t){this._enabled=t}reset(t,i){this._begin=this.now(),this._budget=t,this._state=i,this.resetProgress()}get remaining(){return Math.max(this._budget-this.elapsed,0)}now(){return performance.now()}get elapsed(){return this.now()-this._begin}resetProgress(){this._progressed=!1,this._done=!1}get hasProgressed(){return this._progressed}}t.Budget=r}(o||(o={})),(n=h||(h={})).SCHEDULED="s",n.READY="r",n.WAITING="w",n.IDLE="i";let eP=(()=>{let t=new o.Budget;return t.enabled=!1,t})();class eD{remove(){}processQueue(){}schedule(t,i,s){try{if((0,p.Hc)(i)){let t=(0,p.zE)();return s?Promise.resolve(s(t)):Promise.reject(t)}return(0,p.gx)(t(eP))}catch(t){return Promise.reject(t)}}reschedule(t,i,s){return this.schedule(t,i,s)}}let eM=new eD,eQ=new g.WJ(2e6),eG=0;class eV{constructor(t){this._geometryQueryCache=null,this._changeHandle=null,this.capabilities={query:Z.g},this.geometryType=t.geometryType,this.hasM=!!t.hasM,this.hasZ=!!t.hasZ,this.objectIdField=t.objectIdField,this.spatialReference=t.spatialReference,this.definitionExpression=t.definitionExpression,this.featureStore=t.featureStore,this.aggregateAdapter=t.aggregateAdapter,this._changeHandle=this.featureStore.events.on("changed",()=>this.clearCache()),this.timeInfo=t.timeInfo,t.cacheSpatialQueries&&(this._geometryQueryCache=new g.Xq(eG+++"$$",eQ)),this.fieldsIndex=(0,m.AK)(t.fieldsIndex)?t.fieldsIndex:ec.Z.fromJSON(t.fieldsIndex),t.availableFields&&(1!==t.availableFields.length||"*"!==t.availableFields[0])?this.availableFields=new Set(t.availableFields.map(t=>this.fieldsIndex.get(t)?.name).filter(t=>null!=t)):this.availableFields=new Set(this.fieldsIndex.fields.map(t=>t.name)),t.scheduler&&t.priority&&(this._frameTask=t.scheduler.registerTask(t.priority))}destroy(){this._frameTask=(0,f.hw)(this._frameTask),this.clearCache(),(0,f.SC)(this._geometryQueryCache),this._changeHandle=(0,f.hw)(this._changeHandle)}get featureAdapter(){return this.featureStore.featureAdapter}clearCache(){this._geometryQueryCache?.clear(),this._allFeaturesPromise=null,this._timeExtentPromise=null,this._fullExtentPromise=null}async executeQuery(t,i){let s=(0,p.$h)(i);try{return(await this._executeQuery(t,{},s)).createQueryResponse()}catch(i){if(i!==es.Ti)throw i;return new ee([],t,this).createQueryResponse()}}async executeQueryForCount(t={},i){let s=(0,p.$h)(i);try{return(await this._executeQuery(t,{returnGeometry:!1,returnCentroid:!1,outSR:null},s)).createQueryResponseForCount()}catch(t){if(t!==es.Ti)throw t;return 0}}async executeQueryForExtent(t,i){let s=(0,p.$h)(i),r=t.outSR;try{let i=await this._executeQuery(t,{returnGeometry:!0,returnCentroid:!1,outSR:null},s),a=i.size;if(!a)return{count:0,extent:null};return{count:a,extent:await this._getBounds(i.items,i.spatialReference,r||this.spatialReference)}}catch(t){if(t===es.Ti)return{count:0,extent:null};throw t}}async executeQueryForIds(t,i){return this.executeQueryForIdSet(t,i).then(t=>Array.from(t))}async executeQueryForIdSet(t,i){let s=(0,p.$h)(i);try{let i=await this._executeQuery(t,{returnGeometry:!0,returnCentroid:!1,outSR:null},s),r=i.items,a=new Set;return await this._reschedule(()=>{for(let t of r)a.add(i.featureAdapter.getObjectId(t))},s),a}catch(t){if(t===es.Ti)return new Set;throw t}}async executeQueryForSnapping(t,i){let s=(0,p.$h)(i),{point:r,distance:a,returnEdge:n,vertexMode:l}=t;if(!n&&"none"===l)return{candidates:[]};let u=(0,_.d9)(t.query);u=await this._schedule(()=>(0,es.j6)(u,this.definitionExpression,this.spatialReference),s),u=await this._reschedule(()=>en(u,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),s);let o=!(0,R.fS)(r.spatialReference,this.spatialReference);o&&await (0,q._W)(r.spatialReference,this.spatialReference);let h="number"==typeof a?a:a.x,d="number"==typeof a?a:a.y,c={xmin:r.x-h,xmax:r.x+h,ymin:r.y-d,ymax:r.y+d,spatialReference:r.spatialReference},m=o?(0,q.iV)(c,this.spatialReference):c;if(!m)return{candidates:[]};let f=(await (0,F.aX)((0,I.im)(r),null,{signal:s}))[0],g=(await (0,F.aX)((0,I.im)(m),null,{signal:s}))[0];if(null==f||null==g)return{candidates:[]};let y=new ee(await this._reschedule(()=>this._searchFeatures(eU(g.toJSON())),s),u,this);await this._reschedule(()=>this._executeObjectIdsQuery(y),s),await this._reschedule(()=>this._executeTimeQuery(y),s),await this._reschedule(()=>this._executeAttributesQuery(y),s),await this._reschedule(()=>this._executeGeometryQueryForSnapping(y,s),s);let x=f.toJSON(),E=o?(0,q.iV)(x,this.spatialReference):x,T=o?Math.max(m.xmax-m.xmin,m.ymax-m.ymin)/2:a;return y.createSnappingResponse({...t,point:E,distance:T},r.spatialReference)}async executeQueryForLatestObservations(t,i){let s=(0,p.$h)(i);if(!this.timeInfo?.trackIdField)throw new c.Z("unsupported-query","Missing timeInfo or timeInfo.trackIdField",{query:t,timeInfo:this.timeInfo});try{let i=await this._executeQuery(t,{},s);return await this._reschedule(()=>this._filterLatest(i),s),i.createQueryResponse()}catch(i){if(i!==es.Ti)throw i;return new ee([],t,this).createQueryResponse()}}async executeQueryForSummaryStatistics(t={},i,s){let r=(0,p.$h)(s),{field:a,normalizationField:n,valueExpression:l}=i;return(await this._executeQueryForStatistics(t,{field:a,normalizationField:n,valueExpression:l},r)).createSummaryStatisticsResponse(i)}async executeQueryForUniqueValues(t={},i,s){let r=(0,p.$h)(s),{field:a,field2:n,field3:l,valueExpression:u}=i;return(await this._executeQueryForStatistics(t,{field:a,field2:n,field3:l,valueExpression:u},r)).createUniqueValuesResponse(i)}async executeQueryForClassBreaks(t={},i,s){let r=(0,p.$h)(s),{field:a,normalizationField:n,valueExpression:l}=i;return(await this._executeQueryForStatistics(t,{field:a,normalizationField:n,valueExpression:l},r)).createClassBreaksResponse(i)}async executeQueryForHistogram(t={},i,s){let r=(0,p.$h)(s),{field:a,normalizationField:n,valueExpression:l}=i;return(await this._executeQueryForStatistics(t,{field:a,normalizationField:n,valueExpression:l},r)).createHistogramResponse(i)}async fetchRecomputedExtents(t){let i=(0,p.$h)(t);this._timeExtentPromise||=(0,ed.R)(this.timeInfo,this.featureStore);let[s,r]=await Promise.all([this._getFullExtent(),this._timeExtentPromise]);return(0,p.k_)(i),{fullExtent:s,timeExtent:r}}async _getBounds(t,i,s){let r=(0,E.t8)((0,E.Ue)(),E.G_);await this.featureStore.forEachBounds(t,t=>(0,E.TC)(r,t));let a={xmin:r[0],ymin:r[1],xmax:r[3],ymax:r[4],spatialReference:(0,U.S2)(this.spatialReference)};this.hasZ&&isFinite(r[2])&&isFinite(r[5])&&(a.zmin=r[2],a.zmax=r[5],a.hasZ=!0);let n=(0,q.iV)(a,i,s);if(n.spatialReference=(0,U.S2)(s),n.xmax-n.xmin==0){let t=(0,y.c9)(n.spatialReference);n.xmin-=t,n.xmax+=t}if(n.ymax-n.ymin==0){let t=(0,y.c9)(n.spatialReference);n.ymin-=t,n.ymax+=t}if(this.hasZ&&null!=n.zmin&&null!=n.zmax&&n.zmax-n.zmin==0){let t=(0,y.c9)(n.spatialReference);n.zmin-=t,n.zmax+=t}return n}_getFullExtent(){return this._fullExtentPromise||="getFullExtent"in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getAllFeatures().then(t=>this._getBounds(t,this.spatialReference,this.spatialReference)),this._fullExtentPromise}async _schedule(t,i){return null!=this._frameTask?this._frameTask.schedule(t,i):t(eP)}async _reschedule(t,i){return null!=this._frameTask?this._frameTask.reschedule(t,i):t(eP)}async _getAllFeaturesQueryEngineResult(t){return new ee(await this._getAllFeatures(),t,this)}async _getAllFeatures(){if(null==this._allFeaturesPromise){let t=[];this._allFeaturesPromise=(async()=>{await this.featureStore.forEach(i=>t.push(i))})().then(()=>t)}let t=this._allFeaturesPromise,i=await t;return t===this._allFeaturesPromise?i.slice():this._getAllFeatures()}async _executeQuery(t,i,s){t=(0,_.d9)(t),t=await this._schedule(()=>(0,es.Up)(t,this.definitionExpression,this.spatialReference),s),t={...t=await this._reschedule(()=>en(t,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),s),...i};let r=await this._reschedule(()=>this._executeSceneFilterQuery(t,s),s),a=await this._reschedule(()=>this._executeGeometryQuery(t,r,s),s);return await this._reschedule(()=>this._executeAggregateIdsQuery(a),s),await this._reschedule(()=>this._executeObjectIdsQuery(a),s),await this._reschedule(()=>this._executeTimeQuery(a),s),await this._reschedule(()=>this._executeAttributesQuery(a),s),a}async _executeSceneFilterQuery(t,i){if(null==t.sceneFilter)return null;let{outSR:s,returnGeometry:r,returnCentroid:a}=t,n=this.featureStore.featureSpatialReference,l=t.sceneFilter.geometry,u=null==n||(0,R.fS)(n,l.spatialReference)?l:(0,q.iV)(l,n);if(!u)return null;let o=(0,R.JY)(s)&&!(0,R.fS)(this.spatialReference,s)&&(r||a)?async t=>this._project(t,s):t=>t,h=this.featureAdapter,d=await this._reschedule(()=>this._searchFeatures(eU(u)),i);if("disjoint"===t.sceneFilter.spatialRelationship){if(!d.length)return null;let s=new Set;for(let t of d)s.add(h.getObjectId(t));let r=await this._reschedule(()=>this._getAllFeatures(),i);return o(await this._reschedule(async()=>{let a=await (0,er.cW)("esriSpatialRelDisjoint",u,this.geometryType,this.hasZ,this.hasM);return new ee(await this._runSpatialFilter(r,t=>!s.has(h.getObjectId(t))||a(h.getGeometry(t)),i),t,this)},i))}if(!d.length)return new ee([],t,this);if(this._canExecuteSinglePass(u,t))return o(new ee(d,t,this));let c=await (0,er.cW)("esriSpatialRelContains",u,this.geometryType,this.hasZ,this.hasM);return o(new ee(await this._runSpatialFilter(d,t=>c(h.getGeometry(t)),i),t,this))}async _executeGeometryQuery(t,i,s){if(null!=i&&0===i.items.length)return i;let{geometry:r,outSR:a,spatialRel:n,returnGeometry:l,returnCentroid:u}=t=null!=i?i.query:t,o=this.featureStore.featureSpatialReference,h=!r||null==o||(0,R.fS)(o,r.spatialReference)?r:(0,q.iV)(r,o),c=l||u,m=(0,R.JY)(a)&&!(0,R.fS)(this.spatialReference,a),_=this._geometryQueryCache&&null==i?m&&c?JSON.stringify({originalFilterGeometry:r,spatialRelationship:n,outSpatialReference:a}):JSON.stringify({originalFilterGeometry:r,spatialRelationship:n}):null,f=_?this._geometryQueryCache.get(_):null;if(null!=f)return new ee(f,t,this);let g=async t=>(m&&c&&await this._project(t,a),_&&this._geometryQueryCache.put(_,t.items,t.items.length+1),t);if(!h)return g(null!=i?i:await this._getAllFeaturesQueryEngineResult(t));let p=this.featureAdapter,y=await this._reschedule(()=>this._searchFeatures(eU(r)),s);if("esriSpatialRelDisjoint"===n){if(!y.length)return g(null!=i?i:await this._getAllFeaturesQueryEngineResult(t));let r=new Set;for(let t of y)r.add(p.getObjectId(t));let a=null!=i?i.items:await this._reschedule(()=>this._getAllFeatures(),s);return g(await this._reschedule(async()=>{let i=await (0,er.cW)(n,h,this.geometryType,this.hasZ,this.hasM);return new ee(await this._runSpatialFilter(a,t=>!r.has(p.getObjectId(t))||i(p.getGeometry(t)),s),t,this)},s))}if(null!=i){let t=new d.SO;y=y.filter(s=>(0,d.cq)(i.items,s,i.items.length,t)>=0)}if(!y.length){let i=new ee([],t,this);return _&&this._geometryQueryCache.put(_,i.items,1),i}if(this._canExecuteSinglePass(h,t))return g(new ee(y,t,this));let x=await (0,er.cW)(n,h,this.geometryType,this.hasZ,this.hasM);return g(new ee(await this._runSpatialFilter(y,t=>x(p.getGeometry(t)),s),t,this))}async _executeGeometryQueryForSnapping(t,i){let{query:s}=t,{spatialRel:r}=s;if(!t?.items?.length||!s.geometry||!r)return;let a=await (0,er.cW)(r,s.geometry,this.geometryType,this.hasZ,this.hasM),n=await this._runSpatialFilter(t.items,t=>a(t.geometry),i);t.items=n}_executeAggregateIdsQuery(t){if(0===t.items.length||!t.query.aggregateIds?.length||null==this.aggregateAdapter)return;let i=new Set;for(let s of t.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(s).forEach(t=>i.add(t));let s=this.featureAdapter.getObjectId;t.items=t.items.filter(t=>i.has(s(t)))}_executeObjectIdsQuery(t){if(0===t.items.length||!t.query.objectIds?.length)return;let i=new Set(t.query.objectIds),s=this.featureAdapter.getObjectId;t.items=t.items.filter(t=>i.has(s(t)))}_executeTimeQuery(t){if(0===t.items.length)return;let i=(0,ed.y)(this.timeInfo,t.query.timeExtent,this.featureAdapter);null!=i&&(t.items=t.items.filter(i))}_executeAttributesQuery(t){if(0===t.items.length)return;let i=M(t.query.where,this.fieldsIndex);if(i){if(!i.isStandardized)throw TypeError("Where clause is not standardized");t.items=t.items.filter(t=>i.testFeature(t,this.featureAdapter))}}async _runSpatialFilter(t,i,s){if(!i)return t;if(null==this._frameTask)return t.filter(t=>i(t));let r=0,a=[],n=async l=>{for(;r<t.length;){let u=t[r++];i(u)&&(a.push(u),l.madeProgress()),l.done&&await this._reschedule(t=>n(t),s)}};return this._reschedule(t=>n(t),s).then(()=>a)}_filterLatest(t){let{trackIdField:i,startTimeField:s,endTimeField:r}=this.timeInfo,a=r||s,n=new Map,l=this.featureAdapter.getAttribute;for(let s of t.items){let t=l(s,i),r=l(s,a),u=n.get(t);(!u||r>l(u,a))&&n.set(t,s)}t.items=Array.from(n.values())}_canExecuteSinglePass(t,i){let{spatialRel:s}=i;return(0,er.hN)(t)&&("esriSpatialRelEnvelopeIntersects"===s||"esriGeometryPoint"===this.geometryType&&("esriSpatialRelIntersects"===s||"esriSpatialRelContains"===s))}async _project(t,i){let s;if(!i||(0,R.fS)(this.spatialReference,i))return t;let r=this.featureAdapter;try{let t=await this._getFullExtent();s=(0,x.getTransformation)(this.spatialReference,i,t)}catch{}let a=await (0,q.oj)(t.items.map(t=>(0,U.Op)(this.geometryType,this.hasZ,this.hasM,r.getGeometry(t))),this.spatialReference,i,s);return t.items=a.map((i,s)=>r.cloneWithGeometry(t.items[s],(0,A.GH)(i,this.hasZ,this.hasM))),t}async _searchFeatures(t){let i=new Set;await Promise.all(t.map(t=>this.featureStore.forEachInBounds(t,t=>i.add(t))));let s=Array.from(i.values());return i.clear(),s}async _executeQueryForStatistics(t,i,s){t=(0,_.d9)(t);try{t=await this._schedule(()=>(0,es.Up)(t,this.definitionExpression,this.spatialReference),s),t=await this._reschedule(()=>eo(t,i,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),s);let r=await this._reschedule(()=>this._executeSceneFilterQuery(t,s),s),a=await this._reschedule(()=>this._executeGeometryQuery(t,r,s),s);return await this._reschedule(()=>this._executeAggregateIdsQuery(a),s),await this._reschedule(()=>this._executeObjectIdsQuery(a),s),await this._reschedule(()=>this._executeTimeQuery(a),s),await this._reschedule(()=>this._executeAttributesQuery(a),s),a}catch(i){if(i!==es.Ti)throw i;return new ee([],t,this)}}}function eU(t){if((0,er.hN)(t)){if((0,I.YX)(t))return[(0,T.al)(Math.min(t.xmin,t.xmax),Math.min(t.ymin,t.ymax),Math.max(t.xmin,t.xmax),Math.max(t.ymin,t.ymax))];if((0,I.oU)(t))return t.rings.map(t=>(0,T.al)(Math.min(t[0][0],t[2][0]),Math.min(t[0][1],t[2][1]),Math.max(t[0][0],t[2][0]),Math.max(t[0][1],t[2][1])))}return[(0,S.$P)((0,T.Ue)(),t)]}},51733:function(t,i,s){s.d(i,{g:function(){return r}});let r={supportsStatistics:!0,supportsPercentileStatistics:!0,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsCentroid:!0,supportsCacheHint:!1,supportsDistance:!0,supportsDistinct:!0,supportsExtent:!0,supportsGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQuantization:!0,supportsQuantizationEditMode:!1,supportsQueryGeometry:!0,supportsResultType:!1,supportsSqlExpression:!0,supportsMaxRecordCountFactor:!1,supportsStandardizedQueriesOnly:!0,supportsTopFeaturesQuery:!1,supportsQueryByAnonymous:!0,supportsQueryByOthers:!0,supportsHistoricMoment:!1,supportsFormatPBF:!1,supportsDisjointSpatialRelationship:!0,supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsCompactGeometry:!1,maxRecordCountFactor:void 0,maxRecordCount:void 0,standardMaxRecordCount:void 0,tileMaxRecordCount:void 0}},61718:function(t,i,s){s.d(i,{n:function(){return l}});var r=s(36333),a=s(53787),n=s(73503);let l={getObjectId:t=>t.objectId,getAttributes:t=>t.attributes,getAttribute:(t,i)=>t.attributes[i],cloneWithGeometry:(t,i)=>new a.u_(i,t.attributes,null,t.objectId),getGeometry:t=>t.geometry,getCentroid:(t,i)=>(null==t.centroid&&(t.centroid=(0,r.Y)(new n.Z,t.geometry,i.hasZ,i.hasM)),t.centroid)}}}]);