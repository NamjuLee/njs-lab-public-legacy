"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[42455],{28541:function(e,t,a){a.d(t,{R:function(){return L},w:function(){return w}});var i=a(86641),n=a(94761),r=a(36399),s=a(61764),o=a(39553);class l{constructor(){this._propertyOriginMap=new Map,this._originStores=Array(o.v8),this._values=new Map,this.multipleOriginsSupported=!0}clone(e){let t=new l,a=this._originStores[o.s3.DEFAULTS];a&&a.forEach((e,a)=>{t.set(a,(0,s.d9)(e),o.s3.DEFAULTS)});for(let a=o.s3.SERVICE;a<o.v8;a++){let i=this._originStores[a];i&&i.forEach((i,n)=>{e&&e.has(n)||t.set(n,(0,s.d9)(i),a)})}return t}get(e,t){let a=void 0===t?this._values:this._originStores[t];return a?a.get(e):void 0}keys(e){let t=null==e?this._values:this._originStores[e];return t?[...t.keys()]:[]}set(e,t,a=o.s3.USER){let i=this._originStores[a];if(i||(i=new Map,this._originStores[a]=i),i.set(e,t),!this._values.has(e)||this._propertyOriginMap.get(e)<=a){let i=this._values.get(e);return this._values.set(e,t),this._propertyOriginMap.set(e,a),i!==t}return!1}delete(e,t=o.s3.USER){let a=this._originStores[t];if(!a)return;let i=a.get(e);if(a.delete(e),this._values.has(e)&&this._propertyOriginMap.get(e)===t){this._values.delete(e);for(let a=t-1;a>=0;a--){let t=this._originStores[a];if(t&&t.has(e)){this._values.set(e,t.get(e)),this._propertyOriginMap.set(e,a);break}}}return i}has(e,t){let a=void 0===t?this._values:this._originStores[t];return!!a&&a.has(e)}revert(e,t){for(;t>0&&!this.has(e,t);)--t;let a=this._originStores[t],i=a?.get(e),n=this._values.get(e);return this._values.set(e,i),this._propertyOriginMap.set(e,t),n!==i}originOf(e){return this._propertyOriginMap.get(e)||o.s3.DEFAULTS}forEach(e){this._values.forEach(e)}}var h=a(22819),u=a(56529),d=a(64186);let p=e=>{let t=class extends e{constructor(...e){super(...e);let t=(0,u.vw)(this),a=t.store,i=new l;t.store=i,(0,r.M)(t,a,i)}read(e,t){(0,h.i)(this,e,t)}getAtOrigin(e,t){let a=y(this),i=(0,o.M9)(t);if("string"==typeof e)return a.get(e,i);let n={};return e.forEach(e=>{n[e]=a.get(e,i)}),n}originOf(e){return(0,o.x3)(this.originIdOf(e))}originIdOf(e){return y(this).originOf(e)}revert(e,t){let a=y(this),i=(0,o.M9)(t),n=(0,u.vw)(this);("string"==typeof e?"*"===e?a.keys(i):[e]:e).forEach(e=>{n.invalidate(e),a.revert(e,i),n.commit(e)})}};return(0,i._)([(0,d.j)("esri.core.ReadOnlyMultiOriginJSONSupport")],t)};function y(e){return(0,u.vw)(e).store}let g=class extends p(n.Z){};g=(0,i._)([(0,d.j)("esri.core.ReadOnlyMultiOriginJSONSupport")],g);var c=a(15458),f=a(72491);let m=e=>{let t=class extends e{constructor(...e){super(...e)}clear(e,t="user"){return C(this).delete(e,(0,o.M9)(t))}write(e,t){return(0,f.c)(this,e=e||{},t),e}setAtOrigin(e,t,a){(0,u.vw)(this).setAtOrigin(e,t,(0,o.M9)(a))}removeOrigin(e){let t=C(this),a=(0,o.M9)(e);for(let e of t.keys(a))t.originOf(e)===a&&t.set(e,t.get(e,a),o.s3.USER)}updateOrigin(e,t){let a=C(this),i=(0,o.M9)(t),n=(0,c.U2)(this,e);for(let t=i+1;t<o.v8;++t)a.delete(e,t);a.set(e,n,i)}toJSON(e){return this.write({},e)}};return(t=(0,i._)([(0,d.j)("esri.core.MultiOriginJSONSupport.WriteableMultiOriginJSONSupport")],t)).prototype.toJSON.isDefaultToJSON=!0,t};function C(e){return(0,u.vw)(e).store}let L=e=>{let t=class extends m(p(e)){constructor(...e){super(...e)}};return(0,i._)([(0,d.j)("esri.core.MultiOriginJSONSupport")],t)},w=class extends L(n.Z){};w=(0,i._)([(0,d.j)("esri.core.MultiOriginJSONSupport")],w)},57111:function(e,t,a){a.d(t,{C:function(){return i}});let i=["operational-layers","basemap","ground"]},77415:function(e,t,a){a.r(t),a.d(t,{default:function(){return Q}});var i,n,r,s,o,l,h,u,d,p,y,g,c,f,m,C,L,w,b=a(86641);a(55066);var M=a(50973),k=a(94605),E=a(65223),v=a(59528),T=a(31124),_=a(89312);a(37180),a(3457);var D=a(64186),N=a(37109),x=a(83339),R=a(73503);(i=h||(h={})).MULTIPLIER="multiplier",i.ABSOLUTE="absoluteValue";var I=a(74084),S=a(71488),A=a(62327),O=a(14066),P=a(89973),G=a(99547);let Z,z=null;function H(e,t,a,i,n,r){let s=a.length,o=n.length,l=Float64Array.BYTES_PER_ELEMENT,h=Uint32Array.BYTES_PER_ELEMENT,u=Uint8Array.BYTES_PER_ELEMENT,d=z._malloc(16+s*(u+2*l)+2*h*o);try{let u=d+16-d%16,p=u+s*l,y=p+s*l,g=y+o*h,c=g+o*h,f=()=>[z.HEAPF64.subarray(u>>3,(u>>3)+s),z.HEAPF64.subarray(p>>3,(p>>3)+s),z.HEAPU32.subarray(y>>2,(y>>2)+o),z.HEAPU32.subarray(g>>2,(g>>2)+o),z.HEAPU8.subarray(c,c+s)],[m,C,L,w,b]=f();m.set(a),C.set(i),L.set(n),w.set(r),b.set(t);let M=e(s,c,u,p,o,y,g),k=null,E=null;if(M){let e=z.getLayoutLinksTypes(),t=z.getLayoutLinksVerticesEndIndices(),a=z.getLayoutLinksVertices(),i=z.countLayoutLinksVertices();!o||e&&t?i&&!a?M=!1:(k={types:new Uint8Array(z.HEAPU8.subarray(e,e+o)),vertexEndIndex:new Uint32Array(z.HEAPU32.subarray(t>>2,(t>>2)+o)),vertices:new Float64Array(z.HEAPF64.subarray(a>>3,(a>>3)+2*i))},E=z.getAuxiliaryGraphicElements()):M=!1}let[v,T,_,D,N]=f();return a.set(v),i.set(T),n.set(_),r.set(D),t.set(N),{success:M,links:k,graphics:E}}finally{z._free(d),z.cleanupLayout()}}(n=u||(u={}))[n.None=0]="None",n[n.IsMovable=1]="IsMovable",n[n.IsGeographic=2]="IsGeographic",n[n.IsRoot=4]="IsRoot",(r=d||(d={}))[r.Regular=0]="Regular",r[r.Orthogonal=1]="Orthogonal",r[r.Curved=2]="Curved",r[r.Recursive=3]="Recursive",(s=p||(p={})).getMinIdealEdgeLength=function(){return z.getMinIdealEdgeLength()},s.apply=function(e,t,a,i,n,r=2,s=1,o=-1){return H((e,t,a,i,n,l,h)=>z.applyForceDirectedLayout(e,t,a,i,n,l,h,r,s,o),e,t,a,i,n)},(y||(y={})).apply=function(e,t,a,i,n,r=2,s=1,o=-1){return H((e,t,a,i,n,l,h)=>z.applyCommunityLayout(e,t,a,i,n,l,h,r,s,o),e,t,a,i,n)},(g||(g={})).apply=function(e,t,a,i,n){return H(z.applySimpleLayout,e,t,a,i,n)},(c||(c={})).apply=function(e,t,a,i,n){return H(z.applyHierarchicalLayout,e,t,a,i,n)},(f||(f={})).apply=function(e,t,a,i,n){return H(z.applyRadialTreeLayout,e,t,a,i,n)},(m||(m={})).apply=function(e,t,a,i,n){return H(z.applySmartTreeLayout,e,t,a,i,n)},(C||(C={})).apply=function(e,t,a,i,n,r,s,o,l){return H((e,t,a,r,s,h,u)=>{if(i.length!==e||n.length!==e||o.length!==s||l.length!==s)return!1;let d=Float64Array.BYTES_PER_ELEMENT,p=z._malloc(16+e*d),y=z._malloc(16+e*d),g=z._malloc(16+s*d),c=z._malloc(16+s*d),f=p+16-p%16,m=y+16-y%16,C=g+16-g%16,L=c+16-c%16;try{return z.HEAPF64.subarray(f>>3,(f>>3)+e).set(i),z.HEAPF64.subarray(m>>3,(m>>3)+e).set(n),z.HEAPF64.subarray(C>>3,(C>>3)+s).set(o),z.HEAPF64.subarray(L>>3,(L>>3)+s).set(l),z.applyChronologicalLayout(e,t,a,r,f,m,s,h,u,C,L)}finally{z._free(p),z._free(y),z._free(g),z._free(c)}},e,t,a,r,s)},(o=L||(L={}))[o.Undirected=0]="Undirected",o[o.Directed=1]="Directed",o[o.Reversed=2]="Reversed",(l=w||(w={}))[l.ByCC_Raw=0]="ByCC_Raw",l[l.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",l[l.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC";var j=a(26822),U=a(9377),B=a(33876),F=a(58144);let J=class extends(0,O.h7)((0,P.M)(N.Z)){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new M.Z,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new U.Z({xmin:-.0000001,ymin:-.0000001,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new M.Z,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new k.Z("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){let e=this.url.split("/");this.title=e[e.length-2]}let t=new Set,a=[],i=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new k.Z("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach(e=>{e.name&&this._graphTypeLookup.set(e.name,e)}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(e=>{e.name&&this._graphTypeLookup.set(e.name,e)}),e.inclusionModeDefinition?.generateAllSublayers?(a=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,r)=>{let s=this._graphTypeLookup.get(r);if(!s)return E.Z.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(r);"relationship"===s.type?t.has(r)||(t.add(r),i.push(s)):"entity"===s.type?t.has(r)||(t.add(r),a.push(s)):(E.Z.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(r))}):(a=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]);let n=new I.Qc({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=a,this.memberRelationshipTypes=i,this.dataManager=n}load(e){return this.addResolvingPromise(new Promise(t=>{(0,j.fetchKnowledgeGraph)(this.url).then(a=>{if(this._initializeLayerProperties({knowledgeGraph:a,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})})),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(e=>{e.useAllData=!1,e.members?.forEach(e=>{let t;(t=e.linkChartLocation instanceof R.Z?e.linkChartLocation:e.linkChartLocation?x.GH(e.linkChartLocation):null)&&2===t.coords.length&&0===t.lengths.length?this.entityLinkChartDiagramLookup.set(e.id,t):this.relationshipLinkChartDiagramLookup.set(e.id,t)}),this.addResolvingPromise(this._initializeDiagram().then(async()=>{this.layers.forEach(async e=>{await e.refreshCachedQueryEngine()}),this.tables.forEach(async e=>{await e.refreshCachedQueryEngine()})}))});else{let t="GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,t,!0).then(async()=>{(0,T.k_)(e);let t=[],a=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(e=>{e.useAllData=!1})),await this._initializeDiagram(),this.layers.forEach(e=>{a.push(e.refreshCachedQueryEngine()),t.push(new Promise(t=>{e.on("layerview-create",()=>{t(null)})}))}),this.tables.forEach(e=>{a.push(e.refreshCachedQueryEngine())}),await Promise.all(a)}))}t(null)})})),Promise.resolve(this)}async addRecords(e,t){let a=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(a=await (0,A.bv)(e,this.dataManager.knowledgeGraph));let i=e.concat(a).filter(e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id));await this._handleNewRecords(i)}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:a=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){let i=[];for(let t of e)!1===this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.useAllData&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.members?.has(t.id)&&i.push(t);if(t){let e=new Set,t=[];for(let t of i)if(this.dataManager.nodeConnectionsLookup.has(t.id))for(let a of this.dataManager.nodeConnectionsLookup.get(t.id))e.add(a);for(let a of e)if(this.dataManager.memberIdTypeLookup.has(a))for(let e of this.dataManager.memberIdTypeLookup.get(a))this.dataManager.relationshipTypeNames.has(e)&&t.push({id:a,typeName:e});i=i.concat(t)}for(let e of(this.dataManager.removeFromLayer(i),i))this.sublayerIdsCache.get(e.typeName)?.delete(e.id),this.dataManager.relationshipTypeNames.has(e.typeName)?this.relationshipLinkChartDiagramLookup.delete(e.id):this.entityLinkChartDiagramLookup.delete(e.id);a&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,this._currentLinkChartConfig.layoutOptions);let n=[];return this.layers.forEach(e=>{n.push(e.refreshCachedQueryEngine())}),await Promise.all(n),this._refreshNamedTypes(),i}async expand(e,t){let a=await this.dataManager.getConnectedRecordIds(e,t),i=a.filter(e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id));return await this._handleNewRecords(a),{records:i}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach(e=>{let t=new S.Z({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.memberEntityTypes.forEach(e=>{let t=new S.Z({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e,t)=>{let a=v.s1(this.sublayerIdsCache,t,()=>new Set);e.members?.forEach(e=>{if(a.add(e.id),e.linkChartLocation){if(e.linkChartLocation instanceof R.Z)this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation);else{let a=x.GH(e.linkChartLocation);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation?a:null):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation?a:null)}}})})}async calculateLinkChartLayout(e="RADIAL_TREE",t){let i=[],n=[],r=[];this.dataManager.sublayerCaches.forEach((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach(e=>{i.push({typeName:t,feature:e})}):this.dataManager.relationshipTypeNames.has(t)&&e.forEach(e=>{n.push({typeName:t,feature:e})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;let s=new Map,o=new Map,l=new Map,h=new Map,C=new Uint8Array(i.length),L=new Float64Array(i.length),w=new Float64Array(i.length),b=new Uint32Array(n.length),M=new Uint32Array(n.length),v=[],T=new U.Z({xmin:-.0000001,ymin:-.0000001,xmax:1e-7,ymax:1e-7}),_,D=0,N=0;switch("GEOGRAPHIC"===e?"FORCE_DIRECTED":e){case"FORCE_DIRECTED":_=p.apply;break;case"COMMUNITY":_=y.apply;break;case"HIERARCHICAL":_=c.apply;break;case"RADIAL_TREE":_=f.apply;break;case"SMART_TREE":_=m.apply;break;default:_=g.apply}i.forEach(({typeName:a,feature:i})=>{if(t?.lockedNodeLocations?.has(i.attributes[I.zS])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(a)?C[D]=u.IsGeographic:C[D]=u.None;let n=t.lockedNodeLocations.get(i.attributes[I.zS]);L[D]=n.x,w[D]=n.y}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(a)){C[D]=u.IsGeographic;let e=null,t=i.attributes[this.dataManager.geographicLookup.get(a).name];switch(this.dataManager.geographicLookup.get(a)?.geometryType){case"esriGeometryPoint":L[D]=t?.x,w[D]=t?.y;break;case"esriGeometryPolygon":e=t?.centroid,null!=e?.x&&null!=e?.y?(L[D]=e.x,w[D]=e.y):C[D]=u.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=t?.extent?.center,null!=e?.x&&null!=e?.y?(L[D]=e.x,w[D]=e.y):C[D]=u.IsMovable;break;default:C[D]=u.IsMovable}(null==L[D]||null==w[D]||Number.isNaN(L[D])||Number.isNaN(w[D]))&&(C[D]=u.IsMovable,L[D]=0,w[D]=0)}else C[D]=u.IsMovable,L[D]=0,w[D]=0;h.set(i.attributes[I.zS],D),v[D]={feature:i,typeName:a},D++});let R=!1,S=new Map;n.forEach(e=>{let t=e.feature.attributes[I.WZ],a=e.feature.attributes[I.TD],i=h.get(t),n=h.get(a);if(void 0!==i&&void 0!==n){let s=t+"-"+a,o=S.get(s);o?.has(e.typeName)||(b[N]=i,M[N]=n,void 0===o?S.set(s,new Map([[e.typeName,N]])):o.set(e.typeName,N),N++),r.push(e)}else R=!0,this.relationshipLinkChartDiagramLookup.set(t,null)}),R&&E.Z.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");let A=this._validateLayoutSettings(e,t),O=this._convertLayoutSettingsToCalculationSettings(A);await (Z||(Z=a.e(34618).then(a.bind(a,34618)).then(e=>e.l).then(({default:e})=>e({locateFile:e=>(0,G.V)(`esri/libs/linkchartlayout/${e}`)})).then(e=>{z=e})));let{success:P,links:H}=_(C,L,w,b.subarray(0,N),M.subarray(0,N),O.computationBudgetTime,O.idealEdgeLengthMultiplier,O.repulsionRadiusMultiplier);if(!P)throw new k.Z("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let e=0;e<v.length;e++){if(w[e]>84.9999?w[e]=84.9999:w[e]<-84.9999&&(w[e]=-84.9999),L[e]>179.9999?L[e]=179.9999:L[e]<-179.9999&&(L[e]=-179.9999),v[e].feature.attributes[I.Cn]=new B.Z(L[e],w[e]),s.has(v[e].typeName)){let t=s.get(v[e].typeName);t?.set(v[e].feature.attributes[I.zS],v[e].feature)}else{let t=new Map;t.set(v[e].feature.attributes[I.zS],v[e].feature),s.set(v[e].typeName,t)}l.set(v[e].feature.attributes[I.zS],v[e].feature);let t=(0,x.GH)(v[e].feature.attributes[I.Cn]);this.entityLinkChartDiagramLookup.set(v[e].feature.attributes[I.zS],v[e].feature.attributes[I.Cn]?t:null),v[e].feature.attributes[I.Cn].x<T.xmin&&(T.xmin=v[e].feature.attributes[I.Cn].x),v[e].feature.attributes[I.Cn].x>T.xmax&&(T.xmax=v[e].feature.attributes[I.Cn].x),v[e].feature.attributes[I.Cn].y<T.ymin&&(T.ymin=v[e].feature.attributes[I.Cn].y),v[e].feature.attributes[I.Cn].y>T.ymax&&(T.ymax=v[e].feature.attributes[I.Cn].y)}if(this.linkChartExtent.xmin=T.xmin,this.linkChartExtent.xmax=T.xmax,this.linkChartExtent.ymin=T.ymin,this.linkChartExtent.ymax=T.ymax,!H)throw new k.Z("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");let j=new Map,J=new Map,Q=new Map,V=new Set;for(let e=0;e<r.length;e++){let t=[],a=r[e],i=a.feature.attributes[I.WZ],n=a.feature.attributes[I.TD],s=i+"-"+n,u=S.get(s).get(a.typeName),p=0===u?0:H?.vertexEndIndex[u-1];if(!V.has(u)){if(V.add(u),H.types[u]===d.Recursive){let e=[H.vertices[2*p],H.vertices[2*p+1]],a=[H.vertices[2*(p+1)],H.vertices[2*(p+1)+1]],i=[.5*(e[0]+a[0]),.5*(e[1]+a[1])],n=[i[0]-e[0],i[1]-e[1]],r=[i[0]+n[1],i[1]-n[0]],s=[i[0]-n[1],i[1]+n[0]];t.push(e),t.push(r),t.push(a),t.push(s),t.push(e)}else{if(H.types[u]!==d.Regular){E.Z.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let e=p;e<H.vertexEndIndex[u];e++)t.push([H.vertices[2*e],H.vertices[2*e+1]])}let e=v[h.get(i)]?.feature.attributes[I.Cn],a=v[h.get(n)]?.feature.attributes[I.Cn];t[0][0]===e.x&&t[0][1]===e.y||(t[0]=[e.x,e.y]),t[t.length-1][0]===a.x&&t[t.length-1][1]===a.y||(t[t.length-1]=[a.x,a.y]);for(let e=1;e<t.length-1;e++)t[e][1]>85.5?t[e][1]=85.5:t[e][1]<-85.5&&(t[e][1]=-85.5),t[e][0]>179.9999?t[e][0]=179.9999:t[e][0]<-179.9999&&(t[e][0]=-179.9999);j.has(s)?j.get(s).push(t):j.set(s,[t])}let y=j.get(s);J.has(s)||(J.set(s,new Map),Q.set(s,new Map));let g=J.get(s),c=Q.get(s);g.has(a.typeName)||(g.set(a.typeName,y.shift()),c.set(a.typeName,0));let f=g.get(a.typeName);c.set(a.typeName,c.get(a.typeName)+1);let m=new F.Z({paths:f});if(a.feature.attributes[I.Cn]=m,o.has(a.typeName)){let e=o.get(a.typeName);e?.set(a.feature.attributes[I.zS],a.feature)}else{let e=new Map;e.set(a.feature.attributes[I.zS],a.feature),o.set(a.typeName,e)}l.set(a.feature.attributes[I.zS],a.feature);let C=(0,x.GH)(a.feature.attributes[I.Cn]);this.relationshipLinkChartDiagramLookup.set(a.feature.attributes[I.zS],a.feature.attributes[I.Cn]?C:null)}for(let e of r)e.feature.attributes[I.Fd]=Q.get(e.feature.attributes[I.WZ]+"-"+e.feature.attributes[I.TD])?.get(e.typeName)??null;return this._currentLinkChartConfig={layoutMode:e,layoutOptions:A},{nodes:s,links:o,idMap:l}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){let a=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach(e=>{a.push(e.refreshCachedQueryEngine())}),await Promise.all(a),this._refreshNamedTypes()}getCurrentNodeLocations(){let e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(t=>{t?.members?.forEach(t=>{let a;let i=t.linkChartLocation,n=t.id;i&&(a="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]},e.set(n,new B.Z({x:a.x,y:a.y})))})}),e}async synchronizeInclusionListWithCache(){return new Promise(e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;let a=new Set(Array.from(this.dataManager.sublayerCaches.get(t).keys()));Array.from(e.members.keys()).filter(e=>!a.has(e)).forEach(t=>{e.members?.delete(t)})}}),e()})}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);let t=[];this.layers.forEach(e=>{t.push(e.refreshCachedQueryEngine())}),await Promise.all(t),this._refreshNamedTypes()}async connectEntities(e){let t=[];for(let e of this.dataManager.relationshipTypeNames){let a=this.sublayerIdsCache.get(e);a&&(t=t.concat(Array.from(a.keys())))}let a=await this.dataManager.getAttachedRelationships(e,t);return await this._handleNewRecords(a),{records:a}}async _handleNewRecords(e){let t=[];for(let a of(this.dataManager.addToLayer(e),e))this.sublayerIdsCache.has(a.typeName)||(this.sublayerIdsCache.set(a.typeName,new Set),t.push(a.typeName)),this.sublayerIdsCache.get(a.typeName).add(a.id);for(let e of t){let t=this._graphTypeLookup.get(e);if(t){let a=new S.Z({objectType:t,parentCompositeLayer:this,graphType:t.type,title:e});"entity"===t.type?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e),a.geometryType?this.layers.push(a):this.tables.push(a),this.dataManager.sublayerCaches.set(e,new Map)}}await this.dataManager.refreshCacheContent(e.map(e=>e.id));let a=Object.assign({},this._currentLinkChartConfig.layoutOptions);a.lockedNodeLocations=this.getCurrentNodeLocations(),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,a)}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{e?.members?.forEach(e=>{let a;let i=e.linkChartLocation,n=e.id;if(!i)return;a="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]};let r=x.GH(a);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(n,r):this.entityLinkChartDiagramLookup.set(n,r),this.linkChartExtent.xmin>a.x&&(this.linkChartExtent.xmin=a.x),this.linkChartExtent.xmax<a.x&&(this.linkChartExtent.xmax=a.x),this.linkChartExtent.ymin>a.y&&(this.linkChartExtent.ymin=a.y),this.linkChartExtent.ymax<a.y&&(this.linkChartExtent.ymax=a.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(e=>{let t=this.relationshipLinkChartDiagramLookup.get(e.attributes[I.WZ]),a=this.relationshipLinkChartDiagramLookup.get(e.attributes[I.TD]);if(t&&a){let i=x.GH(new F.Z({paths:[[t.coords[0],t.coords[1]],[a.coords[0],a.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(e.attributes[I.zS],i)}else this.relationshipLinkChartDiagramLookup.set(e.attributes[I.zS],null)})})):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations(),...this.defaultLinkChartConfig.layoutOptions||{}}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(let e of this.layers)e.emit("refresh",{dataChanged:!0});for(let e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateLayoutSettings(e,t){let a=e=>"number"==typeof e&&!isNaN(e),i=new Set(["FORCE_DIRECTED","COMMUNITY","GEOGRAPHIC"]),n={};if(!i.has(e)||!t)return!i.has(e)&&t&&E.Z.getLogger(this).warn("Layout mode options were given for a layout mode that does not utilize them, settings will be ignored"),n;let{computationBudgetTime:r,repulsionRadiusMultiplier:s,idealEdgeLength:o,idealEdgeLengthType:l}=t;a(r)&&r>=1?n.computationBudgetTime=r:void 0!==r&&E.Z.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),a(s)&&s>=1?n.repulsionRadiusMultiplier=s:void 0!==s&&E.Z.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting");let u=void 0!==o||void 0!==l;return"GEOGRAPHIC"!==e&&u?E.Z.getLogger(this).warn("Ideal edge length settings were specified for an incompatible layout mode, and will be ignored"):"GEOGRAPHIC"===e&&u&&(Object.values(h).includes(l)?n.idealEdgeLengthType=l:void 0!==l&&E.Z.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),a(o)&&o>=0?n.idealEdgeLength=o:void 0!==o&&E.Z.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),n}_convertLayoutSettingsToCalculationSettings(e){let t=e.idealEdgeLength;return e.idealEdgeLengthType===h.ABSOLUTE&&(void 0===t?t=-1:t*=-1),{computationBudgetTime:e.computationBudgetTime,repulsionRadiusMultiplier:e.repulsionRadiusMultiplier,idealEdgeLengthMultiplier:t}}};(0,b._)([(0,_.Cb)()],J.prototype,"dataPreloadedInLocalCache",void 0),(0,b._)([(0,_.Cb)()],J.prototype,"defaultLinkChartConfig",void 0),(0,b._)([(0,_.Cb)()],J.prototype,"dataManager",void 0),(0,b._)([(0,_.Cb)()],J.prototype,"knowledgeGraph",void 0),(0,b._)([(0,_.Cb)()],J.prototype,"layers",void 0),(0,b._)([(0,_.Cb)()],J.prototype,"entityLinkChartDiagramLookup",void 0),(0,b._)([(0,_.Cb)()],J.prototype,"relationshipLinkChartDiagramLookup",void 0),(0,b._)([(0,_.Cb)()],J.prototype,"linkChartExtent",void 0),(0,b._)([(0,_.Cb)()],J.prototype,"memberEntityTypes",void 0),(0,b._)([(0,_.Cb)()],J.prototype,"memberRelationshipTypes",void 0),(0,b._)([(0,_.Cb)()],J.prototype,"sublayerIdsCache",void 0),(0,b._)([(0,_.Cb)()],J.prototype,"tables",void 0),(0,b._)([(0,_.Cb)({json:{read:!1}})],J.prototype,"type",void 0);let Q=J=(0,b._)([(0,D.j)("esri.layers.LinkChartLayer")],J)},78298:function(e,t,a){a.d(t,{C_:function(){return u},HQ:function(){return p},Lx:function(){return c},Oh:function(){return m},PV:function(){return g},YI:function(){return h},bT:function(){return C},iR:function(){return d},id:function(){return w},rO:function(){return b},rT:function(){return k},rn:function(){return y},u1:function(){return M},vg:function(){return L}});var i=a(57111),n=a(9377),r=a(36502),s=a(37144),o=a(81961),l=a(60536);let h={type:Boolean,value:!0,json:{origins:{service:{read:!1,write:!1},"web-map":{read:!1,write:!1}},name:"screenSizePerspective",write:{enabled:!0,layerContainerTypes:i.C}}},u={type:Boolean,value:!0,json:{name:"disablePopup",read:{reader:(e,t)=>!t.disablePopup},write:{enabled:!0,writer(e,t,a){t[a]=!e}}}},d={type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",write:{enabled:!0,layerContainerTypes:i.C}}},p={type:String,json:{origins:{"portal-item":{write:!1}},write:{isRequired:!0,ignoreOrigin:!0,writer:s.w}}},y={type:Boolean,value:!0,nonNullable:!0,json:{origins:{service:{read:{enabled:!1}}},name:"showLegend",write:{enabled:!0,layerContainerTypes:i.C}}},g={value:null,type:o.Z,json:{origins:{service:{name:"elevationInfo",write:!0}},name:"layerDefinition.elevationInfo",write:{enabled:!0,layerContainerTypes:i.C}}};function c(e){return{type:e,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}}}let f={write:{enabled:!0,layerContainerTypes:i.C},read:!0},m={type:Number,json:{origins:{"web-document":f,"portal-item":{write:!0}}}},C={...m,json:{...m.json,origins:{"web-document":{...f,write:{enabled:!0,layerContainerTypes:i.C,target:{opacity:{type:Number},"layerDefinition.drawingInfo.transparency":{type:Number}}}}},read:{source:["layerDefinition.drawingInfo.transparency","drawingInfo.transparency"],reader:(e,t,a)=>a&&"service"!==a.origin||!t.drawingInfo||void 0===t.drawingInfo.transparency?t.layerDefinition?.drawingInfo&&void 0!==t.layerDefinition.drawingInfo.transparency?(0,l.b)(t.layerDefinition.drawingInfo.transparency):void 0:(0,l.b)(t.drawingInfo.transparency)}}},L={type:n.Z,readOnly:!0,json:{origins:{service:{read:{source:["fullExtent","spatialReference"],reader:(e,t)=>{let a=n.Z.fromJSON(e);return null!=t.spatialReference&&"object"==typeof t.spatialReference&&(a.spatialReference=r.Z.fromJSON(t.spatialReference)),a}}}},read:!1}},w={type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}}}},b={type:Number,json:{origins:{service:{write:{enabled:!1}},"web-scene":{name:"layerDefinition.minScale",write:{enabled:!0,layerContainerTypes:i.C}}},name:"layerDefinition.minScale",write:!0}},M={type:Number,json:{origins:{service:{write:{enabled:!1}},"web-scene":{name:"layerDefinition.maxScale",write:{enabled:!0,layerContainerTypes:i.C}}},name:"layerDefinition.maxScale",write:!0}},k={json:{write:{ignoreOrigin:!0,layerContainerTypes:i.C},origins:{"web-map":{read:!1,write:!1}}}}}}]);